<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>不動產要約定金收據簽署系統</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
  <!-- 引入 PDF 產生套件 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
    body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
    
    /* 預覽頁面表格樣式 - 手機版優化 */
    .receipt-table { border-collapse: collapse; width: 100%; border: 2.5px solid #000; }
    .receipt-table th, .receipt-table td { border: 1.5px solid #000; padding: 12px; vertical-align: middle; }
    .receipt-table th { background-color: #f8fafc; font-weight: 900; width: 130px; color: #000; font-size: 1.1rem; text-align: center; }

    /* 手機版表格微調 (螢幕小於 768px 時觸發) */
    @media (max-width: 768px) {
        .receipt-table th, .receipt-table td { padding: 8px 4px; font-size: 0.95rem; }
        .receipt-table th { width: 90px; font-size: 1rem; }
    }
    
    /* PDF 專用樣式 (保持原樣，確保列印品質) */
    .pdf-table th, .pdf-table td { 
        vertical-align: middle !important; 
        padding: 15px 20px !important; 
        line-height: 1.4 !important;
    }
    
    .big-btn { transition: all 0.2s; cursor: pointer; }
    .big-btn:active { transform: scale(0.96); opacity: 0.9; }
    
    /* 簽名板高度在手機上稍微縮小，避免佔據太多空間 */
    #signature-pad { background: #ffffff; border: 3px dashed #3b82f6; border-radius: 20px; width: 100%; height: 250px; touch-action: none; }
    @media (min-width: 768px) {
        #signature-pad { height: 320px; }
    }

    #loader { background: rgba(255, 255, 255, 0.98); z-index: 100; }
    .debug-box { background: #1a1a1a; color: #00ff00; padding: 15px; border-radius: 12px; font-size: 14px; margin-top: 20px; text-align: left; overflow-x: auto; display: none; border: 2px solid #333; max-height: 300px; overflow-y: auto; }
    .grandpa-input:focus { border-color: #2563eb; box-shadow: 0 0 0 10px rgba(37, 99, 235, 0.1); background-color: #fff; }

    #pdf-export-area { width: 850px; padding: 40px; background: white; position: absolute; left: -9999px; top: 0; }
    .pdf-title { font-size: 36px; font-weight: 900; text-align: center; margin-bottom: 25px; color: #000; }
    .pdf-header-info { text-align: right; font-size: 18px; margin-bottom: 12px; font-weight: bold; }

    /* 水印專用樣式 */
    .watermark-bg { position: relative; z-index: 0; }
    .watermark-bg::before {
      content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background-image: url('https://raw.githubusercontent.com/wuohome/ragic/refs/heads/main/logooo.png');
      background-position: center center; background-repeat: no-repeat; background-size: 300px auto; 
      opacity: 0.15; pointer-events: none; z-index: -1;
    }
    @media (min-width: 768px) {
        .watermark-bg::before { background-size: 500px auto; }
    }
    .watermark-bg > * { position: relative; z-index: 1; }
  </style>
</head>

<body class="bg-slate-100 min-h-screen">

  <div id="loader" class="fixed inset-0 flex flex-col items-center justify-center p-6 text-center">
    <div id="loader-spinner" class="animate-spin rounded-full h-16 w-16 md:h-20 md:w-20 border-t-4 border-b-4 border-blue-600 mb-6"></div>
    <p id="loader-text" class="text-xl md:text-3xl font-black text-slate-800">正在讀取 Ragic 資料...</p>

    <div id="test-mode-ui" class="hidden mt-8 bg-white p-6 md:p-10 rounded-3xl md:rounded-[3rem] shadow-2xl max-w-sm w-full border-4 border-blue-500">
      <h2 class="text-2xl md:text-3xl font-black text-blue-600 mb-4 md:mb-6 text-center">測試模式</h2>
      <p class="text-slate-500 mb-3 md:mb-4 text-lg md:text-xl font-medium text-left">請輸入正確的 Record ID：</p>
      <input type="number" id="test-id-input" placeholder="3"
        class="w-full text-center text-4xl md:text-6xl p-4 md:p-6 border-4 border-slate-200 rounded-2xl md:rounded-3xl mb-6 md:mb-8 outline-none font-bold bg-slate-50">
      <button id="btn-test" class="w-full bg-blue-600 text-white font-black py-4 md:py-7 rounded-2xl md:rounded-3xl text-xl md:text-3xl shadow-xl big-btn">
        開始載入
      </button>
    </div>

    <div id="debug-area" class="debug-box w-full max-w-lg">
      <p class="text-white font-bold mb-2">【系統診斷】</p>
      <div id="debug-content" class="font-mono whitespace-pre-wrap">等待連線中...</div>
    </div>

    <button id="retry-btn" onclick="location.reload()" class="hidden mt-8 bg-slate-800 text-white px-8 md:px-10 py-3 md:py-4 rounded-xl md:rounded-2xl font-black text-lg md:text-xl">
      重新載入
    </button>
  </div>

  <!-- 隱藏 iframe 用於接收表單提交 -->
  <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;"></iframe>

  <div class="max-w-4xl mx-auto p-3 md:p-8">
    
    <!-- 第一步：核對資料 -->
    <div id="step-1" class="hidden bg-white rounded-3xl md:rounded-[3rem] shadow-2xl p-5 md:p-14 border-t-[10px] md:border-t-[16px] border-blue-600">
      <h1 class="text-2xl md:text-5xl font-black text-blue-700 mb-3 md:mb-6 text-center md:text-left">請核對房客資料</h1>
      <p class="text-slate-500 mb-6 md:mb-12 text-base md:text-2xl font-medium text-center md:text-left">房客您好，資料若有誤可直接修改。</p>
      
      <!-- 
        表單設定：
        1. target="hidden_iframe" -> 避免頁面跳轉
        2. enctype="multipart/form-data" -> 支援檔案上傳 (PDF)
      -->
      <form id="ragicForm" method="POST" target="hidden_iframe" accept-charset="UTF-8" enctype="multipart/form-data" class="space-y-6 md:space-y-10">
        <div>
          <label class="block text-lg md:text-3xl font-black text-slate-700 mb-2 md:mb-4">房客姓名</label>
          <!-- 寫入 ID：1000792 -->
          <input type="text" name="1000792" id="input_name" class="grandpa-input w-full text-xl md:text-4xl border-[3px] md:border-4 border-slate-200 rounded-2xl md:rounded-3xl p-3 md:p-6 outline-none font-bold bg-yellow-50 shadow-inner">
        </div>
        <div>
          <label class="block text-lg md:text-3xl font-black text-slate-700 mb-2 md:mb-4">聯絡電話</label>
          <!-- 寫入 ID：1000808 -->
          <input type="tel" name="1000808" id="input_phone" class="grandpa-input w-full text-xl md:text-4xl border-[3px] md:border-4 border-slate-200 rounded-2xl md:rounded-3xl p-3 md:p-6 outline-none font-bold">
        </div>
        <div>
          <label class="block text-lg md:text-3xl font-black text-slate-700 mb-2 md:mb-4">房客職業</label>
          <!-- 寫入 ID：1000837 -->
          <input type="text" name="1000837" id="input_occ" class="grandpa-input w-full text-xl md:text-4xl border-[3px] md:border-4 border-slate-200 rounded-2xl md:rounded-3xl p-3 md:p-6 outline-none font-bold">
        </div>
        
        <!-- 簽名欄位 (Hidden) 寫入 ID：1000816 (Base64字串) -->
        <input type="hidden" name="1000816" id="hidden_signature">

        <!-- 【新增】PDF 自動上傳欄位 (Hidden File Input) 寫入 ID：1001709 -->
        <input type="file" name="1001709" id="hidden_pdf_input" style="display:none;">
      </form>
      
      <button id="btn-next" class="big-btn w-full mt-8 md:mt-14 bg-blue-600 hover:bg-blue-700 text-white text-xl md:text-4xl font-black py-4 md:py-9 rounded-2xl md:rounded-[2.5rem] shadow-2xl">資料正確，下一頁 👉</button>
      
      <!-- 診斷按鈕 -->
      <div class="mt-6 md:mt-8 text-center">
        <button onclick="showFieldIds()" class="text-slate-300 text-xs md:text-sm underline">顯示所有欄位 ID (除錯用)</button>
      </div>
    </div>

    <!-- 第二步：預覽收據 -->
    <div id="step-2" class="hidden bg-white rounded-3xl md:rounded-[3rem] shadow-2xl p-4 md:p-10 border-t-[10px] md:border-t-[16px] border-green-600">
      <div id="receipt-preview-container" class="watermark-bg">
        <div class="text-right mb-2 md:mb-4 font-bold text-lg md:text-2xl">編號：<span id="show_no">-</span></div>
        <h1 class="text-2xl md:text-4xl font-black text-center mb-5 md:mb-8 text-slate-900">不動產要約定金收據</h1>
        
        <table class="receipt-table mb-6 md:mb-8 text-base md:text-lg">
          <tr>
            <th>房屋地址</th>
            <td colspan="3" id="show_addr" class="font-bold break-all">-</td>
          </tr>
          <tr>
            <th>租 金</th>
            <td id="show_rent" class="font-black text-xl md:text-2xl">-</td>
            <td colspan="2" class="font-bold">稅金：<span id="show_tax">-</span></td>
          </tr>
          <tr>
            <th>押 金</th>
            <td id="show_deposit" class="font-bold text-xl md:text-2xl">-</td>
            <td colspan="2" class="font-bold align-middle">
                管理費：<span id="show_mgmt">-</span><br>
                <span class="text-xs md:text-sm text-slate-500 font-normal">※實際金額依管委會規定繳納</span>
            </td>
          </tr>
          <tr>
            <th>租 期</th>
            <td colspan="3" id="show_period" class="font-bold">-</td>
          </tr>
          <tr>
            <th>車 位</th>
            <td colspan="3" id="show_parking" class="font-bold">-</td>
          </tr>
          <tr>
            <th>付款方式</th>
            <td colspan="3" id="show_pay_method" class="font-bold">-</td>
          </tr>
          <tr>
            <th>要約條件</th>
            <td colspan="3" id="show_cond" class="text-sm md:text-base h-24 md:h-40 align-top leading-relaxed overflow-y-auto">-</td>
          </tr>
          <tr>
            <th rowspan="2">要約定金</th>
            <td rowspan="2" id="show_earnest" class="text-red-600 font-black text-xl md:text-3xl">-</td>
            <th style="width: 80px;">簽約</th>
            <td id="show_sign_date" class="font-bold text-sm md:text-base">-</td>
          </tr>
          <tr>
            <th style="width: 80px;">起租</th>
            <td id="show_start_date" class="font-bold text-sm md:text-base">-</td>
          </tr>
          <tr>
            <th>付款方式</th>
            <td colspan="3" class="font-bold break-all">
                <span id="show_remit_method">-</span> <span id="show_remit_label">後五碼：</span><span id="show_remit_code">-</span>
            </td>
          </tr>
        </table>

        <div class="bg-slate-100 p-3 md:p-4 rounded-xl text-sm md:text-lg font-bold text-center mb-6 md:mb-10 border-2 border-dashed border-slate-300 flex flex-col justify-center items-center h-20 md:h-24">
            簽約請攜帶：定金收據、押租金、服務費尾款、印章、雙證件影本3份。
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8 px-2 md:px-6 mb-8 md:mb-12 border-b-2 pb-6 md:pb-10">
            <div class="space-y-2 md:space-y-4">
                <p class="text-lg md:text-2xl font-bold">房客（簽名）：<span id="show_final_name" class="underline px-2 md:px-4">-</span></p>
                <!-- 這裡會顯示 Step 1 修改後的電話 -->
                <p class="text-base md:text-xl">電話：<span id="show_final_phone">-</span></p>
                <p class="text-base md:text-xl">職業：<span id="show_final_occ">-</span></p>
            </div>
            <div class="text-left md:text-right space-y-2 md:space-y-4 mt-4 md:mt-0">
                <p class="text-xs md:text-sm font-bold text-slate-500">優式租售管理 - 窩的家三重加盟店</p>
                <p class="text-lg md:text-2xl font-bold">經辦人員：<span id="show_agent">-</span></p>
                <p class="text-base md:text-xl">電話：<span id="show_agent_phone">-</span></p>
            </div>
        </div>
      </div>

      <div class="mb-8 md:mb-12">
          <p class="font-black text-xl md:text-2xl mb-2 md:mb-4 text-slate-800">重要約定：</p>
          <ul class="text-sm md:text-base space-y-2 text-slate-700 list-none">
              <li>壹、上述條件由房客確認無誤，付定金後成立要約。</li>
              <li>貳、如房東不同意上述條件，則定金無息全額退還於房客。</li>
              <li>參、如房東同意上述條件，但因另有考量因素導致無法簽約，則定金無息全數退還於房客，不需支付額外費用。</li>
              <li>肆、如房東同意上述條件，但房客因故反悔不租或超過簽約日仍不辦理簽約者，定金不予退還。</li>
              <li>伍、要約成立(包含溝通調整後東客合意之條件)並簽約完成，房客需支付窩的家房屋租售有限公司簽約金額 <span id="show_service_fee" class="font-bold underline text-blue-700">-</span> 作為服務費。</li>
          </ul>
      </div>

      <div class="mb-6 md:mb-10 text-center">
        <label class="block text-2xl md:text-4xl font-black text-slate-800 mb-6 md:mb-10 underline decoration-blue-500 decoration-4 md:decoration-8 underline-offset-[8px] md:underline-offset-[16px]">房客簽名處</label>
        <div class="relative">
            <canvas id="signature-pad"></canvas>
            <button id="btn-clear" class="absolute top-2 right-2 md:top-4 md:right-4 bg-slate-100 text-slate-600 px-4 md:px-8 py-2 md:py-4 rounded-lg md:rounded-xl font-black text-xs md:text-sm shadow border border-slate-300">清除重寫</button>
        </div>
      </div>

      <div class="flex flex-col md:flex-row gap-4 md:gap-6 mt-8 md:mt-12">
        <button id="btn-back" class="order-2 md:order-1 flex-1 bg-slate-200 text-slate-500 text-xl md:text-3xl font-black py-4 md:py-7 rounded-2xl md:rounded-3xl">回上一步</button>
        <button id="btn-submit" class="order-1 md:order-2 big-btn flex-[2] bg-emerald-600 hover:bg-emerald-700 text-white text-xl md:text-4xl font-black py-4 md:py-7 rounded-2xl md:rounded-3xl shadow-2xl">簽好了，送出 ✅</button>
      </div>
    </div>

    <!-- 第三步：成功 -->
    <div id="step-success" class="hidden bg-white rounded-3xl md:rounded-[3rem] shadow-2xl p-8 md:p-20 text-center border-t-[10px] md:border-t-[16px] border-emerald-500">
      <div class="text-6xl md:text-[120px] mb-6 md:mb-8">✅</div>
      <h1 class="text-3xl md:text-6xl font-black text-emerald-600 mb-4 md:mb-6">簽署完成！</h1>
      <p class="text-slate-500 text-lg md:text-2xl mb-8 md:mb-12">收據已傳回系統存檔。<br>PDF 也已自動上傳歸檔。</p>
      
      <button onclick="downloadReceiptPDF()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-black py-5 md:py-9 rounded-2xl md:rounded-[2.5rem] text-xl md:text-4xl shadow-xl big-btn flex items-center justify-center gap-2 md:gap-4 mb-4 md:mb-8">
        📥 下載備份 PDF
      </button>
      <p class="text-slate-400 text-sm md:text-xl italic font-medium">※ 下載後請至手機的「檔案」或「下載管理」查看</p>
    </div>
  </div>

  <!-- PDF 生成區域 (隱藏) -->
  <div id="pdf-export-area" style="position: relative; background: white;">
      <img id="pdf-watermark-img"
           src="https://raw.githubusercontent.com/wuohome/ragic/refs/heads/main/logooo.png" 
           crossorigin="anonymous"
           style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 500px; opacity: 0.15; z-index: 0; pointer-events: none;">

      <div style="position: relative; z-index: 1;">
          <div class="pdf-header-info">編號：<span id="pdf_no">-</span></div>
          <div class="pdf-title">不動產要約定金收據</div>
          
          <table class="receipt-table pdf-table" style="font-size: 19px; line-height: 1.5;">
              <tr>
                  <th style="height: 65px; vertical-align: middle;">房屋地址</th>
                  <td colspan="3" id="pdf_addr" style="padding-left: 20px; font-weight: bold; vertical-align: middle;">-</td>
              </tr>
              <tr>
                <th style="height: 65px; vertical-align: middle;">租 金</th>
                <td id="pdf_rent" style="font-weight: 900; font-size: 26px; vertical-align: middle;">-</td>
                <td colspan="2" style="padding-left: 20px; font-weight: bold; vertical-align: middle;">稅金：<span id="pdf_tax">-</span></td>
              </tr>
              <tr>
                <th style="height: 85px; vertical-align: middle;">押 金</th>
                <td id="pdf_deposit" style="font-weight: bold; font-size: 24px; vertical-align: middle;">-</td>
                <td colspan="2" style="padding-left: 20px; font-weight: bold; vertical-align: middle;">
                    管理費：<span id="pdf_mgmt">-</span><br>
                    <span style="font-size: 13px; color: #333; font-weight: normal;">※實際金額依管委會規定繳納</span>
                </td>
              </tr>
              <tr>
                <th style="height: 65px; vertical-align: middle;">租 期</th>
                <td colspan="3" id="pdf_period" style="padding-left: 20px; font-weight: bold; vertical-align: middle;">-</td>
              </tr>
              <tr>
                <th style="height: 65px; vertical-align: middle;">車 位</th>
                <td colspan="3" id="pdf_parking" style="padding-left: 20px; font-weight: bold; vertical-align: middle;">-</td>
              </tr>
              <tr>
                <th style="height: 65px; vertical-align: middle;">付款方式</th>
                <td colspan="3" id="pdf_pay_method" style="padding-left: 20px; font-weight: bold; vertical-align: middle;">-</td>
              </tr>
              <tr>
                <th style="height: 160px; vertical-align: middle;">要約條件</th>
                <td colspan="3" id="pdf_cond" style="padding: 20px; vertical-align: top !important; font-size: 17px; line-height: 1.8;">-</td>
              </tr>
              <tr>
                <th rowspan="2" style="height: 80px; vertical-align: middle;">要約定金</th>
                <td rowspan="2" id="pdf_earnest" style="font-weight: 900; font-size: 30px; color: #d00; vertical-align: middle;">-</td>
                <th style="width: 80px; vertical-align: middle;">簽約</th>
                <td id="pdf_sign_date" style="text-align: center; font-weight: bold; vertical-align: middle;">-</td>
              </tr>
              <tr>
                <th style="width: 80px; vertical-align: middle;">起租</th>
                <td id="pdf_start_date" style="text-align: center; font-weight: bold; vertical-align: middle;">-</td>
              </tr>
              <tr>
                <th style="height: 65px; vertical-align: middle;">付款方式</th>
                <td colspan="3" style="font-weight: bold; padding-left: 20px; vertical-align: middle;">
                    <span id="pdf_remit_method">-</span> <span id="pdf_remit_label">後五碼：</span><span id="pdf_remit_code">-</span>
                </td>
              </tr>
          </table>
          
          <div style="background-color: #f1f5f9; border: 2px dashed #cbd5e1; border-radius: 12px; margin: 20px 0; display: table; width: 100%; height: 90px;">
              <div style="display: table-cell; vertical-align: middle; text-align: center; color: #334155; font-size: 18px; font-weight: bold;">
                簽約請攜帶：定金收據、押租金、服務費尾款、印章、雙證件影本3份。
              </div>
          </div>
          
          <div style="margin-top: 40px; padding-top: 25px;">
              <p style="font-weight: 900; font-size: 22px; margin-bottom: 15px;">重要約定：</p>
              <ul style="font-size: 12px; line-height: 1.6; list-style: none; padding: 0; margin: 0;">
                  <li style="margin-bottom: 5px;">壹、上述條件由房客確認無誤，付定金後成立要約。</li>
                  <li style="margin-bottom: 5px;">貳、如房東不同意上述條件，則定金無息全額退還於房客。</li>
                  <li style="margin-bottom: 5px;">參、如房東同意上述條件，但因另有考量因素導致無法簽約，則定金無息全數退還於房客，不需支付額外費用。</li>
                  <li style="margin-bottom: 5px;">肆、如房東同意上述條件，但房客因故反悔不租或超過簽約日仍不辦理簽約者，定金不予退還。</li>
                  <li>伍、要約成立(包含溝通調整後東客合意之條件)並簽約完成，房客需支付窩的家房屋租售有限公司簽約金額 <span id="pdf_service_fee" style="font-weight: bold; text-decoration: underline;">-</span> 作為服務費。</li>
              </ul>
          </div>

          <div style="display: flex; justify-content: space-between; margin-top: 50px; padding: 0 10px; border-top: 3px solid #000; padding-top: 30px;">
              <div style="width: 55%;">
                  <p style="font-size: 24px; font-weight: bold; margin-bottom: 35px;">房客（簽名）：<img id="pdf_signature_img" style="display: inline-block; vertical-align: middle; max-height: 90px;"></p>
                  <p style="font-size: 18px;">電話：<span id="pdf_phone">-</span></p>
                  <p style="font-size: 18px;">職業：<span id="pdf_occ">-</span></p>
              </div>
              <div style="text-align: right; width: 45%;">
                  <p style="font-size: 14px; font-weight: bold; color: #555; margin-bottom: 5px;">優式租售管理 - 窩的家三重加盟店</p>
                  <p style="font-size: 24px; font-weight: bold; margin-bottom: 35px;">經辦人員：<span id="pdf_agent">-</span></p>
                  <p style="font-size: 18px;">電話：<span id="pdf_agent_phone">-</span></p>
              </div>
          </div>
      </div>
  </div>

  <script>
    // 安全改造：前端不再保存 API Key，改由後端代理處理授權。
    const API_PROXY_BASE = "/api/ragic";
    const RAGIC_FORM_PATH = "payments/1";

    const FIELDS = {
      // Step 2 顯示用欄位
      no: ["1000796", "定金單編號"],
      addr: ["1000799", "地址"],
      rent: ["1000818", "租金"],
      tax: ["1000821", "租金內含稅金"],
      deposit: ["1000819", "押金"],
      mgmt: ["1000822", "租金內含管理費"],
      period: ["1000824", "租期"],
      parking_type: ["1000826", "車位類型"],
      parking_pre: ["1000828", "車位區域"],
      parking_num: ["1000829", "車位編號"],
      pay_method: ["1000830", "付款方式"],
      conditions: ["1000831", "要約條件"],
      earnest: ["1000832", "要約定金"],
      sign_date: ["1000833", "簽約日"],
      start_date: ["1000834", "起租日"],
      remit_method: ["1000835", "付款方式2"],
      remit_code: ["1000836", "匯款後五碼"],
      agent: ["1000793", "經辦人員"],
      agent_phone: ["1000838", "經辦電話"],
      service_fee: ["1000839", "服務費"],
      
      // 【修正】：讀取來源設定
      cust_name: ["1000792", "1001091", "租客姓名"],   
      cust_phone: ["1000808", "租客電話"], 
      cust_occ: ["1000837", "租客職業"],
      
      signature: "1000816",
      pdf_upload: "1001709" // 新增 PDF 欄位 ID
    };

    let currentRecord = null;
    let recordId = null;
    let signaturePad = null;
    let loadTimer = null;

    const $ = (id) => document.getElementById(id);

    // 解析 URL
    const href = window.location.href;
    const matchCode = href.match(/[?&]code=([^&#]+)/i);
    const matchId = href.match(/[?&]id=([^&#]+)/i);
    if (matchCode) recordId = matchCode[1];
    else if (matchId) recordId = matchId[1];
    else {
        const urlParams = new URLSearchParams(window.location.search);
        recordId = urlParams.get('code') || urlParams.get('id');
    }
    if (recordId) recordId = recordId.trim();

    function getValue(rec, keys) {
      if (!Array.isArray(keys)) keys = [keys];
      for (let k of keys) { if (rec[k] !== undefined && rec[k] !== null && rec[k] !== "") return rec[k]; }
      return "";
    }

    function formatCurrency(val) {
        if (!val) return "$ 0";
        const digits = String(val).replace(/[^\d]/g, "");
        return "$ " + Number(digits).toLocaleString("zh-TW");
    }

    function parseBBCode(text) {
        if (!text) return "無";
        return text
            .replace(/\[ul(=.*?)?\]/gi, "<ul style='list-style-type: disc; padding-left: 1.5em; margin: 0.5em 0;'>")
            .replace(/\[\/ul\]/gi, "</ul>")
            .replace(/\[ol(=.*?)?\]/gi, "<ol style='list-style-type: decimal; padding-left: 1.5em; margin: 0.5em 0;'>")
            .replace(/\[\/ol\]/gi, "</ol>")
            .replace(/\[li\]/gi, "<li>")
            .replace(/\[\/li\]/gi, "</li>")
            .replace(/\[b\](.*?)\[\/b\]/gi, "<strong>$1</strong>")
            .replace(/\[i\](.*?)\[\/i\]/gi, "<em>$1</em>")
            .replace(/\[u\](.*?)\[\/u\]/gi, "<u>$1</u>")
            .replace(/\[s\](.*?)\[\/s\]/gi, "<s>$1</s>")
            .replace(/\[color=(.*?)\](.*?)\[\/color\]/gi, "<span style='color:$1'>$2</span>")
            .replace(/\[br\]\[\/br\]/gi, "<br>")
            .replace(/\[br\]/gi, "<br>")
            .replace(/\n/g, "<br>");
    }

    function findExactRecord(data, targetId) {
      if (!data || typeof data !== 'object') return null;
      if (isMatch(data, targetId)) return data;
      if (data[targetId] && typeof data[targetId] === 'object') return data[targetId];
      for (const k in data) {
        const row = data[k];
        if (typeof row === 'object' && row !== null) {
          if (isMatch(row, targetId)) return row;
        }
      }
      return null;
    }

    function isMatch(row, targetId) {
      if (row["_ragicId"] == targetId) return true;
      if (row["Record ID"] == targetId) return true;
      let recNo = row["1000796"] || row["定金單編號"];
      if (recNo && recNo == targetId) return true;
      return false;
    }

    window.ragicCallback = function (data) {
      clearTimeout(loadTimer);
      currentRecord = findExactRecord(data, recordId);
      
      if (!currentRecord) {
        $("loader-text").innerText = "找不到編號 " + recordId + " 的資料";
        return;
      }
      
      if (currentRecord["_ragicId"]) {
          recordId = currentRecord["_ragicId"];
      }
      
      renderData();
      $("loader").classList.add('hidden');
      $("step-1").classList.remove('hidden');
    };

    function executeLoad() {
      $("loader-text").innerText = "開啟中...";
      loadTimer = setTimeout(() => { if (!currentRecord) $("loader-text").innerText = "讀取逾時"; }, 10000);
      fetch(`${API_PROXY_BASE}/${RAGIC_FORM_PATH}/${recordId}`)
        .then(resp => { if (!resp.ok) throw new Error(`HTTP ${resp.status}`); return resp.json(); })
        .then(data => window.ragicCallback(data))
        .catch((err) => {
          clearTimeout(loadTimer);
          console.error(err);
          $("loader-text").innerText = "讀取失敗，請聯絡管理員檢查後端代理";
        });
    }

    function renderData() {
      if($("input_name")) $("input_name").value = getValue(currentRecord, FIELDS.cust_name);
      if($("input_phone")) $("input_phone").value = getValue(currentRecord, FIELDS.cust_phone);
      if($("input_occ")) $("input_occ").value = getValue(currentRecord, FIELDS.cust_occ);

      const pType = getValue(currentRecord, FIELDS.parking_type);
      const pPre = getValue(currentRecord, FIELDS.parking_pre);
      const pNum = getValue(currentRecord, FIELDS.parking_num);
      const parkingFull = pType ? `${pType}${pPre ? '，' + pPre : ''}${pNum ? ' ' + pNum : ''}` : "無車位";

      const mapping = [
          { s: "show_no", p: "pdf_no", v: getValue(currentRecord, FIELDS.no) },
          { s: "show_addr", p: "pdf_addr", v: getValue(currentRecord, FIELDS.addr) },
          { s: "show_tax", p: "pdf_tax", v: getValue(currentRecord, FIELDS.tax) || "內含稅金" },
          { s: "show_rent", p: "pdf_rent", v: formatCurrency(getValue(currentRecord, FIELDS.rent)) },
          { s: "show_deposit", p: "pdf_deposit", v: formatCurrency(getValue(currentRecord, FIELDS.deposit)) },
          { s: "show_mgmt", p: "pdf_mgmt", v: getValue(currentRecord, FIELDS.mgmt) || "無管理費" },
          { s: "show_period", p: "pdf_period", v: getValue(currentRecord, FIELDS.period) || "一年" },
          { s: "show_parking", p: "pdf_parking", v: parkingFull },
          { s: "show_pay_method", p: "pdf_pay_method", v: getValue(currentRecord, FIELDS.pay_method) || "月繳" },
          { s: "show_earnest", p: "pdf_earnest", v: formatCurrency(getValue(currentRecord, FIELDS.earnest)) },
          { s: "show_sign_date", p: "pdf_sign_date", v: getValue(currentRecord, FIELDS.sign_date) },
          { s: "show_start_date", p: "pdf_start_date", v: getValue(currentRecord, FIELDS.start_date) },
          { s: "show_remit_method", p: "pdf_remit_method", v: getValue(currentRecord, FIELDS.remit_method) || "現金" },
          { s: "show_agent", p: "pdf_agent", v: getValue(currentRecord, FIELDS.agent) },
          { s: "show_agent_phone", p: "pdf_agent_phone", v: getValue(currentRecord, FIELDS.agent_phone) },
          { s: "show_service_fee", p: "pdf_service_fee", v: formatCurrency(getValue(currentRecord, FIELDS.service_fee)) }
      ];

      mapping.forEach(m => { 
        if(m.s && $(m.s)) $(m.s).innerText = m.v;
        if(m.p && $(m.p)) $(m.p).innerText = m.v;
      });
      
      const rawCond = getValue(currentRecord, FIELDS.conditions);
      const cond = parseBBCode(rawCond);
      if($("show_cond")) $("show_cond").innerHTML = cond; 
      if($("pdf_cond")) $("pdf_cond").innerHTML = cond; 

      const rCode = getValue(currentRecord, FIELDS.remit_code);
      const showCode = (rCode && rCode.trim() !== "");
      if($("show_remit_code")) $("show_remit_code").innerText = rCode;
      if($("show_remit_label")) $("show_remit_label").style.display = showCode ? "inline" : "none";
      if($("show_remit_code")) $("show_remit_code").style.display = showCode ? "inline" : "none";
      if($("pdf_remit_code")) $("pdf_remit_code").innerText = rCode;
      if($("pdf_remit_label")) $("pdf_remit_label").style.display = showCode ? "inline" : "none";
      if($("pdf_remit_code")) $("pdf_remit_code").style.display = showCode ? "inline" : "none";
    }

    function initSignature() {
      const canvas = $("signature-pad"); const ratio = Math.max(window.devicePixelRatio || 1, 1);
      canvas.width = canvas.offsetWidth * ratio; canvas.height = canvas.offsetHeight * ratio;
      canvas.getContext("2d").scale(ratio, ratio);
      signaturePad = new SignaturePad(canvas, { minWidth: 3, maxWidth: 8, penColor: "black" });
    }

    function updatePreviewFromForm() {
      const name = $("input_name").value;
      const phone = $("input_phone").value;
      const occ = $("input_occ").value;

      if($("show_final_name")) $("show_final_name").innerText = name;
      if($("show_final_phone")) $("show_final_phone").innerText = phone;
      if($("show_final_occ")) $("show_final_occ").innerText = occ;
      
      if($("pdf_phone")) $("pdf_phone").innerText = phone;
      if($("pdf_occ")) $("pdf_occ").innerText = occ;
    }

    function goStep(n) {
      if (n === 2) {
        updatePreviewFromForm();
        setTimeout(initSignature, 250);
      }
      $("step-1").classList.add('hidden'); $("step-2").classList.add('hidden');
      $("step-" + n).classList.remove('hidden'); window.scrollTo(0, 0);
    }

    // 【新增】產生 PDF Blob 的共用函式
    async function generatePDFBlob() {
        const element = $("pdf-export-area");
        // 使用較高的 scale 以確保列印品質
        const canvas = await html2canvas(element, { scale: 2, useCORS: true });
        const imgWidth = 210; 
        const imgHeight = (canvas.height * imgWidth) / canvas.width; 
        const { jsPDF } = window.jspdf; 
        const pdf = new jsPDF('p', 'mm', [imgWidth, imgHeight]);
        pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, imgWidth, imgHeight);
        return pdf.output('blob'); // 回傳 Blob 物件
    }

    // 下載按鈕 (現在可以重用生成邏輯)
    async function downloadReceiptPDF() {
        const btn = event.currentTarget; btn.innerText = "PDF 產生中..."; btn.disabled = true;
        try {
            const pdfBlob = await generatePDFBlob();
            // 建立下載連結
            const url = URL.createObjectURL(pdfBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `定金收據_${$("show_final_name").innerText}.pdf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        } catch (err) { 
            console.error(err);
            alert("下載失敗，請先截圖存檔。"); 
        } finally { 
            btn.innerText = "📥 下載備份 PDF"; btn.disabled = false; 
        }
    }

    // 【修正】提交資料：先產生 PDF，放入 input，再送出
    async function submitData() {
      if (!signaturePad || signaturePad.isEmpty()) { alert("請先完成簽名喔！"); return; }
      if (!recordId) { alert("系統錯誤：無法取得單號 (Record ID)，無法存檔。請重新載入。"); return; }

      $("loader").classList.remove('hidden'); 
      $("loader-text").innerText = "正在生成收據 PDF 並上傳...";

      try {
          // 1. 同步簽名到 PDF 區域
          const sigData = signaturePad.toDataURL("image/png");
          if($("pdf_signature_img")) $("pdf_signature_img").src = sigData;
          if($("hidden_signature")) $("hidden_signature").value = sigData;

          // 2. 等待圖片渲染 (雖然 src 是同步的，但稍微緩衝比較保險)
          await new Promise(r => setTimeout(r, 100));

          // 3. 生成 PDF Blob
          const pdfBlob = await generatePDFBlob();

          // 4. 將 PDF Blob 塞入隱藏的 File Input
          const fileInput = $("hidden_pdf_input");
          const dataTransfer = new DataTransfer();
          const fileName = `不動產要約定金收據_${$("show_final_name").innerText}.pdf`;
          // 建立檔案物件
          const pdfFile = new File([pdfBlob], fileName, { type: "application/pdf" });
          dataTransfer.items.add(pdfFile);
          fileInput.files = dataTransfer.files;

          // 5. 送出表單
          const form = $("ragicForm");
          form.action = `${API_PROXY_BASE}/${RAGIC_FORM_PATH}/${recordId}`;
          form.submit();

          // 6. 顯示成功
          setTimeout(() => { 
              $("loader").classList.add('hidden'); 
              $("step-2").classList.add('hidden'); 
              $("step-success").classList.remove('hidden'); 
              window.scrollTo(0, 0); 
          }, 4000); // 延長時間給檔案上傳

      } catch (e) {
          console.error("PDF 生成或上傳失敗", e);
          alert("自動上傳 PDF 失敗，但文字資料可能已送出。請手動下載 PDF 備份。");
          $("loader").classList.add('hidden');
      }
    }

    function showFieldIds() {
        if (!currentRecord) return alert("尚未載入資料");
        $("debug-area").style.display = "block";
        let output = "=== 所有欄位 ID 與內容 ===\n";
        for (let key in currentRecord) {
            output += `ID: ${key} | 值: ${currentRecord[key]}\n`;
        }
        $("debug-content").innerText = output;
        alert("請查看頁面下方的黑色診斷框，確認是否有 1000792, 1000808, 1000837, 1000816, 1001709 這些欄位 ID。");
    }

    window.onload = () => {
      $("btn-test").onclick = () => { recordId = $("test-id-input").value.trim(); $("test-mode-ui").classList.add('hidden'); executeLoad(); };
      $("btn-next").onclick = () => goStep(2); $("btn-back").onclick = () => goStep(1);
      $("btn-clear").onclick = () => signaturePad.clear(); $("btn-submit").onclick = () => submitData();
      if (!recordId) { $("loader-spinner").classList.add('hidden'); $("loader-text").innerText = "請輸入 Record ID"; $("test-mode-ui").classList.remove('hidden'); }
      else { executeLoad(); }
    };
  </script>
</body>
</html>
