<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸å‹•ç”¢è¦ç´„å®šé‡‘æ”¶æ“šç°½ç½²</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .receipt-table th, .receipt-table td { border: 1.5px solid #000; padding: 10px; vertical-align: middle; }
        .receipt-table th { background-color: #f3f4f6; font-weight: bold; width: 100px; }
        .big-btn { transition: transform 0.1s; }
        .big-btn:active { transform: scale(0.95); }
        #signature-pad { background: white; border: 2px dashed #3b82f6; border-radius: 12px; cursor: crosshair; width: 100%; height: 250px; }
        #loader { background: rgba(255, 255, 255, 0.95); z-index: 100; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">

    <!-- è¼‰å…¥ä¸­å‹•ç•« -->
    <div id="loader" class="fixed inset-0 flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600 mb-4"></div>
        <p id="loader-text" class="text-xl font-bold text-gray-700">è³‡æ–™æº–å‚™ä¸­...</p>
        <button id="retry-btn" onclick="location.reload()" class="hidden mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg">é‡è©¦ä¸€æ¬¡</button>
    </div>

    <div class="max-w-3xl mx-auto p-4 md:p-8">
        <!-- ç¬¬ä¸€æ­¥ï¼šç¢ºèªè³‡æ–™ -->
        <div id="step-1" class="hidden bg-white rounded-3xl shadow-xl p-6 md:p-10 border-t-8 border-blue-600">
            <h1 class="text-3xl font-black text-blue-700 mb-2 text-center md:text-left">æ‚¨å¥½ï¼Œè«‹ç¢ºèªè³‡æ–™</h1>
            <p class="text-gray-500 mb-8 text-lg">å¦‚æœæ‚¨ç™¼ç¾è³‡æ–™æœ‰éŒ¯ï¼Œå¯ä»¥é»æ“Šæ ¼å­ä¿®æ”¹ã€‚</p>

            <div class="space-y-6">
                <div>
                    <label class="block text-xl font-bold text-gray-700 mb-2">æ‚¨çš„å§“å</label>
                    <input type="text" id="input_name" class="w-full text-2xl border-2 border-gray-300 rounded-xl p-4 focus:border-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-xl font-bold text-gray-700 mb-2">èº«åˆ†è­‰å­—è™Ÿ</label>
                    <input type="text" id="input_id" class="w-full text-2xl border-2 border-gray-300 rounded-xl p-4 focus:border-blue-500 outline-none uppercase">
                </div>
                <div>
                    <label class="block text-xl font-bold text-gray-700 mb-2">è¯çµ¡é›»è©±</label>
                    <input type="tel" id="input_phone" class="w-full text-2xl border-2 border-gray-300 rounded-xl p-4 focus:border-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-xl font-bold text-gray-700 mb-2">è·æ¥­</label>
                    <input type="text" id="input_occ" class="w-full text-2xl border-2 border-gray-300 rounded-xl p-4 focus:border-blue-500 outline-none">
                </div>
            </div>

            <button onclick="goStep(2)" class="big-btn w-full mt-10 bg-blue-600 hover:bg-blue-700 text-white text-2xl font-black py-6 rounded-2xl shadow-lg">
                é€™æ˜¯æˆ‘æœ¬äººï¼Œä¸‹ä¸€æ­¥ ğŸ‘‰
            </button>
        </div>

        <!-- ç¬¬äºŒæ­¥ï¼šé è¦½æ”¶æ“šèˆ‡ç°½å -->
        <div id="step-2" class="hidden bg-white rounded-3xl shadow-xl p-4 md:p-10 border-t-8 border-green-600">
            <h1 class="text-2xl font-black text-center mb-6">ä¸å‹•ç”¢è¦ç´„å®šé‡‘æ”¶æ“š</h1>
            
            <div class="overflow-x-auto">
                <table class="receipt-table w-full text-sm md:text-base mb-6">
                    <tr>
                        <th>æˆ¿å±‹åœ°å€</th>
                        <td colspan="3" id="show_addr">-</td>
                    </tr>
                    <tr>
                        <th>æœˆç§Ÿé‡‘</th>
                        <td id="show_rent" class="font-bold text-lg">-</td>
                        <th>æŠ¼é‡‘</th>
                        <td id="show_deposit">-</td>
                    </tr>
                    <tr>
                        <th>èµ·ç§Ÿæ—¥</th>
                        <td id="show_date">-</td>
                        <th>ä»˜è²»æ–¹å¼</th>
                        <td>æœˆç¹³</td>
                    </tr>
                    <tr>
                        <th>è¦ç´„æ¢ä»¶</th>
                        <td colspan="3" id="show_cond" class="text-xs h-24 align-top">ç„¡ç‰¹åˆ¥ç´„å®šæ¢ä»¶ã€‚</td>
                    </tr>
                    <tr>
                        <th>è¦ç´„å®šé‡‘</th>
                        <td id="show_earnest" class="text-red-600 font-bold text-xl">-</td>
                        <th>ç·¨è™Ÿ</th>
                        <td id="show_no">-</td>
                    </tr>
                </table>
            </div>

            <div class="bg-gray-50 p-4 rounded-xl text-xs text-gray-500 leading-relaxed mb-8">
                å£¹ã€ä¸Šè¿°æ¢ä»¶ç”±æˆ¿å®¢ç¢ºèªç„¡èª¤ã€‚è²³ã€è‹¥å±‹ä¸»ä¸åŒæ„æ‰¿ç§Ÿï¼Œå®šé‡‘ç„¡æ¯é€€é‚„æˆ¿å®¢ã€‚åƒã€å¦‚å±‹ä¸»åŒæ„æ‰¿ç§Ÿï¼Œå®šé‡‘è½‰ç‚ºéƒ¨åˆ†æŠ¼é‡‘æˆ–ç§Ÿé‡‘ã€‚è‚†ã€è‹¥æˆ¿å®¢åæ‚”ï¼Œå®šé‡‘ç”±å±‹ä¸»æ²’æ”¶ã€‚
            </div>

            <div class="mb-4">
                <label class="block text-2xl font-black text-gray-800 mb-4 text-center underline decoration-blue-500 decoration-4 underline-offset-8">è«‹åœ¨æ­¤è™•ç°½å</label>
                <div class="relative">
                    <canvas id="signature-pad"></canvas>
                    <button onclick="signaturePad.clear()" class="absolute top-2 right-2 bg-gray-100 text-gray-500 px-4 py-2 rounded-lg font-bold text-sm">é‡ç°½</button>
                </div>
            </div>

            <div class="flex flex-col md:flex-row gap-4">
                <button onclick="goStep(1)" class="order-2 md:order-1 flex-1 bg-gray-200 text-gray-700 text-xl font-bold py-5 rounded-2xl">å›ä¸Šä¸€æ­¥</button>
                <button onclick="submitData()" id="btn-submit" class="order-1 md:order-2 big-btn flex-[2] bg-green-600 hover:bg-green-700 text-white text-2xl font-black py-5 rounded-2xl shadow-xl">
                    ç°½å¥½äº†ï¼Œé€å‡º âœ…
                </button>
            </div>
        </div>

        <!-- æˆåŠŸç•«é¢ -->
        <div id="step-success" class="hidden bg-white rounded-3xl shadow-xl p-10 text-center">
            <div class="text-8xl mb-6">ğŸ‰</div>
            <h1 class="text-4xl font-black text-green-600 mb-4">ç°½ç½²æˆåŠŸï¼</h1>
            <p class="text-gray-500 text-xl">è³‡æ–™å·²å‚³å›çµ¦æœå‹™å°ˆå“¡ã€‚<br>æ‚¨å¯ä»¥é—œé–‰é€™å€‹ç•«é¢äº†ã€‚</p>
        </div>
    </div>

    <script>
        const RAGIC_API_KEY = "Nm5QVzFtZ1pGYzZIT1REUnBhY3A0bDVKY0luaEh3d2lrSmMzTHNSVjh3N1VHc1JadWJjQk9yZDQ3UlpZZnFubQ==";
        const RAGIC_BASE_URL = "https://www.ragic.com/demo/lease-management/2"; 
        
        const FIELDS = {
            name: "1001091", id: "1001092", phone: "1001093", occupation: "1001094",
            addr: "1001099", rent: "1001101", deposit: "1001107", date: "1001104",
            conditions: "1001108", earnest: "1001109", no: "1001111", signature: "1001110"
        };

        let currentRecord = null;
        let recordId = new URLSearchParams(window.location.search).get('id');
        let signaturePad = null;

        window.onload = async () => {
            const loader = document.getElementById('loader');
            const loaderText = document.getElementById('loader-text');
            const retryBtn = document.getElementById('retry-btn');

            if (!recordId) {
                loaderText.innerHTML = "<span class='text-red-600'>âš ï¸ ç¶²å€ç¼ºå°‘ ID åƒæ•¸</span><br><small>è«‹ç¢ºèªé€£çµæ˜¯å¦åŒ…å« ?id=...</small>";
                return;
            }

            try {
                await loadData();
                initSignature();
                // è³‡æ–™è¼‰å…¥æˆåŠŸå¾Œï¼Œéš±è— loader ä¸¦é¡¯ç¤ºç¬¬ä¸€æ­¥
                loader.classList.add('hidden');
                document.getElementById('step-1').classList.remove('hidden');
            } catch (err) {
                console.error(err);
                loaderText.innerHTML = "<span class='text-red-600'>âŒ é€£ç·šå¤±æ•—</span><br><small>åŸå› ï¼š" + err.message + "</small>";
                retryBtn.classList.remove('hidden');
            }
        };

        async function loadData() {
            // ä½¿ç”¨ api åƒæ•¸ä¸¦å¼·åˆ¶æª¢æŸ¥å›æ‡‰
            const url = `${RAGIC_BASE_URL}/${recordId}?api`;
            const response = await fetch(url, {
                method: 'GET',
                headers: { "Authorization": "Basic " + btoa(RAGIC_API_KEY) }
            });

            if (!response.ok) {
                if (response.status === 401) throw new Error("API Key ç„¡æ•ˆæˆ–æ¬Šé™ä¸è¶³");
                if (response.status === 404) throw new Error("æ‰¾ä¸åˆ°é€™ç­†å®šé‡‘å–®");
                throw new Error("ä¼ºæœå™¨å›æ‡‰éŒ¯èª¤ (" + response.status + ")");
            }

            const data = await response.json();
            currentRecord = data[recordId];

            if (!currentRecord) throw new Error("è³‡æ–™åº«å…§æ‰¾ä¸åˆ°å°æ‡‰çš„ç·¨è™Ÿ");

            // å¡«å…¥ç¬¬ä¸€é 
            document.getElementById('input_name').value = currentRecord[FIELDS.name] || "";
            document.getElementById('input_id').value = currentRecord[FIELDS.id] || "";
            document.getElementById('input_phone').value = currentRecord[FIELDS.phone] || "";
            document.getElementById('input_occ').value = currentRecord[FIELDS.occupation] || "";

            // å¡«å…¥ç¬¬äºŒé é è¦½
            document.getElementById('show_addr').innerText = currentRecord[FIELDS.addr] || "-";
            document.getElementById('show_rent').innerText = "$ " + (Number(currentRecord[FIELDS.rent]).toLocaleString());
            document.getElementById('show_deposit').innerText = "$ " + (Number(currentRecord[FIELDS.deposit]).toLocaleString());
            document.getElementById('show_date').innerText = currentRecord[FIELDS.date] || "-";
            document.getElementById('show_cond').innerText = currentRecord[FIELDS.conditions] || "ç„¡ç‰¹åˆ¥ç´„å®šæ¢ä»¶ã€‚";
            document.getElementById('show_earnest').innerText = "$ " + (Number(currentRecord[FIELDS.earnest]).toLocaleString());
            document.getElementById('show_no').innerText = currentRecord[FIELDS.no] || "AUTO";
        }

        function initSignature() {
            const canvas = document.getElementById('signature-pad');
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
            signaturePad = new SignaturePad(canvas, { minWidth: 2, maxWidth: 5, penColor: "black" });
        }

        function goStep(n) {
            document.getElementById('step-1').classList.add('hidden');
            document.getElementById('step-2').classList.add('hidden');
            document.getElementById(`step-${n}`).classList.remove('hidden');
            window.scrollTo(0, 0);
            if(n === 2) {
                // é€²å…¥ç¬¬äºŒæ­¥æ™‚é‡æ–°èª¿æ•´ç°½åæ¿å¤§å°ä»¥é˜²è·‘ç‰ˆ
                setTimeout(initSignature, 200);
            }
        }

        async function submitData() {
            if (signaturePad.isEmpty()) {
                alert("é˜¿å…¬/é˜¿å¬¤ï¼Œè¦åœ¨è—è‰²æ¡†æ¡†å…§ç°½åæ‰èƒ½é€å‡ºå“¦ï¼");
                return;
            }

            const btn = document.getElementById('btn-submit');
            const loader = document.getElementById('loader');
            const loaderText = document.getElementById('loader-text');
            
            btn.disabled = true;
            btn.innerText = "æ­£åœ¨å‚³é€...";
            loader.classList.remove('hidden');
            loaderText.innerText = "è³‡æ–™å‚³é€ä¸­ï¼Œè«‹å‹¿é—œé–‰...";

            const payload = new URLSearchParams();
            payload.append(FIELDS.name, document.getElementById('input_name').value);
            payload.append(FIELDS.id, document.getElementById('input_id').value.toUpperCase());
            payload.append(FIELDS.phone, document.getElementById('input_phone').value);
            payload.append(FIELDS.occupation, document.getElementById('input_occ').value);
            payload.append(FIELDS.signature, signaturePad.toDataURL()); 

            try {
                const response = await fetch(`${RAGIC_BASE_URL}/${recordId}?api`, {
                    method: 'POST',
                    headers: { 
                        "Authorization": "Basic " + btoa(RAGIC_API_KEY),
                        "Content-Type": "application/x-www-form-urlencoded"
                    },
                    body: payload
                });

                if (response.ok) {
                    loader.classList.add('hidden');
                    document.getElementById('step-2').classList.add('hidden');
                    document.getElementById('step-success').classList.remove('hidden');
                } else {
                    throw new Error("å‚³é€å¤±æ•—ï¼Œè«‹è¯ç¹«æ¥­å‹™å“¡");
                }
            } catch (err) {
                loader.classList.add('hidden');
                alert("å“å‘€ï¼å‚³é€å¤±æ•—äº†ï¼Œè«‹æª¢æŸ¥ç¶²è·¯å¾Œå†è©¦ä¸€æ¬¡ï¼š\n" + err.message);
                btn.disabled = false;
                btn.innerText = "ç°½å¥½äº†ï¼Œé€å‡º âœ…";
            }
        }
    </script>
</body>
</html>
