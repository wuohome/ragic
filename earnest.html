<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸å‹•ç”¢è¦ç´„å®šé‡‘æ”¶æ“šç°½ç½²ç³»çµ±</title>
    <!-- ä½¿ç”¨ Tailwind CSS å¿«é€Ÿç¾åŒ– -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ç°½åæ¿å¥—ä»¶ -->
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* æ¨¡æ“¬ PDF è¡¨æ ¼æ¨£å¼ - åŠ ç²—ç·šæ¢ */
        .receipt-table th, .receipt-table td { border: 2px solid #000; padding: 12px; vertical-align: middle; }
        .receipt-table th { background-color: #f1f5f9; font-weight: 900; width: 120px; color: #000; }

        /* æŒ‰éˆ•è¦–è¦º */
        .big-btn { transition: all 0.2s; }
        .big-btn:active { transform: scale(0.96); opacity: 0.9; }

        /* ç°½åæ¿å€åŸŸ */
        #signature-pad {
            background: #ffffff;
            border: 3px dashed #3b82f6;
            border-radius: 16px;
            cursor: crosshair;
            width: 100%;
            height: 280px;
            touch-action: none;
        }
        
        /* é®ç½© */
        #loader { background: rgba(255, 255, 255, 0.98); z-index: 100; }

        /* è¼¸å…¥æ¡†èšç„¦ */
        input:focus { border-color: #3b82f6; box-shadow: 0 0 0 6px rgba(59, 130, 246, 0.15); }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">

    <!-- è¼‰å…¥ä¸­å‹•ç•« -->
    <div id="loader" class="fixed inset-0 flex flex-col items-center justify-center p-6 text-center">
        <div id="loader-spinner" class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600 mb-6"></div>
        <p id="loader-text" class="text-2xl font-black text-slate-700">æ­£åœ¨é€£æ¥ç³»çµ±ï¼Œè«‹ç¨å€™...</p>
        
        <!-- æ¸¬è©¦æ¨¡å¼è¼¸å…¥æ¡† -->
        <div id="test-mode-ui" class="hidden mt-8 bg-white p-8 rounded-3xl shadow-2xl max-w-sm w-full border-2 border-blue-500">
            <h2 class="text-3xl font-black text-blue-600 mb-4">æ¸¬è©¦æ¨¡å¼</h2>
            <p class="text-slate-500 mb-6 text-lg font-medium text-left">è«‹è¼¸å…¥ç´€éŒ„ç·¨è™Ÿ (Record ID)ï¼š</p>
            <input type="number" id="test-id-input" placeholder="ä¾‹å¦‚: 38" class="w-full text-center text-5xl p-4 border-4 border-slate-200 rounded-2xl mb-6 outline-none font-bold">
            <button onclick="startManualTest()" class="w-full bg-blue-600 text-white font-black py-5 rounded-2xl text-2xl shadow-xl big-btn">è¼‰å…¥è³‡æ–™</button>
        </div>

        <button id="retry-btn" onclick="location.reload()" class="hidden mt-6 bg-slate-800 text-white px-8 py-3 rounded-xl font-bold">é‡æ–°å˜—è©¦</button>
    </div>

    <!-- éš±è—çš„ Iframe ç”¨ä¾†ç©©å®šé€å‡ºè³‡æ–™ (é¿é–‹ CORS) -->
    <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;"></iframe>

    <div class="max-w-3xl mx-auto p-4 md:p-8">
        <!-- ç¬¬ä¸€æ­¥ï¼šç¢ºèªè³‡æ–™ -->
        <div id="step-1" class="hidden bg-white rounded-[2rem] shadow-2xl p-6 md:p-12 border-t-[12px] border-blue-600">
            <h1 class="text-4xl font-black text-blue-700 mb-4 text-center md:text-left">è«‹æ ¸å°è³‡æ–™</h1>
            <p class="text-slate-500 mb-10 text-xl font-medium text-center md:text-left">æˆ¿å®¢æ‚¨å¥½ï¼Œè‹¥è³‡æ–™æœ‰èª¤å¯ç›´æ¥ä¿®æ”¹ã€‚</p>

            <form id="ragicForm" method="POST" target="hidden_iframe" class="space-y-8">
                <div>
                    <label class="block text-2xl font-black text-slate-700 mb-3">æ‚¨çš„å§“å</label>
                    <input type="text" name="1001091" id="input_name" class="w-full text-3xl border-4 border-slate-200 rounded-2xl p-5 outline-none font-bold bg-yellow-50">
                </div>
                <div>
                    <label class="block text-2xl font-black text-slate-700 mb-3">èº«åˆ†è­‰å­—è™Ÿ</label>
                    <input type="text" name="1001092" id="input_id" class="w-full text-3xl border-4 border-slate-200 rounded-2xl p-5 outline-none font-bold uppercase bg-yellow-50">
                </div>
                <div>
                    <label class="block text-2xl font-black text-slate-700 mb-3">è¯çµ¡é›»è©±</label>
                    <input type="tel" name="1001093" id="input_phone" class="w-full text-3xl border-4 border-slate-200 rounded-2xl p-5 outline-none font-bold">
                </div>
                <div>
                    <label class="block text-2xl font-black text-slate-700 mb-3">è·æ¥­</label>
                    <input type="text" name="1001094" id="input_occ" class="w-full text-3xl border-4 border-slate-200 rounded-2xl p-5 outline-none font-bold">
                </div>
                <!-- ç°½åéš±è—æ¬„ä½ (èˆ‡ Ragic æ¬„ä½ ID å°æ‡‰) -->
                <input type="hidden" name="1001110" id="hidden_signature">
            </form>

            <button onclick="goStep(2)" class="big-btn w-full mt-12 bg-blue-600 hover:bg-blue-700 text-white text-3xl font-black py-8 rounded-3xl shadow-2xl">
                è³‡æ–™æ­£ç¢ºï¼Œä¸‹ä¸€æ­¥ ğŸ‘‰
            </button>
        </div>

        <!-- ç¬¬äºŒæ­¥ï¼šé è¦½æ”¶æ“šèˆ‡ç°½å -->
        <div id="step-2" class="hidden bg-white rounded-[2rem] shadow-2xl p-4 md:p-12 border-t-[12px] border-green-600">
            <h1 class="text-3xl font-black text-center mb-8 text-green-700">ä¸å‹•ç”¢è¦ç´„å®šé‡‘æ”¶æ“š</h1>
            
            <div class="overflow-x-auto mb-10">
                <table class="receipt-table w-full text-base md:text-lg border-collapse">
                    <tr>
                        <th>æˆ¿å±‹åœ°å€</th>
                        <td colspan="3" id="show_addr" class="font-bold text-slate-800">-</td>
                    </tr>
                    <tr>
                        <th>ç§Ÿé‡‘</th>
                        <td id="show_rent" class="font-black text-blue-700 text-xl">-</td>
                        <th>æŠ¼é‡‘</th>
                        <td id="show_deposit" class="font-bold">-</td>
                    </tr>
                    <tr>
                        <th>èµ·ç§Ÿæ—¥æœŸ</th>
                        <td id="show_date" class="font-bold">-</td>
                        <th>ä»˜æ¬¾æ–¹å¼</th>
                        <td class="font-bold italic text-slate-500">æœˆç¹³</td>
                    </tr>
                    <tr>
                        <th>è¦ç´„æ¢ä»¶</th>
                        <td colspan="3" id="show_cond" class="text-sm h-32 align-top text-slate-600 leading-relaxed font-medium">-</td>
                    </tr>
                    <tr>
                        <th>è¦ç´„å®šé‡‘</th>
                        <td id="show_earnest" class="text-red-600 font-black text-3xl">-</td>
                        <th>ç·¨è™Ÿ</th>
                        <td id="show_no" class="font-mono text-slate-400 text-sm">-</td>
                    </tr>
                </table>
            </div>

            <div class="bg-blue-50 border-l-8 border-blue-400 p-8 rounded-2xl text-base text-slate-700 leading-relaxed mb-10">
                <p class="font-black text-blue-800 mb-3 text-xl">é‡è¦ç´„å®šï¼š</p>
                å£¹ã€ä¸Šè¿°æ¢ä»¶ç”±æˆ¿å®¢ç¢ºèªç„¡èª¤ã€‚è²³ã€è‹¥å±‹ä¸»ä¸åŒæ„æ‰¿ç§Ÿï¼Œå®šé‡‘ç„¡æ¯é€€é‚„æˆ¿å®¢ã€‚åƒã€å¦‚å±‹ä¸»åŒæ„æ‰¿ç§Ÿï¼Œå®šé‡‘è½‰ç‚ºéƒ¨åˆ†æŠ¼é‡‘æˆ–ç§Ÿé‡‘ã€‚è‚†ã€è‹¥æˆ¿å®¢åæ‚”ï¼Œå®šé‡‘ç”±å±‹ä¸»æ²’æ”¶ã€‚
            </div>

            <div class="mb-6">
                <label class="block text-3xl font-black text-slate-800 mb-8 text-center underline decoration-blue-500 decoration-8 underline-offset-[12px]">æˆ¿å®¢åœ¨æ­¤è™•ç°½å</label>
                <div class="relative">
                    <canvas id="signature-pad"></canvas>
                    <button onclick="signaturePad.clear()" class="absolute top-4 right-4 bg-slate-100 text-slate-600 px-6 py-3 rounded-xl font-black text-sm shadow active:bg-slate-200">æ¸…é™¤é‡å¯«</button>
                </div>
            </div>

            <div class="flex flex-col md:flex-row gap-6 mt-12">
                <button onclick="goStep(1)" class="order-2 md:order-1 flex-1 bg-slate-100 text-slate-500 text-2xl font-black py-6 rounded-3xl">è¿”å›ä¿®æ”¹</button>
                <button onclick="submitData()" id="btn-submit" class="order-1 md:order-2 big-btn flex-[2] bg-green-600 hover:bg-green-700 text-white text-3xl font-black py-6 rounded-3xl shadow-2xl">
                    ç°½å¥½äº†ï¼Œé€å‡º âœ…
                </button>
            </div>
        </div>

        <!-- ç¬¬ä¸‰æ­¥ï¼šæˆåŠŸç•«é¢ -->
        <div id="step-success" class="hidden bg-white rounded-[3rem] shadow-2xl p-16 text-center border-t-[16px] border-emerald-500">
            <div class="text-[120px] mb-8 animate-bounce">âœ…</div>
            <h1 class="text-5xl font-black text-emerald-600 mb-6">ç°½ç½²å®Œæˆï¼</h1>
            <p class="text-slate-500 text-2xl leading-relaxed">æ‚¨çš„æ”¶æ“šå·²æˆåŠŸå›å‚³ã€‚<br>æ„Ÿè¬æ‚¨çš„é…åˆï¼Œæ‚¨å¯ä»¥é—œé–‰æ­¤é é¢ã€‚</p>
        </div>
    </div>

    <script>
        // --- è¨­å®šå€ ---
        const RAGIC_API_KEY = "VEZsOEwzYzVJdWdoWXRDM3ptS2YwRk9mUjFib2tWVXJ1RitpTGNSWk94R3YzbVVPU0JJaThraUkxVzRQbEFaOQ==";
        const RAGIC_BASE_URL = "https://ap15.ragic.com/wuohome/payments/1"; 
        
        const FIELDS = {
            name: "1001091", id: "1001092", phone: "1001093", occupation: "1001094",
            addr: "1001099", rent: "1001101", deposit: "1001107", date: "1001104",
            conditions: "1001108", earnest: "1001109", no: "1001111", signature: "1001110"
        };

        let currentRecord = null;
        let recordId = new URLSearchParams(window.location.search).get('id');
        let signaturePad = null;

        // å…¨åŸŸå›å‚³å‡½å¼ (JSONP å¿…å‚™)
        window.ragicCallback = function(data) {
            console.log("Ragic è³‡æ–™åŸå§‹å…§å®¹ï¼š", data);
            
            // å¼·åŠ›æœå°‹ï¼šæ‰¾å‡ºä»»ä½•åŒ…å«æ¬„ä½è³‡è¨Šçš„ç‰©ä»¶
            currentRecord = findRecordDeep(data);

            if (currentRecord) {
                renderStepOne();
                initSignature();
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('step-1').classList.remove('hidden');
            } else {
                showError("è³‡æ–™è§£æå¤±æ•—", `ID ${recordId} çš„è³‡æ–™å…§å®¹ä¸ç¬¦åˆé æœŸã€‚è«‹ç¢ºèªè©² ID åœ¨ payments è¡¨å–®ä¸­ç¢ºå¯¦å­˜åœ¨ï¼Œä¸”æ¬„ä½ç·¨è™Ÿæ­£ç¢ºã€‚`);
            }
        };

        window.onload = () => {
            if (!recordId) {
                document.getElementById('loader-spinner').classList.add('hidden');
                document.getElementById('loader-text').classList.add('hidden');
                document.getElementById('test-mode-ui').classList.remove('hidden');
                return;
            }
            executeLoad();
        };

        function startManualTest() {
            const input = document.getElementById('test-id-input');
            if (!input.value) { alert("è«‹è¼¸å…¥ç·¨è™Ÿï¼"); return; }
            recordId = input.value.trim();
            document.getElementById('test-mode-ui').classList.add('hidden');
            document.getElementById('loader-spinner').classList.remove('hidden');
            document.getElementById('loader-text').classList.remove('hidden');
            document.getElementById('loader-text').innerText = "é€£ç·šè®€å–ä¸­...";
            executeLoad();
        }

        // è®€å–ï¼šä½¿ç”¨ JSONP ä¸¦è£œä¸Š .json ä»¥åŠ jsonp åƒæ•¸
        function executeLoad() {
            const loaderText = document.getElementById('loader-text');
            const retryBtn = document.getElementById('retry-btn');
            
            const script = document.createElement('script');
            // ä¿®æ­£ï¼šRagic çš„ JSONP åƒæ•¸é€šå¸¸æ˜¯ jsonp=... ä¸”å»ºè­°åŠ ä¸Š .json çµå°¾
            script.src = `${RAGIC_BASE_URL}/${recordId}.json?api&APIKey=${RAGIC_API_KEY}&jsonp=ragicCallback`;
            script.onerror = () => {
                showError("ç³»çµ±é€£ç·šéŒ¯èª¤", "ç„¡æ³•é€£ç·šè‡³ä¼ºæœå™¨ã€‚è«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯ç‹€æ³ï¼Œæˆ–ç¢ºèª API Key æ˜¯å¦æ­£ç¢ºã€‚");
            };
            document.body.appendChild(script);

            // è¶…æ™‚è™•ç†
            setTimeout(() => {
                if (!currentRecord) {
                    showError("é€£ç·šè¶…æ™‚", "ä¼ºæœå™¨åæ‡‰ç·©æ…¢ã€‚è«‹ç¢ºèªæ‚¨çš„ Ragic ç¶²å€èˆ‡ ID æ˜¯å¦æ­£ç¢ºã€‚");
                }
            }, 10000);
        }

        function showError(title, msg) {
            document.getElementById('loader-spinner').classList.add('hidden');
            document.getElementById('loader-text').innerHTML = `<span class='text-red-600 font-black'>âŒ ${title}</span><br><small class='text-gray-500'>${msg}</small>`;
            document.getElementById('retry-btn').classList.remove('hidden');
        }

        function cleanCurrency(val) {
            if (!val) return 0;
            if (typeof val === 'number') return val;
            const cleaned = val.toString().replace(/[^\d.]/g, '');
            return Number(cleaned) || 0;
        }

        // æš´åŠ›æ·±åº¦æœå°‹ï¼šåªè¦ç‰©ä»¶è£¡é¢æœ‰ä»»ä½•ä¸€å€‹ Key æ˜¯ 100 é–‹é ­çš„æ•¸å­—ï¼Œå°±è¦–ç‚ºç´€éŒ„
        function findRecordDeep(obj) {
            if (!obj || typeof obj !== 'object') return null;
            
            // æª¢æŸ¥ç›®å‰çš„å±¬æ€§ä¸­æ˜¯å¦æœ‰æ¬„ä½ ID
            for (let key in obj) {
                if (key.startsWith('100')) return obj;
            }
            
            // å¦‚æœæ²’æ‰¾åˆ°ï¼Œç¹¼çºŒå¾€å…§å±¤é‘½
            if (Array.isArray(obj)) {
                for (let item of obj) {
                    const res = findRecordDeep(item);
                    if (res) return res;
                }
            } else {
                for (let key in obj) {
                    const res = findRecordDeep(obj[key]);
                    if (res) return res;
                }
            }
            return null;
        }

        function renderStepOne() {
            document.getElementById('input_name').value = currentRecord[FIELDS.name] || "";
            document.getElementById('input_id').value = currentRecord[FIELDS.id] || "";
            document.getElementById('input_phone').value = currentRecord[FIELDS.phone] || "";
            document.getElementById('input_occ').value = currentRecord[FIELDS.occupation] || "";

            // æ›´æ–°é è¦½é é¢
            document.getElementById('show_addr').innerText = currentRecord[FIELDS.addr] || "-";
            document.getElementById('show_rent').innerText = "$ " + cleanCurrency(currentRecord[FIELDS.rent]).toLocaleString();
            document.getElementById('show_deposit').innerText = "$ " + cleanCurrency(currentRecord[FIELDS.deposit]).toLocaleString();
            document.getElementById('show_date').innerText = currentRecord[FIELDS.date] || "-";
            document.getElementById('show_cond').innerText = currentRecord[FIELDS.conditions] || "ç„¡ç‰¹åˆ¥ç´„å®šæ¢ä»¶ã€‚";
            document.getElementById('show_earnest').innerText = "$ " + cleanCurrency(currentRecord[FIELDS.earnest]).toLocaleString();
            document.getElementById('show_no').innerText = currentRecord[FIELDS.no] || "ID-" + recordId;
        }

        function initSignature() {
            const canvas = document.getElementById('signature-pad');
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
            signaturePad = new SignaturePad(canvas, { minWidth: 2, maxWidth: 5, penColor: "black" });
        }

        function goStep(n) {
            document.getElementById('step-1').classList.add('hidden');
            document.getElementById('step-2').classList.add('hidden');
            document.getElementById(`step-${n}`).classList.remove('hidden');
            window.scrollTo(0, 0);
            if(n === 2) setTimeout(initSignature, 200);
        }

        function submitData() {
            if (signaturePad.isEmpty()) { alert("è«‹ç°½åå¾Œå†é€å‡ºå“¦ï¼"); return; }
            const btn = document.getElementById('btn-submit');
            btn.disabled = true;
            btn.innerText = "å‚³é€ä¸­...";
            const loader = document.getElementById('loader');
            loader.classList.remove('hidden');
            document.getElementById('loader-spinner').classList.remove('hidden');
            document.getElementById('loader-text').innerText = "ç°½ç½²å›å‚³ä¸­ï¼Œè«‹å‹¿é—œé–‰...";
            document.getElementById('hidden_signature').value = signaturePad.toDataURL();

            const form = document.getElementById('ragicForm');
            form.action = `${RAGIC_BASE_URL}/${recordId}?api&APIKey=${RAGIC_API_KEY}`;
            form.submit();

            setTimeout(() => {
                loader.classList.add('hidden');
                document.getElementById('step-2').classList.add('hidden');
                document.getElementById('step-success').classList.remove('hidden');
            }, 2500);
        }
    </script>
</body>
</html>
