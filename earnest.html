<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ä¸å‹•ç”¢è¦ç´„å®šé‡‘æ”¶æ“šç°½ç½²ç³»çµ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
    body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
    .receipt-table th, .receipt-table td { border: 2px solid #000; padding: 12px; vertical-align: middle; }
    .receipt-table th { background-color: #f1f5f9; font-weight: 900; width: 140px; color: #000; font-size: 1.2rem; }
    .big-btn { transition: all 0.2s; cursor: pointer; }
    .big-btn:active { transform: scale(0.96); opacity: 0.9; }
    #signature-pad { background: #ffffff; border: 4px dashed #3b82f6; border-radius: 20px; width: 100%; height: 320px; touch-action: none; }
    #loader { background: rgba(255, 255, 255, 0.98); z-index: 100; }
    .debug-box { background: #1a1a1a; color: #00ff00; padding: 15px; border-radius: 12px; font-size: 14px; margin-top: 20px; text-align: left; overflow-x: auto; display: none; border: 2px solid #333; }
    .grandpa-input:focus { border-color: #2563eb; box-shadow: 0 0 0 10px rgba(37, 99, 235, 0.1); background-color: #fff; }
  </style>
</head>

<body class="bg-slate-100 min-h-screen">

  <!-- è¼‰å…¥ä¸­ / æ¸¬è©¦ä»‹é¢ -->
  <div id="loader" class="fixed inset-0 flex flex-col items-center justify-center p-6 text-center">
    <div id="loader-spinner" class="animate-spin rounded-full h-20 w-20 border-t-4 border-b-4 border-blue-600 mb-6"></div>
    <p id="loader-text" class="text-3xl font-black text-slate-800">æ­£åœ¨è®€å– Ragic è³‡æ–™...</p>

    <div id="test-mode-ui" class="hidden mt-8 bg-white p-10 rounded-[3rem] shadow-2xl max-w-sm w-full border-4 border-blue-500">
      <h2 class="text-3xl font-black text-blue-600 mb-6 text-center">æ¸¬è©¦æ¨¡å¼</h2>
      <p class="text-slate-500 mb-4 text-xl font-medium text-left">è«‹è¼¸å…¥æ­£ç¢ºçš„ Record IDï¼š</p>
      <input type="number" id="test-id-input" placeholder="3"
        class="w-full text-center text-6xl p-6 border-4 border-slate-200 rounded-3xl mb-8 outline-none font-bold bg-slate-50">
      <button id="btn-test" class="w-full bg-blue-600 text-white font-black py-7 rounded-3xl text-3xl shadow-xl big-btn">
        é–‹å§‹è¼‰å…¥
      </button>
    </div>

    <!-- å·¥ç¨‹è¨ºæ–·è¦–çª— -->
    <div id="debug-area" class="debug-box w-full max-w-lg">
      <p class="text-white font-bold mb-2">ã€é€£ç·šè¨ºæ–·ã€‘</p>
      <div id="debug-content" class="font-mono">ç­‰å¾…é€£ç·šä¸­...</div>
    </div>

    <button id="retry-btn" onclick="location.reload()" class="hidden mt-8 bg-slate-800 text-white px-10 py-4 rounded-2xl font-black text-xl">
      é‡æ–°è¼‰å…¥
    </button>
  </div>

  <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;"></iframe>

  <div class="max-w-3xl mx-auto p-4 md:p-8">

    <!-- ç¬¬ä¸€æ­¥ï¼šæ ¸å°è³‡æ–™ -->
    <div id="step-1" class="hidden bg-white rounded-[3rem] shadow-2xl p-8 md:p-14 border-t-[16px] border-blue-600">
      <h1 class="text-5xl font-black text-blue-700 mb-6 text-center md:text-left">è«‹æ ¸å°æˆ¿å®¢è³‡æ–™</h1>
      <p class="text-slate-500 mb-12 text-2xl font-medium text-center md:text-left">æˆ¿å®¢æ‚¨å¥½ï¼Œè³‡æ–™è‹¥æœ‰èª¤å¯ç›´æ¥ä¿®æ”¹ã€‚</p>

      <form id="ragicForm" method="POST" target="hidden_iframe" class="space-y-10">
        <div>
          <label class="block text-3xl font-black text-slate-700 mb-4">æˆ¿å®¢å§“å</label>
          <input type="text" name="1001091" id="input_name" class="grandpa-input w-full text-4xl border-4 border-slate-200 rounded-3xl p-6 outline-none font-bold bg-yellow-50 shadow-inner">
        </div>
        <div>
          <label class="block text-3xl font-black text-slate-700 mb-4">èº«åˆ†è­‰å­—è™Ÿ</label>
          <input type="text" name="1001092" id="input_id" class="grandpa-input w-full text-4xl border-4 border-slate-200 rounded-3xl p-6 outline-none font-bold uppercase bg-yellow-50 shadow-inner">
        </div>
        <div>
          <label class="block text-3xl font-black text-slate-700 mb-4">è¯çµ¡é›»è©±</label>
          <input type="tel" name="1001093" id="input_phone" class="grandpa-input w-full text-4xl border-4 border-slate-200 rounded-3xl p-6 outline-none font-bold">
        </div>
        <div>
          <label class="block text-3xl font-black text-slate-700 mb-4">æˆ¿å®¢è·æ¥­</label>
          <input type="text" name="1001094" id="input_occ" class="grandpa-input w-full text-4xl border-4 border-slate-200 rounded-3xl p-6 outline-none font-bold">
        </div>
        <input type="hidden" name="1001110" id="hidden_signature">
      </form>

      <button id="btn-next" class="big-btn w-full mt-14 bg-blue-600 hover:bg-blue-700 text-white text-4xl font-black py-9 rounded-[2.5rem] shadow-2xl">
        è³‡æ–™æ­£ç¢ºï¼Œä¸‹ä¸€é  ğŸ‘‰
      </button>
    </div>

    <!-- ç¬¬äºŒæ­¥ï¼šé è¦½æ”¶æ“š -->
    <div id="step-2" class="hidden bg-white rounded-[3rem] shadow-2xl p-4 md:p-14 border-t-[16px] border-green-600">
      <h1 class="text-3xl font-black text-center mb-8 text-green-700">ä¸å‹•ç”¢è¦ç´„å®šé‡‘æ”¶æ“š</h1>
      <div class="overflow-x-auto mb-10">
        <table class="receipt-table w-full text-xl border-collapse">
          <tr><th>æˆ¿å±‹åœ°å€</th><td colspan="3" id="show_addr" class="font-bold text-slate-800">-</td></tr>
          <tr><th>é è¨ˆç§Ÿé‡‘</th><td id="show_rent" class="font-black text-blue-700 text-2xl">-</td><th>ç°½ç´„æŠ¼é‡‘</th><td id="show_deposit" class="font-bold">-</td></tr>
          <tr><th>èµ·ç§Ÿæ—¥æœŸ</th><td id="show_date" class="font-bold">-</td><th>ä»˜æ¬¾æ–¹å¼</th><td id="show_pay_method" class="font-bold italic text-slate-500">-</td></tr>
          <tr><th>è¦ç´„æ¢ä»¶</th><td colspan="3" id="show_cond" class="text-base h-40 align-top text-slate-600 leading-relaxed font-medium">-</td></tr>
          <tr><th>è¦ç´„å®šé‡‘</th><td id="show_earnest" class="text-red-600 font-black text-4xl">-</td><th>ç·¨è™Ÿ</th><td id="show_no" class="font-mono text-slate-400 text-sm">-</td></tr>
        </table>
      </div>

      <div class="mb-10 text-center">
        <label class="block text-4xl font-black text-slate-800 mb-8 underline decoration-blue-500 decoration-8 underline-offset-[16px]">æˆ¿å®¢ç°½åè™•</label>
        <div class="relative"><canvas id="signature-pad"></canvas><button id="btn-clear" class="absolute top-4 right-4 bg-slate-100 text-slate-600 px-6 py-3 rounded-xl font-black text-sm">æ¸…é™¤</button></div>
      </div>

      <div class="flex flex-col md:flex-row gap-6 mt-12">
        <button id="btn-back" class="order-2 md:order-1 flex-1 bg-slate-200 text-slate-500 text-3xl font-black py-7 rounded-3xl">å›ä¸Šä¸€æ­¥</button>
        <button id="btn-submit" class="order-1 md:order-2 big-btn flex-[2] bg-emerald-600 hover:bg-emerald-700 text-white text-4xl font-black py-7 rounded-3xl shadow-2xl">ç°½å¥½äº† âœ…</button>
      </div>
    </div>

    <!-- ç¬¬ä¸‰æ­¥ï¼šæˆåŠŸ -->
    <div id="step-success" class="hidden bg-white rounded-[3rem] shadow-2xl p-20 text-center border-t-[16px] border-emerald-500">
      <div class="text-[150px] mb-8 animate-bounce">âœ…</div>
      <h1 class="text-6xl font-black text-emerald-600 mb-6">ç°½ç½²å®Œæˆï¼</h1>
      <p class="text-slate-500 text-2xl">è³‡æ–™å·²æˆåŠŸå‚³å›ï¼Œæ‚¨å¯ä»¥é—œé–‰é é¢ã€‚</p>
    </div>

  </div>

  <script>
    const RAGIC_API_KEY = "VEZsOEwzYzVJdWdoWXRDM3ptS2YwRUhIcG1iMjI0S2hXT2VieXpCc0p4M21pY29JTnRvL1pueThPTzNVcktWNQ==";
    const RAGIC_BASE_URL = "https://ap15.ragic.com/wuohome/payments/1";

    const FIELDS = {
      name: ["ç§Ÿå®¢å§“å", "1001091"],
      id: ["ç§Ÿå®¢èº«åˆ†è­‰å­—è™Ÿ", "1001092"],
      phone: ["ç§Ÿå®¢é›»è©±", "1001093"],
      occupation: ["ç§Ÿå®¢è·æ¥­", "1001094"],
      addr: ["åœ°å€", "1001099"],
      rent: ["ç§Ÿé‡‘", "1001101"],
      deposit: ["æŠ¼é‡‘", "1001107"],
      date: ["èµ·ç§Ÿæ—¥", "1001104"],
      conditions: ["è¦ç´„æ¢ä»¶", "1001108"],
      earnest: ["è¦ç´„å®šé‡‘", "1001109"],
      no: ["å®šé‡‘å–®ç·¨è™Ÿ", "1001111"],
      pay_method: ["ä»˜æ¬¾æ–¹å¼", "ä»˜æ¬¾æ–¹å¼2", "1001112"],
      signature: ["ç§Ÿå®¢ç°½å", "1001110"]
    };

    let currentRecord = null;
    let recordId = new URLSearchParams(window.location.search).get('id');
    let signaturePad = null;
    let loadTimer = null;

    const $ = (id) => document.getElementById(id);

    function getValue(rec, keys) {
      for (let k of keys) { 
        if (rec[k] !== undefined && rec[k] !== null && rec[k] !== "") return rec[k]; 
      }
      return "";
    }

    function debug(msg, obj) {
      $("debug-area").style.display = 'block';
      const content = typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2);
      $("debug-content").innerText = msg + "\n" + content.substring(0, 1000);
    }

    // æ›´æ–°ç²¾æº–å°é½Šé‚è¼¯
    function findExactRecord(obj, targetId) {
      if (!obj || typeof obj !== 'object') return null;
      
      // 1. å„ªå…ˆæª¢æŸ¥ Key æ˜¯å¦åŒ¹é… (ä¾‹å¦‚å›å‚³å…§å®¹æ˜¯ {"3":{...}})
      if (obj[targetId]) return obj[targetId];

      // 2. æª¢æŸ¥ç‰©ä»¶å…§éƒ¨æ˜¯å¦æœ‰ _ragicId åŒ¹é…
      if (obj["_ragicId"] == targetId || obj["Record ID"] == targetId) return obj;

      // 3. å¦‚æœç›®å‰çš„ç‰©ä»¶çœ‹èµ·ä¾†å°±æ˜¯ç´€éŒ„ (åŒ…å«ç§Ÿå®¢å§“å)ï¼Œä¸”æ²’æ‰¾åˆ°å…¶ä»–åŒ¹é…ï¼Œæš«æ™‚æ¨™è¨˜ç‚ºå€™é¸
      let candidate = null;
      if (obj["ç§Ÿå®¢å§“å"] !== undefined) candidate = obj;

      // éè¿´å°‹æ‰¾å…§å±¤
      for (const k in obj) {
        if (typeof obj[k] === 'object') {
          const res = findExactRecord(obj[k], targetId);
          if (res) return res;
        }
      }
      return candidate;
    }

    window.ragicCallback = function (data) {
      clearTimeout(loadTimer);
      debug("âœ… æˆåŠŸé€£ç·šï¼Œå°‹æ‰¾ ID: " + recordId, data);

      // ä½¿ç”¨ç²¾æº–åŒ¹é…é‚è¼¯
      currentRecord = findExactRecord(data, recordId);
      
      if (!currentRecord) {
        debug("âŒ æ‰¾ä¸åˆ° ID: " + recordId + " çš„è³‡æ–™ã€‚å›å‚³å…§å®¹ä¸­ä¼¼ä¹æ²’æœ‰é€™ç­†ç´€éŒ„ã€‚");
        $("loader-text").innerText = "æ‰¾ä¸åˆ°ç·¨è™Ÿ " + recordId + " çš„è³‡æ–™";
        return;
      }

      // å®‰å…¨æª¢æŸ¥ï¼šå¦‚æœæŠ“åˆ°çš„ç´€éŒ„ ID çœŸçš„ä¸å°ï¼Œè·³å‡ºè­¦å‘Š
      const foundId = currentRecord["_ragicId"] || currentRecord["Record ID"];
      if (foundId && foundId != recordId) {
        debug("âš ï¸ è­¦å‘Šï¼šè¼¸å…¥ ID ç‚º " + recordId + " ä½† API å›å‚³äº† ID " + foundId + "ã€‚é€™å¯èƒ½æ˜¯ Ragic çš„æ¬Šé™é™åˆ¶ã€‚");
      }

      renderData();
      $("loader").classList.add('hidden');
      $("step-1").classList.remove('hidden');
    };

    function executeLoad() {
      $("loader-text").innerText = "æ­£åœ¨è®€å–ç·¨è™Ÿ " + (recordId || "") + "...";
      $("debug-area").style.display = 'block';

      loadTimer = setTimeout(() => {
        if (!currentRecord) {
          $("loader-spinner").classList.add('hidden');
          $("loader-text").innerText = "è®€å–è¶…æ™‚ï¼Œè«‹æª¢æŸ¥ ID æ˜¯å¦æ­£ç¢º";
          $("retry-btn").classList.remove('hidden');
        }
      }, 10000);

      const script = document.createElement('script');
      script.src = `${RAGIC_BASE_URL}/${recordId}.json?api&APIKey=${encodeURIComponent(RAGIC_API_KEY)}&callback=ragicCallback`;
      document.body.appendChild(script);
    }

    function renderData() {
      $("input_name").value = getValue(currentRecord, FIELDS.name);
      $("input_id").value = getValue(currentRecord, FIELDS.id).toUpperCase();
      $("input_phone").value = getValue(currentRecord, FIELDS.phone);
      $("input_occ").value = getValue(currentRecord, FIELDS.occupation);

      $("show_addr").innerText = getValue(currentRecord, FIELDS.addr) || "-";
      const rent = getValue(currentRecord, FIELDS.rent).toString().replace(/[^\d]/g, "");
      const deposit = getValue(currentRecord, FIELDS.deposit).toString().replace(/[^\d]/g, "");
      const earnest = getValue(currentRecord, FIELDS.earnest).toString().replace(/[^\d]/g, "");

      $("show_rent").innerText = rent ? "$ " + Number(rent).toLocaleString() : "-";
      $("show_deposit").innerText = deposit ? "$ " + Number(deposit).toLocaleString() : "-";
      $("show_earnest").innerText = earnest ? "$ " + Number(earnest).toLocaleString() : "-";
      $("show_date").innerText = getValue(currentRecord, FIELDS.date) || "-";
      $("show_pay_method").innerText = getValue(currentRecord, FIELDS.pay_method) || "æœˆç¹³";
      $("show_cond").innerHTML = (getValue(currentRecord, FIELDS.conditions) || "-").replace(/\[br\]\[\/br\]/g, "<br>");
      $("show_no").innerText = getValue(currentRecord, FIELDS.no) || "ID-" + recordId;
    }

    function initSignature() {
      const canvas = $("signature-pad");
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      canvas.width = canvas.offsetWidth * ratio;
      canvas.height = canvas.offsetHeight * ratio;
      canvas.getContext("2d").scale(ratio, ratio);
      signaturePad = new SignaturePad(canvas, { minWidth: 3, maxWidth: 8, penColor: "black" });
    }

    function goStep(n) {
      $("step-1").classList.add('hidden'); $("step-2").classList.add('hidden');
      $("step-" + n).classList.remove('hidden'); window.scrollTo(0, 0);
      if (n === 2) setTimeout(initSignature, 250);
    }

    function submitData() {
      if (!signaturePad || signaturePad.isEmpty()) { alert("è«‹ç°½åï¼"); return; }
      $("hidden_signature").value = signaturePad.toDataURL("image/png");
      const form = $("ragicForm");
      form.action = `${RAGIC_BASE_URL}/${recordId}?api&APIKey=${encodeURIComponent(RAGIC_API_KEY)}`;
      $("loader").classList.remove('hidden');
      $("loader-text").innerText = "è³‡æ–™å›å‚³ä¸­...";
      form.submit();
      setTimeout(() => { $("loader").classList.add('hidden'); $("step-2").classList.add('hidden'); $("step-success").classList.remove('hidden'); }, 3000);
    }

    window.onload = () => {
      $("btn-test").onclick = () => { recordId = $("test-id-input").value.trim(); $("test-mode-ui").classList.add('hidden'); executeLoad(); };
      $("btn-next").onclick = () => goStep(2);
      $("btn-back").onclick = () => goStep(1);
      $("btn-clear").onclick = () => signaturePad.clear();
      $("btn-submit").onclick = () => submitData();
      if (!recordId) { $("loader-spinner").classList.add('hidden'); $("loader-text").innerText = "è«‹è¼¸å…¥ Record ID"; $("test-mode-ui").classList.remove('hidden'); }
      else { executeLoad(); }
    };
  </script>
</body>
</html>
