<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ä¸å‹•ç”¢è¦ç´„å®šé‡‘æ”¶æ“šç°½ç½²ç³»çµ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
  <!-- å¼•å…¥ PDF ç”¢ç”Ÿå¥—ä»¶ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
    body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
    
    .receipt-table { border-collapse: collapse; width: 100%; border: 2.5px solid #000; }
    .receipt-table th, .receipt-table td { border: 1.5px solid #000; padding: 12px; vertical-align: middle; }
    .receipt-table th { background-color: #f8fafc; font-weight: 900; width: 140px; color: #000; font-size: 1.1rem; text-align: center; }
    
    .big-btn { transition: all 0.2s; cursor: pointer; }
    .big-btn:active { transform: scale(0.96); opacity: 0.9; }
    
    #signature-pad { background: #ffffff; border: 3px dashed #3b82f6; border-radius: 20px; width: 100%; height: 320px; touch-action: none; }
    #loader { background: rgba(255, 255, 255, 0.98); z-index: 100; }
    .debug-box { background: #1a1a1a; color: #00ff00; padding: 15px; border-radius: 12px; font-size: 14px; margin-top: 20px; text-align: left; overflow-x: auto; display: none; border: 2px solid #333; }
    .grandpa-input:focus { border-color: #2563eb; box-shadow: 0 0 0 10px rgba(37, 99, 235, 0.1); background-color: #fff; }

    #pdf-export-area { width: 800px; padding: 40px; background: white; position: absolute; left: -9999px; top: 0; }
    .pdf-title { font-size: 32px; font-weight: 900; text-align: center; margin-bottom: 20px; color: #000; }
    .pdf-header-info { text-align: right; font-size: 16px; margin-bottom: 10px; }
  </style>
</head>

<body class="bg-slate-100 min-h-screen">

  <div id="loader" class="fixed inset-0 flex flex-col items-center justify-center p-6 text-center">
    <div id="loader-spinner" class="animate-spin rounded-full h-20 w-20 border-t-4 border-b-4 border-blue-600 mb-6"></div>
    <p id="loader-text" class="text-3xl font-black text-slate-800">æ­£åœ¨è®€å– Ragic è³‡æ–™...</p>

    <div id="test-mode-ui" class="hidden mt-8 bg-white p-10 rounded-[3rem] shadow-2xl max-w-sm w-full border-4 border-blue-500">
      <h2 class="text-3xl font-black text-blue-600 mb-6 text-center">æ¸¬è©¦æ¨¡å¼</h2>
      <p class="text-slate-500 mb-4 text-xl font-medium text-left">è«‹è¼¸å…¥æ­£ç¢ºçš„ Record IDï¼š</p>
      <input type="number" id="test-id-input" placeholder="3"
        class="w-full text-center text-6xl p-6 border-4 border-slate-200 rounded-3xl mb-8 outline-none font-bold bg-slate-50">
      <button id="btn-test" class="w-full bg-blue-600 text-white font-black py-7 rounded-3xl text-3xl shadow-xl big-btn">
        é–‹å§‹è¼‰å…¥
      </button>
    </div>

    <div id="debug-area" class="debug-box w-full max-w-lg">
      <p class="text-white font-bold mb-2">ã€é€£ç·šè¨ºæ–·ã€‘</p>
      <div id="debug-content" class="font-mono">ç­‰å¾…é€£ç·šä¸­...</div>
    </div>

    <button id="retry-btn" onclick="location.reload()" class="hidden mt-8 bg-slate-800 text-white px-10 py-4 rounded-2xl font-black text-xl">
      é‡æ–°è¼‰å…¥
    </button>
  </div>

  <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;"></iframe>

  <div class="max-w-3xl mx-auto p-4 md:p-8">
    <!-- ç¬¬ä¸€æ­¥ï¼šæ ¸å°è³‡æ–™ -->
    <div id="step-1" class="hidden bg-white rounded-[3rem] shadow-2xl p-8 md:p-14 border-t-[16px] border-blue-600">
      <h1 class="text-5xl font-black text-blue-700 mb-6 text-center md:text-left">è«‹æ ¸å°æˆ¿å®¢è³‡æ–™</h1>
      <p class="text-slate-500 mb-12 text-2xl font-medium text-center md:text-left">æˆ¿å®¢æ‚¨å¥½ï¼Œè³‡æ–™è‹¥æœ‰èª¤å¯ç›´æ¥ä¿®æ”¹ã€‚</p>
      <form id="ragicForm" method="POST" target="hidden_iframe" class="space-y-10">
        <div>
          <label class="block text-3xl font-black text-slate-700 mb-4">æˆ¿å®¢å§“å</label>
          <input type="text" name="1001091" id="input_name" class="grandpa-input w-full text-4xl border-4 border-slate-200 rounded-3xl p-6 outline-none font-bold bg-yellow-50 shadow-inner">
        </div>
        <div>
          <label class="block text-3xl font-black text-slate-700 mb-4">èº«åˆ†è­‰å­—è™Ÿ</label>
          <input type="text" name="1001092" id="input_id" class="grandpa-input w-full text-4xl border-4 border-slate-200 rounded-3xl p-6 outline-none font-bold uppercase bg-yellow-50 shadow-inner">
        </div>
        <div>
          <label class="block text-3xl font-black text-slate-700 mb-4">è¯çµ¡é›»è©±</label>
          <input type="tel" name="1001093" id="input_phone" class="grandpa-input w-full text-4xl border-4 border-slate-200 rounded-3xl p-6 outline-none font-bold">
        </div>
        <div>
          <label class="block text-3xl font-black text-slate-700 mb-4">æˆ¿å®¢è·æ¥­</label>
          <input type="text" name="1001094" id="input_occ" class="grandpa-input w-full text-4xl border-4 border-slate-200 rounded-3xl p-6 outline-none font-bold">
        </div>
        <input type="hidden" name="1001110" id="hidden_signature">
      </form>
      <button id="btn-next" class="big-btn w-full mt-14 bg-blue-600 hover:bg-blue-700 text-white text-4xl font-black py-9 rounded-[2.5rem] shadow-2xl">è³‡æ–™æ­£ç¢ºï¼Œä¸‹ä¸€é  ğŸ‘‰</button>
    </div>

    <!-- ç¬¬äºŒæ­¥ï¼šé è¦½æ”¶æ“š -->
    <div id="step-2" class="hidden bg-white rounded-[3rem] shadow-2xl p-4 md:p-10 border-t-[16px] border-green-600">
      <div id="receipt-preview-container">
        <h1 class="text-3xl font-black text-center mb-4 text-slate-900">ä¸å‹•ç”¢è¦ç´„å®šé‡‘æ”¶æ“š</h1>
        <div class="text-right mb-2 font-bold text-slate-600">ç·¨è™Ÿï¼š<span id="show_no">-</span></div>
        <table class="receipt-table mb-8">
          <tr><th>æˆ¿å±‹åœ°å€</th><td colspan="3" id="show_addr" class="font-bold text-lg">-</td></tr>
          <tr><th>ç§Ÿé‡‘</th><td colspan="3" class="font-bold">ç¨…é‡‘ï¼š<span id="show_tax">-</span><br><span id="show_rent" class="text-2xl font-black text-blue-700">-</span></td></tr>
          <tr><th>æŠ¼é‡‘<br><br>ç§ŸæœŸ</th><td><span id="show_deposit" class="font-bold text-xl">-</span><br><br>ç®¡ç†è²»ï¼š<span id="show_mgmt">-</span><br><small class="text-slate-400">â€»å¯¦éš›é‡‘é¡ä¾ç®¡å§”æœƒè¦å®šç¹³ç´</small><br><br><span id="show_period" class="font-bold">-</span></td><th>è»Šä½</th><td id="show_parking">-</td></tr>
          <tr><th>ä»˜æ¬¾æ–¹å¼</th><td id="show_pay_method" class="font-bold">-</td><td colspan="2" class="bg-slate-50 text-center italic text-slate-400">æœˆç¹³</td></tr>
          <tr><th>è¦ç´„æ¢ä»¶</th><td colspan="3" id="show_cond" class="text-sm h-32 align-top leading-relaxed">-</td></tr>
          <tr><th>è¦ç´„å®šé‡‘</th><td><span id="show_earnest" class="text-red-600 font-black text-3xl">-</span></td><th>ç°½ç´„<br><br>èµ·ç§Ÿ</th><td><span id="show_sign_date">-</span><br><br><span id="show_start_date">-</span></td></tr>
          <tr><th>ä»˜æ¬¾æ–¹å¼</th><td colspan="3">åŒ¯æ¬¾å¾Œäº”ç¢¼ï¼š<span id="show_remit">-</span></td></tr>
        </table>
        <div class="bg-slate-50 p-4 rounded-xl text-xs text-slate-500 leading-tight mb-8">ç°½ç´„è«‹æ”œå¸¶ï¼šå®šé‡‘æ”¶æ“šã€æŠ¼ç§Ÿé‡‘ã€æœå‹™è²»å°¾æ¬¾ã€å°ç« ã€é›™è­‰ä»¶å½±æœ¬3ä»½ã€‚</div>
        <div class="flex justify-between items-end px-4 mb-6 text-sm md:text-base">
            <div class="space-y-2"><p class="font-bold">æˆ¿å®¢ï¼š<span id="show_final_name" class="underline px-2">-</span></p><p>é›»è©±ï¼š<span id="show_final_phone">-</span></p><p>è·æ¥­ï¼š<span id="show_final_occ">-</span></p></div>
            <div class="text-right space-y-2"><p class="font-bold">ç¶“è¾¦äººå“¡ï¼š<span id="show_agent">-</span></p><p>é›»è©±ï¼š<span id="show_agent_phone">-</span></p></div>
        </div>
      </div>
      <div class="border-t-2 pt-6 mb-8 text-xs text-slate-600"><p class="font-black text-base mb-2 text-slate-800">é‡è¦ç´„å®šï¼š</p>
          <ul class="space-y-1 list-decimal pl-4"><li>ä¸Šè¿°æ¢ä»¶ç”±æˆ¿å®¢ç¢ºèªç„¡èª¤ï¼Œä»˜å®šé‡‘å¾Œæˆç«‹è¦ç´„ã€‚</li><li>å¦‚æˆ¿æ±ä¸åŒæ„ä¸Šè¿°æ¢ä»¶ï¼Œå‰‡å®šé‡‘ç„¡æ¯å…¨é¡é€€é‚„æ–¼æˆ¿å®¢ã€‚</li><li>å¦‚æˆ¿æ±åŒæ„ä¸Šè¿°æ¢ä»¶ï¼Œä½†å› å¦æœ‰è€ƒé‡å› ç´ å°è‡´ç„¡æ³•ç°½ç´„ï¼Œå‰‡å®šé‡‘ç„¡æ¯å…¨æ•¸é€€é‚„ã€‚</li><li>å¦‚æˆ¿æ±åŒæ„ä¸Šè¿°æ¢ä»¶ï¼Œä½†æˆ¿å®¢å› æ•…åæ‚”ä¸ç§Ÿæˆ–è¶…éç°½ç´„æ—¥ä»ä¸ç°½ç´„ï¼Œå®šé‡‘ä¸äºˆé€€é‚„ã€‚</li><li>è¦ç´„æˆç«‹ä¸¦ç°½ç´„å®Œæˆï¼Œæˆ¿å®¢éœ€æ”¯ä»˜æœ¬å…¬å¸ç°½ç´„é‡‘é¡ä¹‹ 50% ä½œç‚ºæœå‹™è²»ã€‚</li></ul>
      </div>
      <div class="mb-10 text-center">
        <label class="block text-4xl font-black text-slate-800 mb-8 underline decoration-blue-500 decoration-8 underline-offset-[16px]">æˆ¿å®¢ç°½åè™•</label>
        <div class="relative"><canvas id="signature-pad"></canvas><button id="btn-clear" class="absolute top-4 right-4 bg-slate-100 text-slate-600 px-6 py-3 rounded-xl font-black text-sm shadow">æ¸…é™¤</button></div>
      </div>
      <div class="flex flex-col md:flex-row gap-6 mt-12">
        <button id="btn-back" class="order-2 md:order-1 flex-1 bg-slate-200 text-slate-500 text-3xl font-black py-7 rounded-3xl">å›ä¸Šä¸€æ­¥</button>
        <button id="btn-submit" class="order-1 md:order-2 big-btn flex-[2] bg-emerald-600 hover:bg-emerald-700 text-white text-4xl font-black py-7 rounded-3xl shadow-2xl">ç°½å¥½äº† âœ…</button>
      </div>
    </div>

    <!-- ç¬¬ä¸‰æ­¥ï¼šæˆåŠŸèˆ‡ä¸‹è¼‰ -->
    <div id="step-success" class="hidden bg-white rounded-[3rem] shadow-2xl p-10 md:p-20 text-center border-t-[16px] border-emerald-500">
      <div class="text-[120px] mb-8">âœ…</div>
      <h1 class="text-5xl font-black text-emerald-600 mb-6">ç°½ç½²å®Œæˆï¼</h1>
      <p class="text-slate-500 text-2xl mb-12">è³‡æ–™å·²æˆåŠŸå‚³å›ã€‚<br>æ‚¨å¯ä»¥é»æ“Šä¸‹æ–¹æŒ‰éˆ•å­˜æª”æ”¶æ“šã€‚</p>
      <button onclick="downloadReceiptPDF()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-black py-8 rounded-[2rem] text-3xl shadow-xl big-btn flex items-center justify-center gap-4 mb-6">ğŸ“¥ ä¸‹è¼‰æ”¶æ“š PDF</button>
      <p class="text-slate-400 text-lg italic">æç¤ºï¼šä¸‹è¼‰å¾Œå¯é»æ“Šæ‰‹æ©Ÿä¸Šæ–¹çš„ä¸‹è¼‰ç®¡ç†é–‹å•Ÿ</p>
    </div>
  </div>

  <!-- PDF ç”Ÿæˆå€åŸŸ -->
  <div id="pdf-export-area">
      <div class="pdf-header-info" id="pdf_no">ç·¨è™Ÿï¼š-</div>
      <div class="pdf-title">ä¸å‹•ç”¢è¦ç´„å®šé‡‘æ”¶æ“š</div>
      <table class="receipt-table" style="font-size: 18px;">
          <tr><th style="height: 60px;">æˆ¿å±‹åœ°å€</th><td colspan="3" id="pdf_addr" style="padding-left: 20px;">-</td></tr>
          <tr><th style="height: 100px;">ç§Ÿé‡‘</th><td colspan="3" style="padding-left: 20px;">ç¨…é‡‘ï¼š<span id="pdf_tax">-</span><br><span id="pdf_rent" style="font-size: 28px; font-weight: 900;">-</span></td></tr>
          <tr><th style="height: 150px;">æŠ¼é‡‘<br><br>ç§ŸæœŸ</th><td style="padding-left: 20px; width: 350px;"><span id="pdf_deposit" style="font-size: 24px; font-weight: bold;">-</span><br><br>ç®¡ç†è²»ï¼š<span id="pdf_mgmt">-</span><br><span style="font-size: 14px; color: #666;">â€»å¯¦éš›é‡‘é¡ä¾ç®¡å§”æœƒè¦å®šç¹³ç´</span><br><br><span id="pdf_period" style="font-weight: bold;">-</span></td><th style="width: 120px;">è»Šä½</th><td id="pdf_parking" style="text-align: center;">-</td></tr>
          <tr><th style="height: 60px;">ä»˜æ¬¾æ–¹å¼</th><td style="text-align: center; font-weight: bold;">æœˆç¹³</td><td colspan="2" style="background: #eee;"></td></tr>
          <tr><th style="height: 180px;">è¦ç´„æ¢ä»¶</th><td colspan="3" id="pdf_cond" style="padding: 20px; vertical-align: top; font-size: 16px; line-height: 1.6;">-</td></tr>
          <tr><th style="height: 120px;">è¦ç´„å®šé‡‘</th><td style="padding-left: 20px;"><span id="pdf_earnest" style="font-size: 32px; font-weight: 900; color: #d00;">-</span></td><th style="width: 120px;">ç°½ç´„<br><br>èµ·ç§Ÿ</th><td style="text-align: center;"><span id="pdf_sign_date">-</span><br><br><span id="pdf_start_date">-</span></td></tr>
          <tr><th style="height: 60px;">ä»˜æ¬¾æ–¹å¼</th><td colspan="3" style="padding-left: 20px;">åŒ¯æ¬¾å¾Œäº”ç¢¼ï¼š<span id="pdf_remit">-</span></td></tr>
      </table>
      <div style="display: flex; justify-content: space-between; margin-top: 40px; padding: 0 20px;">
          <div><p style="font-size: 20px; font-weight: bold; margin-bottom: 30px;">æˆ¿å®¢ï¼š<img id="pdf_signature_img" style="display: inline-block; vertical-align: middle; max-height: 80px;"></p><p>é›»è©±ï¼š<span id="pdf_phone">-</span></p><p>è·æ¥­ï¼š<span id="pdf_occ">-</span></p></div>
          <div style="text-align: right;"><p style="font-size: 20px; font-weight: bold; margin-bottom: 30px;">ç¶“è¾¦äººå“¡ï¼š<span id="pdf_agent">-</span></p><p>é›»è©±ï¼š<span id="pdf_agent_phone">-</span></p></div>
      </div>
  </div>

  <script>
    const RAGIC_API_KEY = "VEZsOEwzYzVJdWdoWXRDM3ptS2YwRUhIcG1iMjI0S2hXT2VieXpCc0p4M21pY29JTnRvL1pueThPTzNVcktWNQ==";
    const RAGIC_BASE_URL = "https://ap15.ragic.com/wuohome/payments/1";

    const FIELDS = {
      name: ["ç§Ÿå®¢å§“å", "1001091"], id: ["ç§Ÿå®¢èº«åˆ†è­‰å­—è™Ÿ", "1001092"], phone: ["ç§Ÿå®¢é›»è©±", "1001093"], occupation: ["ç§Ÿå®¢è·æ¥­", "1001094"],
      addr: ["åœ°å€", "1001099"], rent: ["ç§Ÿé‡‘", "1001101"], tax: ["ç§Ÿé‡‘å…§å«ç¨…é‡‘", "1001102"], deposit: ["æŠ¼é‡‘", "1001107"],
      mgmt: ["ç§Ÿé‡‘å…§å«ç®¡ç†è²»", "1001103"], period: ["ç§ŸæœŸ", "1001100"], parking: ["è»Šä½ç·¨è™Ÿ", "1001115"], pay_method: ["ä»˜æ¬¾æ–¹å¼", "1001112"],
      conditions: ["è¦ç´„æ¢ä»¶", "1001108"], earnest: ["è¦ç´„å®šé‡‘", "1001109"], no: ["å®šé‡‘å–®ç·¨è™Ÿ", "1001111"],
      sign_date: ["ç°½ç´„æ—¥", "1000833"], start_date: ["èµ·ç§Ÿæ—¥", "1000834"], remit: ["åŒ¯æ¬¾å¾Œäº”ç¢¼", "1000836"],
      agent: ["ç¶“è¾¦äººå“¡", "1000838"], agent_phone: ["ç¶“è¾¦é›»è©±", "1000839"], signature: ["ç§Ÿå®¢ç°½å", "1001110"]
    };

    let currentRecord = null;
    let recordId = new URLSearchParams(window.location.search).get('id');
    let signaturePad = null;
    let loadTimer = null;

    const $ = (id) => document.getElementById(id);

    function getValue(rec, keys) {
      for (let k of keys) { if (rec[k] !== undefined && rec[k] !== null && rec[k] !== "") return rec[k]; }
      return "";
    }

    function formatCurrency(val) {
        if (!val) return "$ 0";
        const digits = String(val).replace(/[^\d]/g, "");
        return "$ " + Number(digits).toLocaleString("zh-TW");
    }

    // ç²¾æº–åŒ¹é…é‚è¼¯ï¼šé¿å…ä¸€ç›´æŠ“åˆ° ID 3
    function findExactRecord(obj, targetId) {
      if (!obj || typeof obj !== 'object') return null;
      if (obj[targetId]) return obj[targetId]; // å„ªå…ˆæ‰¾ Key ç‚º ID çš„
      if (obj["_ragicId"] == targetId || obj["Record ID"] == targetId) return obj;
      for (const k in obj) {
        if (typeof obj[k] === 'object') {
          const res = findExactRecord(obj[k], targetId);
          if (res) return res;
        }
      }
      return null;
    }

    window.ragicCallback = function (data) {
      clearTimeout(loadTimer);
      $("debug-area").style.display = 'block';
      $("debug-content").innerText = "å·²æ¥æ”¶ Ragic å›å‚³è³‡æ–™ï¼Œæ­£åœ¨åŒ¹é… ID: " + recordId;

      currentRecord = findExactRecord(data, recordId);
      
      if (!currentRecord) {
        // å¦‚æœç²¾æº–æ‰¾ä¸åˆ°ï¼Œæ‰å˜—è©¦å°‹æ‰¾å›å‚³è³‡æ–™ä¸­çš„ç¬¬ä¸€å€‹æœ‰æ•ˆç‰©ä»¶
        for(let k in data) {
          if(data[k] && data[k]["ç§Ÿå®¢å§“å"]) { currentRecord = data[k]; break; }
        }
      }

      if (!currentRecord) {
        $("loader-text").innerText = "æ‰¾ä¸åˆ°ç·¨è™Ÿ " + recordId + " çš„è³‡æ–™";
        return;
      }
      renderData();
      $("loader").classList.add('hidden');
      $("step-1").classList.remove('hidden');
    };

    function executeLoad() {
      $("loader-text").innerText = "æ­£åœ¨é–‹å•Ÿå®šé‡‘å–® " + (recordId || "") + "...";
      loadTimer = setTimeout(() => { if (!currentRecord) $("loader-text").innerText = "é€£ç·šè¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç·¨è™Ÿ"; }, 10000);
      const script = document.createElement('script');
      script.src = `${RAGIC_BASE_URL}/${recordId}.json?api&APIKey=${encodeURIComponent(RAGIC_API_KEY)}&callback=ragicCallback`;
      document.body.appendChild(script);
    }

    function renderData() {
      $("input_name").value = getValue(currentRecord, FIELDS.name);
      $("input_id").value = getValue(currentRecord, FIELDS.id).toUpperCase();
      $("input_phone").value = getValue(currentRecord, FIELDS.phone);
      $("input_occ").value = getValue(currentRecord, FIELDS.occupation);

      const mapping = [
          { s: "show_no", p: "pdf_no", v: getValue(currentRecord, FIELDS.no) },
          { s: "show_addr", p: "pdf_addr", v: getValue(currentRecord, FIELDS.addr) },
          { s: "show_tax", p: "pdf_tax", v: getValue(currentRecord, FIELDS.tax) || "æœªç¨…" },
          { s: "show_rent", p: "pdf_rent", v: formatCurrency(getValue(currentRecord, FIELDS.rent)) },
          { s: "show_deposit", p: "pdf_deposit", v: formatCurrency(getValue(currentRecord, FIELDS.deposit)) },
          { s: "show_mgmt", p: "pdf_mgmt", v: getValue(currentRecord, FIELDS.mgmt) || "ç„¡ç®¡ç†è²»" },
          { s: "show_period", p: "pdf_period", v: getValue(currentRecord, FIELDS.period) || "ä¸€å¹´" },
          { s: "show_parking", p: "pdf_parking", v: getValue(currentRecord, FIELDS.parking) || "ç„¡è»Šä½" },
          { s: "show_pay_method", v: getValue(currentRecord, FIELDS.pay_method) || "æœˆç¹³" },
          { s: "show_earnest", p: "pdf_earnest", v: formatCurrency(getValue(currentRecord, FIELDS.earnest)) },
          { s: "show_sign_date", p: "pdf_sign_date", v: getValue(currentRecord, FIELDS.sign_date) },
          { s: "show_start_date", p: "pdf_start_date", v: getValue(currentRecord, FIELDS.start_date) },
          { s: "show_remit", p: "pdf_remit", v: getValue(currentRecord, FIELDS.remit) },
          { s: "show_agent", p: "pdf_agent", v: getValue(currentRecord, FIELDS.agent) },
          { s: "show_agent_phone", p: "pdf_agent_phone", v: getValue(currentRecord, FIELDS.agent_phone) },
          { s: "show_final_phone", p: "pdf_phone", v: getValue(currentRecord, FIELDS.phone) },
          { s: "show_final_occ", p: "pdf_occ", v: getValue(currentRecord, FIELDS.occupation) }
      ];
      mapping.forEach(m => { if(m.s) $(m.s).innerText = m.v; if(m.p) $(m.p).innerText = m.v; });
      const cond = (getValue(currentRecord, FIELDS.conditions) || "-").replace(/\[br\]\[\/br\]/g, "<br>");
      $("show_cond").innerHTML = cond; $("pdf_cond").innerHTML = cond; $("show_final_name").innerText = getValue(currentRecord, FIELDS.name);
    }

    function initSignature() {
      const canvas = $("signature-pad"); const ratio = Math.max(window.devicePixelRatio || 1, 1);
      canvas.width = canvas.offsetWidth * ratio; canvas.height = canvas.offsetHeight * ratio;
      canvas.getContext("2d").scale(ratio, ratio);
      signaturePad = new SignaturePad(canvas, { minWidth: 3, maxWidth: 8, penColor: "black" });
    }

    function goStep(n) {
      $("step-1").classList.add('hidden'); $("step-2").classList.add('hidden');
      $("step-" + n).classList.remove('hidden'); window.scrollTo(0, 0);
      if (n === 2) setTimeout(initSignature, 250);
    }

    async function downloadReceiptPDF() {
        const btn = event.currentTarget; btn.innerText = "æ­£åœ¨ç”¢ç”Ÿ PDF..."; btn.disabled = true;
        try {
            const element = $("pdf-export-area");
            const canvas = await html2canvas(element, { scale: 2, useCORS: true });
            const { jsPDF } = window.jspdf; const pdf = new jsPDF('p', 'mm', 'a4');
            const imgWidth = pdf.internal.pageSize.getWidth();
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, imgWidth, imgHeight);
            pdf.save(`å®šé‡‘æ”¶æ“š_${getValue(currentRecord, FIELDS.name)}.pdf`);
        } catch (err) { alert("ç”¢ç”Ÿå¤±æ•—ï¼Œè«‹å…ˆæˆªåœ–å­˜æª”ã€‚"); } finally { btn.innerText = "ğŸ“¥ ä¸‹è¼‰æ”¶æ“š PDF"; btn.disabled = false; }
    }

    function submitData() {
      if (!signaturePad || signaturePad.isEmpty()) { alert("è«‹ç°½åï¼"); return; }
      const sigData = signaturePad.toDataURL("image/png");
      $("hidden_signature").value = sigData; $("pdf_signature_img").src = sigData;
      const form = $("ragicForm"); form.action = `${RAGIC_BASE_URL}/${recordId}?api&APIKey=${encodeURIComponent(RAGIC_API_KEY)}`;
      $("loader").classList.remove('hidden'); $("loader-text").innerText = "è³‡æ–™å­˜æª”ä¸­..."; form.submit();
      setTimeout(() => { $("loader").classList.add('hidden'); $("step-2").classList.add('hidden'); $("step-success").classList.remove('hidden'); window.scrollTo(0, 0); }, 3000);
    }

    window.onload = () => {
      $("btn-test").onclick = () => { recordId = $("test-id-input").value.trim(); $("test-mode-ui").classList.add('hidden'); executeLoad(); };
      $("btn-next").onclick = () => goStep(2); $("btn-back").onclick = () => goStep(1);
      $("btn-clear").onclick = () => signaturePad.clear(); $("btn-submit").onclick = () => submitData();
      if (!recordId) { $("loader-spinner").classList.add('hidden'); $("loader-text").innerText = "è«‹è¼¸å…¥ Record ID"; $("test-mode-ui").classList.remove('hidden'); }
      else { executeLoad(); }
    };
  </script>
</body>
</html>
