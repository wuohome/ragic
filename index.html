<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ragic 房產導航 - 寫入診斷專家</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #map { height: 100vh; width: 100%; }
        .custom-info-window { padding: 10px; max-width: 250px; font-family: 'PingFang TC', sans-serif; }
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); display: flex;
            justify-content: center; align-items: center; z-index: 9999;
            flex-direction: column;
        }
        #settings-panel {
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(100%);
        }
        #settings-panel.open { transform: translateX(0); }
        .sync-log { font-family: monospace; font-size: 12px; background: #2d3748; color: #fff; padding: 15px; border-radius: 8px; max-height: 300px; overflow-y: auto; line-height: 1.5; white-space: pre-wrap; word-break: break-all; border: 1px solid #4a5568; }
        .diagnostic-card { font-size: 11px; padding: 10px; border-radius: 8px; margin-bottom: 8px; border-left-width: 4px; }
        .card-ok { background: #f0fdf4; border-color: #22c55e; color: #166534; }
        .card-need { background: #fffbeb; border-color: #eab308; color: #854d0e; }
        .status-badge { padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 10px; }
    </style>
</head>
<body class="bg-gray-50 overflow-hidden">

    <div id="loading" class="loading-overlay">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-blue-600"></div>
        <p id="status-text" class="mt-4 text-gray-700 font-bold tracking-widest text-lg">系統啟動中...</p>
    </div>

    <div id="map"></div>

    <div class="fixed top-5 right-5 flex flex-col gap-4">
        <button onclick="fetchData()" class="bg-blue-600 p-4 rounded-full shadow-2xl hover:bg-blue-700 transition transform hover:scale-110 active:scale-95 text-white">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
        </button>
        <button onclick="toggleSettings()" class="bg-red-600 p-4 rounded-full shadow-2xl hover:bg-red-700 transition transform hover:scale-110 active:scale-95 text-white border border-red-400 animate-pulse">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
            </svg>
        </button>
    </div>

    <div id="settings-panel" class="fixed top-0 right-0 h-full w-96 bg-white shadow-2xl z-50 p-7 overflow-y-auto border-l">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-2xl font-black text-gray-800">寫入診斷室</h2>
            <button onclick="toggleSettings()" class="text-gray-400 hover:text-red-500 transition text-2xl">✕</button>
        </div>
        
        <div class="space-y-8">
            <section class="bg-red-50 p-6 rounded-3xl border-2 border-red-100 shadow-sm">
                <h3 class="text-lg font-bold mb-3 text-red-700 flex items-center gap-2">
                    <span class="bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs">!</span>
                    單筆測試模式
                </h3>
                <p class="text-xs text-red-600 mb-4 leading-relaxed">
                    系統將嘗試寫入「第一筆」缺座標的資料，並把 Ragic 的完整回應顯示出來。請務必截圖回傳顯示的內容。
                </p>
                <button id="btn-sync" onclick="testSyncOneRecord()" class="w-full bg-red-600 text-white font-black py-4 rounded-2xl hover:bg-red-700 transition shadow-lg active:scale-95">
                    診斷寫入失敗原因
                </button>
            </section>

            <section id="sync-log-section" class="hidden">
                <h3 class="text-xs font-black text-gray-400 uppercase mb-3 tracking-widest">診斷日誌 (Raw Response)</h3>
                <div id="sync-log" class="sync-log">等待測試...</div>
            </section>

            <section>
                <h3 class="text-xs font-black text-gray-400 uppercase mb-4 tracking-widest border-b pb-2">房產資料清單</h3>
                <div id="diagnostics-list" class="space-y-2"></div>
            </section>
        </div>
    </div>

    <script>
        // EID 設定
        const EID_TITLE  = "1000050"; 
        const EID_ADDR   = "1000055"; 
        const EID_COORD  = "1000759"; 
        const EID_PRICE  = "1000076"; 
        const EID_STATUS = "1000707"; 

        const MAPS_KEY = "AIzaSyALdVJlv7IBxnqeShEbzIIWnV7WSjtRtZw";
        const RAGIC_KEY = "Nm5QVzFtZ1pGYzZIT1REUnBhY3A0bDVKY0luaEh3d2lrSmMzTHNSVjh3N1VHc1JadWJjQk9yZDQ3UlpZZnFubQ==";
        const API_URL = "https://ap15.ragic.com/wuohome/property-data-kept/10";

        let map, geocoder;
        let markers = [];
        let fetchedRecords = [];

        window.onload = () => {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${MAPS_KEY}&callback=initMap`;
            script.async = true;
            document.head.appendChild(script);
        };

        function toggleSettings() {
            document.getElementById('settings-panel').classList.toggle('open');
        }

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 13, center: { lat: 25.0330, lng: 121.5654 },
                styles: [{ "featureType": "poi", "stylers": [{ "visibility": "off" }] }]
            });
            geocoder = new google.maps.Geocoder();
            fetchData();
        }

        async function fetchData() {
            const loading = document.getElementById('loading');
            const diagnosticsList = document.getElementById('diagnostics-list');
            loading.style.display = 'flex';
            diagnosticsList.innerHTML = "";
            markers.forEach(m => m.setMap(null));
            markers = [];

            try {
                // 使用 v=3 和 EID 模式讀取
                const ts = new Date().getTime();
                const resp = await fetch(`${API_URL}?api&v=3&naming=EID&t=${ts}`, {
                    headers: { "Authorization": "Basic " + btoa(RAGIC_KEY + ":") }
                });
                const data = await resp.json();
                fetchedRecords = Object.entries(data).map(([id, val]) => ({ id, ...val }));
                
                let bounds = new google.maps.LatLngBounds();
                let readyCount = 0;

                fetchedRecords.forEach(item => {
                    const coord = item[EID_COORD];
                    const name = item[EID_TITLE] || "無名";
                    
                    if (coord && coord.toString().includes(',') && !isNaN(parseFloat(coord.split(',')[0]))) {
                        const [lat, lng] = coord.split(',').map(s => parseFloat(s.trim()));
                        addMarker(lat, lng, item);
                        bounds.extend({ lat, lng });
                        readyCount++;
                        diagnosticsList.innerHTML += `<div class="diagnostic-card card-ok"><b>${name}</b><br>座標: ${coord}</div>`;
                    } else {
                        diagnosticsList.innerHTML += `<div class="diagnostic-card card-need"><b>${name}</b><br>狀態: 等待寫入</div>`;
                    }
                });

                if (readyCount > 0) {
                    map.fitBounds(bounds);
                    setTimeout(() => loading.style.display = 'none', 800);
                } else {
                    loading.style.display = 'none';
                    toggleSettings();
                }
            } catch (err) {
                alert("讀取失敗：" + err);
            }
        }

        async function testSyncOneRecord() {
            const btn = document.getElementById('btn-sync');
            const logDiv = document.getElementById('sync-log');
            btn.disabled = true;
            document.getElementById('sync-log-section').classList.remove('hidden');
            logDiv.innerHTML = ">>> 啟動診斷...\n";

            // 找第一筆沒有座標的資料
            const target = fetchedRecords.find(i => {
                const c = i[EID_COORD];
                return !c || !c.toString().includes(',') || isNaN(parseFloat(c.split(',')[0]));
            });

            if (!target) {
                logDiv.innerHTML += "所有資料似乎都已有座標了。請檢查 Ragic 介面。\n";
                alert("沒有需要同步的資料。");
                btn.disabled = false;
                return;
            }

            const address = target[EID_ADDR];
            const recordId = target.id;
            const name = target[EID_TITLE] || recordId;

            if (!address) {
                logDiv.innerHTML += `錯誤：選中的資料 (${name}) 沒有地址，無法測試。\n`;
                btn.disabled = false;
                return;
            }

            try {
                logDiv.innerHTML += `目標資料：${name} (ID: ${recordId})\n`;
                logDiv.innerHTML += `解析地址：${address}...\n`;
                
                const result = await new Promise((res, rej) => {
                    geocoder.geocode({ address }, (r, s) => s === 'OK' ? res(r[0]) : rej(s));
                });
                
                const lat = result.geometry.location.lat();
                const lng = result.geometry.location.lng();
                const coordStr = `${lat},${lng}`;
                logDiv.innerHTML += `取得座標：${coordStr}\n`;
                logDiv.innerHTML += `--------------------------------\n`;
                logDiv.innerHTML += `正在發送寫入請求 (Standard Form Data)...\n`;

                // 構建標準表單數據
                const formData = new URLSearchParams();
                formData.append(EID_COORD, coordStr);

                const updateResp = await fetch(`${API_URL}/${recordId}?api&v=3`, {
                    method: 'POST',
                    headers: { 
                        "Authorization": "Basic " + btoa(RAGIC_KEY + ":"),
                        "Content-Type": "application/x-www-form-urlencoded" // 這是 Ragic 最標準的格式
                    },
                    body: formData.toString()
                });

                const respText = await updateResp.text();
                
                logDiv.innerHTML += `HTTP 狀態碼: ${updateResp.status}\n`;
                logDiv.innerHTML += `Ragic 回應內容:\n${respText}\n`;
                logDiv.innerHTML += `--------------------------------\n`;

                if (respText.includes('"status":"SUCCESS"')) {
                    logDiv.innerHTML += `✅ 診斷結果：寫入成功！\n`;
                    logDiv.innerHTML += `如果 Ragic 仍無資料，請檢查該欄位是否被鎖定(Lock)或權限不足。\n`;
                    alert("測試顯示成功！請去 Ragic 檢查該筆資料是否更新。");
                } else {
                    logDiv.innerHTML += `❌ 診斷結果：寫入被拒絕。\n`;
                    logDiv.innerHTML += `請查看上方 "msg" 欄位的錯誤訊息。\n`;
                    alert("寫入失敗，請查看黑色日誌中的錯誤原因。");
                }

            } catch (e) {
                logDiv.innerHTML += `發生程式錯誤: ${e}\n`;
            }
            btn.disabled = false;
        }

        function addMarker(lat, lng, item) {
            const marker = new google.maps.Marker({
                position: { lat, lng }, map: map, animation: google.maps.Animation.DROP,
                icon: { url: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png' }
            });
            const info = new google.maps.InfoWindow({
                content: `<div class="custom-info-window"><b>${item[EID_TITLE]}</b><br>${item[EID_ADDR]}</div>`
            });
            marker.addListener("click", () => info.open(map, marker));
            markers.push(marker);
        }
    </script>
</body>
</html>