<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>窩的家 - 智慧找房地圖</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { display: flex; height: 100vh; overflow: hidden; font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background-color: #f3f4f6; }
        #sidebar { width: 380px; background: #fff; box-shadow: 2px 0 10px rgba(0,0,0,0.05); z-index: 20; display: flex; flex-direction: column; transition: transform 0.3s ease; }
        #map-container { flex: 1; position: relative; }
        #map { height: 100%; width: 100%; }
        
        .property-card { padding: 16px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: all 0.2s; background: #fff; position: relative; }
        .property-card:hover { background: #f9fafb; padding-left: 20px; }
        .property-card.active { background: #eff6ff; border-left: 4px solid #2563eb; padding-left: 16px; }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px; }
        .card-title { font-weight: bold; font-size: 16px; color: #1f2937; line-height: 1.4; flex: 1; }
        .card-details { display: flex; align-items: center; gap: 10px; font-size: 13px; color: #4b5563; margin-bottom: 8px; flex-wrap: wrap; }
        .tag { background: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-size: 12px; }
        .tag-shop { background: #fee2e2; color: #991b1b; }
        .card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; }
        .card-price { color: #dc2626; font-weight: bold; font-size: 18px; }
        .price-unit { font-size: 12px; color: #6b7280; font-weight: normal; }
        .btn-591 { display: inline-flex; align-items: center; gap: 4px; background-color: #ff8c00; color: white; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: bold; text-decoration: none; transition: background 0.2s; }
        .btn-591:hover { background-color: #e07b00; }
        .btn-hidden { display: none; }
        
        /* 聯絡人按鈕樣式 */
        .agent-btn { 
            display: inline-flex; align-items: center; gap: 4px; 
            background-color: #10b981; color: white; 
            padding: 4px 8px; border-radius: 9999px; 
            font-size: 12px; font-weight: 500; 
            text-decoration: none; transition: background 0.2s; 
            margin-right: 4px; margin-bottom: 4px;
        }
        .agent-btn:hover { background-color: #059669; }
        
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); display: flex; justify-content: center; align-items: center; z-index: 9999; flex-direction: column; }
        
        #sync-progress-bar { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(31, 41, 55, 0.95); color: white; padding: 12px 24px; rounded: 9999px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 10000; display: none; align-items: center; gap: 12px; border-radius: 50px; font-size: 14px; font-weight: 500; white-space: nowrap; }
        
        /* 同步日誌視窗樣式 */
        #sync-log-modal {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 500px; background: white; border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 10001; flex-direction: column;
            max-height: 80vh; overflow: hidden;
        }
        #sync-log-header { padding: 16px; background: #f3f4f6; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        #sync-log-body { padding: 16px; overflow-y: auto; flex: 1; font-size: 13px; }
        #sync-log-footer { padding: 12px 16px; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; }
        .log-item { margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #f0f0f0; }
        .log-success { color: #059669; }
        .log-error { color: #dc2626; }
        .log-warn { color: #d97706; }

        .filter-section { padding: 12px 16px; background: white; border-bottom: 1px solid #e5e7eb; }
        .search-input { width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; background-color: #f9fafb; outline: none; transition: border-color 0.2s; }
        .search-input:focus { border-color: #2563eb; background-color: white; }
        .filter-row { display: flex; gap: 8px; margin-top: 8px; }
        .filter-select { flex: 1; padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; background-color: white; outline: none; cursor: pointer; }

        /* 數據統計儀表板 */
        .stats-dashboard {
            display: flex; justify-content: space-between; background: #f0f9ff; padding: 10px 16px; border-bottom: 1px solid #bfdbfe; font-size: 12px; color: #1e3a8a;
        }
        .stat-item b { font-size: 14px; margin-left: 4px; }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            #sidebar { width: 100%; height: 0; overflow: hidden; order: 2; display: none; }
            #map-container { height: 100%; order: 1; }
            #sidebar.mobile-active { display: flex; height: 60vh; position: fixed; bottom: 0; left: 0; width: 100%; border-radius: 16px 16px 0 0; box-shadow: 0 -4px 20px rgba(0,0,0,0.15); }
        }
    </style>
</head>
<body>

    <div id="loading" class="loading-overlay">
        <div class="animate-spin rounded-full h-10 w-10 border-4 border-blue-600 border-t-transparent"></div>
        <p class="mt-4 text-gray-600 font-bold tracking-widest text-sm">載入中...</p>
    </div>

    <div id="sync-progress-bar">
        <i class="fas fa-sync-alt fa-spin text-blue-400"></i>
        <span id="sync-text">正在同步...</span>
    </div>

    <!-- 同步日誌視窗 -->
    <div id="sync-log-modal">
        <div id="sync-log-header">
            <span>同步詳細報告</span>
            <button onclick="document.getElementById('sync-log-modal').style.display='none'" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="sync-log-body"></div>
        <div id="sync-log-footer">
            <button onclick="document.getElementById('sync-log-modal').style.display='none'; location.reload();" class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">關閉並重整</button>
        </div>
    </div>

    <div id="sidebar">
        <!-- 標題區 -->
        <div class="px-4 py-3 border-b flex justify-between items-center bg-white">
            <div class="flex items-center gap-2">
                <div class="bg-blue-600 text-white w-7 h-7 rounded flex items-center justify-center font-bold text-sm">窩</div>
                <div>
                    <h2 class="text-base font-bold text-gray-800">物件列表</h2>
                    <div id="last-update-time" class="text-[10px] text-gray-400 font-normal">最後更新: --</div>
                </div>
            </div>
            <button onclick="fetchData()" class="text-gray-400 hover:text-blue-600 p-2 rounded-full hover:bg-gray-50 transition" title="重新整理">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>

        <!-- 數據儀表板 (新增) -->
        <div class="stats-dashboard">
            <div class="stat-item text-blue-700">
                <i class="fas fa-map-marker-alt"></i> 此區域: <b id="visible-count">0</b> 筆
            </div>
            <div class="stat-item text-gray-600">
                <i class="fas fa-home"></i> 總可租: <b id="total-count">0</b> 筆
            </div>
        </div>

        <!-- 篩選區 -->
        <div class="filter-section">
            <div class="relative">
                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm"></i>
                <input type="text" id="search-input" class="search-input pl-9" placeholder="搜尋案名、地址...">
            </div>
            <div class="filter-row">
                <select id="filter-room" class="filter-select">
                    <option value="">格局不限</option>
                    <option value="1">1房</option>
                    <option value="2">2房</option>
                    <option value="3">3房</option>
                    <option value="4">4房以上</option>
                </select>
                <select id="filter-type" class="filter-select">
                    <option value="">用途不限</option>
                    <option value="住宅">住宅</option>
                    <option value="店面">店面/商業</option>
                    <option value="辦公">辦公室</option>
                    <option value="車位">車位</option>
                </select>
            </div>
        </div>

        <div id="property-list" class="flex-1 overflow-y-auto bg-gray-50 pb-20 md:pb-0"></div>
    </div>

    <div id="map-container">
        <div id="map"></div>
        <button onclick="toggleSidebar()" class="md:hidden fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-5 py-3 rounded-full shadow-xl font-bold z-50 flex items-center gap-2 text-sm">
            <i class="fas fa-list-ul"></i> 列表模式
        </button>
        <div class="absolute top-4 right-4 z-10 flex flex-col gap-2">
             <button onclick="syncAllToRagic()" class="bg-white p-3 rounded-lg shadow-md hover:bg-gray-50 text-gray-600 transition group relative" title="執行座標同步">
                <i class="fas fa-cloud-upload-alt text-lg group-hover:text-blue-600"></i>
                <span class="absolute right-full mr-3 top-1/2 -translate-y-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap pointer-events-none shadow-lg">
                    同步缺座標資料
                </span>
            </button>
        </div>
    </div>

    <script>
        const EID = {
            TITLE: "1000050", ADDR: "1000055", COORD: "1000759", 
            PRICE: "1000076", LAYOUT: "1000063", USAGE: "1000060", LINK_591: "1000113",
            STATUS: "1000707", // 新增: 狀態欄位 ID
            // 開發人員子表格相關 ID
            SUB_DEV: "_subtable_1000254", 
            DEV_NAME: "1000251", 
            DEV_PHONE: "1000252"
        };

        const MAPS_KEY = "AIzaSyALdVJlv7IBxnqeShEbzIIWnV7WSjtRtZw";
        const RAGIC_KEY = "VEZsOEwzYzVJdWdoWXRDM3ptS2YwRytLV21BaWhPTDRLWXhPb2FLZ3VBUm1BZE90VzJtZzlTNjVlbCszRnZkRw==";
        const API_URL = "https://ap15.ragic.com/wuohome/property-data-kept/10";

        let map, geocoder;
        let markers = [];
        let fetchedRecords = [];
        let filteredRecords = [];
        let activeInfoWindow = null;
        let mapMoveTimeout;

        window.onload = () => {
            updateTimeDisplay();
            const script = document.createElement('script');
            // 載入 geometry 庫以計算距離
            script.src = `https://maps.googleapis.com/maps/api/js?key=${MAPS_KEY}&callback=initMap&libraries=geometry`;
            script.async = true;
            document.head.appendChild(script);

            // 綁定篩選事件 - 搜尋時觸發自動定位
            document.getElementById('search-input').addEventListener('input', () => applyFilters(true));
            document.getElementById('filter-room').addEventListener('change', () => applyFilters(true));
            document.getElementById('filter-type').addEventListener('change', () => applyFilters(true));
        };

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 12,
                center: { lat: 25.0330, lng: 121.5654 },
                mapTypeControl: false,
                fullscreenControl: false,
                styles: [{ "featureType": "poi", "stylers": [{ "visibility": "off" }] }]
            });
            geocoder = new google.maps.Geocoder();
            map.addListener('idle', () => {
                clearTimeout(mapMoveTimeout);
                mapMoveTimeout = setTimeout(renderListByMapBounds, 300);
            });
            fetchData();
        }

        async function fetchData() {
            const loading = document.getElementById('loading');
            loading.style.display = 'flex';
            
            try {
                const ts = new Date().getTime();
                const fetchUrl = `${API_URL}?api&v=3&naming=EID&t=${ts}&filterId=103&APIKey=${encodeURIComponent(RAGIC_KEY)}`;
                
                const resp = await fetch(fetchUrl); 
                
                if (!resp.ok) throw new Error(`HTTP error! status: ${resp.status}`);
                
                const data = await resp.json();
                fetchedRecords = Object.entries(data).map(([id, val]) => ({ id, ...val }));
                
                document.getElementById('total-count').innerText = fetchedRecords.length;
                
                saveCurrentTime();
                applyFilters(true); // 初次載入自動定位

                setTimeout(() => loading.style.display = 'none', 500);

                // [新增] 自動同步防呆機制：確保同一瀏覽器 Session 只會自動執行一次
                if (!sessionStorage.getItem('ragic_auto_sync_executed')) {
                    sessionStorage.setItem('ragic_auto_sync_executed', 'true');
                    console.log("觸發首次載入自動同步...");
                    // 稍微延遲 1 秒，等待 UI 渲染完畢後再詢問，避免阻擋載入動畫
                    setTimeout(() => syncAllToRagic(), 1000);
                }

            } catch (err) {
                console.error(err);
                alert("讀取失敗，請確認網路或權限");
                loading.style.display = 'none';
            }
        }

        function applyFilters(autoZoom = false) {
            const keyword = document.getElementById('search-input').value.toLowerCase();
            const roomFilter = document.getElementById('filter-room').value;
            const typeFilter = document.getElementById('filter-type').value;

            filteredRecords = fetchedRecords.filter(item => {
                // 狀態為「下架」則不顯示
                if (item[EID.STATUS] === '下架') return false;

                const title = (item[EID.TITLE] || '').toLowerCase();
                const addr = (item[EID.ADDR] || '').toLowerCase();
                if (keyword && !title.includes(keyword) && !addr.includes(keyword)) return false;

                if (roomFilter) {
                    const layout = item[EID.LAYOUT] || '';
                    const roomMatch = layout.match(/(\d+)房/);
                    const roomNum = roomMatch ? parseInt(roomMatch[1]) : 0;
                    if (roomFilter === '4' && roomNum < 4) return false;
                    if (roomFilter !== '4' && roomNum !== parseInt(roomFilter)) return false;
                }

                if (typeFilter) {
                    const usage = (item[EID.USAGE] || '').toLowerCase();
                    const layout = (item[EID.LAYOUT] || '').toLowerCase();
                    if (typeFilter === '店面' && !usage.includes('店') && !layout.includes('店')) return false;
                    if (typeFilter === '住宅' && (usage.includes('店') || usage.includes('辦') || usage.includes('商'))) return false;
                    if (typeFilter === '辦公' && !usage.includes('辦') && !usage.includes('商')) return false;
                    if (typeFilter === '車位' && !usage.includes('車')) return false;
                }
                return true;
            });

            // 更新總數
            document.getElementById('total-count').innerText = filteredRecords.length;

            renderMarkers(autoZoom);
            // 這裡不直接呼叫 renderListByMapBounds，因為 fitBounds 會觸發 idle 事件，進而更新列表
            if (!autoZoom) renderListByMapBounds();
        }

        function renderMarkers(autoZoom) {
            markers.forEach(m => m.setMap(null));
            markers = [];
            
            let bounds = new google.maps.LatLngBounds();
            let hasCoords = false;

            filteredRecords.forEach(item => {
                const coord = item[EID.COORD];
                if (coord && coord.includes(',') && !isNaN(parseFloat(coord.split(',')[0]))) {
                    const [lat, lng] = coord.split(',').map(Number);
                    const marker = new google.maps.Marker({
                        position: { lat, lng }, map: map, title: item[EID.TITLE],
                        icon: { url: "https://maps.google.com/mapfiles/ms/icons/red-dot.png" }
                    });
                    marker.recordId = item.id;
                    marker.addListener("click", () => {
                        showInfoWindow(marker, item);
                        scrollToCard(item.id);
                    });
                    markers.push(marker);
                    bounds.extend({ lat, lng });
                    hasCoords = true;
                }
            });

            // 關鍵修改：如果是搜尋觸發的，或者還沒有邊界，就自動縮放地圖去包含搜尋結果
            if (hasCoords && (autoZoom || !map.getBounds())) {
                map.fitBounds(bounds);
                // 如果只有一個點，縮放不要太近
                if (markers.length === 1) {
                    const listener = google.maps.event.addListener(map, "idle", () => { 
                        if (map.getZoom() > 16) map.setZoom(16); 
                        google.maps.event.removeListener(listener); 
                    });
                }
            }
        }

        function renderListByMapBounds() {
            const list = document.getElementById('property-list');
            const bounds = map.getBounds();
            const center = map.getCenter();

            if (!bounds) return;

            // 1. 在地圖範圍內的正常物件
            let visibleItems = filteredRecords.filter(item => {
                const coord = item[EID.COORD];
                if (!coord || !coord.includes(',')) return false;
                const [lat, lng] = coord.split(',').map(Number);
                return bounds.contains({ lat, lng });
            });

            // 2. 符合篩選條件但「無座標」的物件
            let noCoordItems = filteredRecords.filter(item => {
                const coord = item[EID.COORD];
                return !coord || !coord.includes(',') || isNaN(parseFloat(coord.split(',')[0]));
            });

            // 距離排序
            visibleItems.sort((a, b) => {
                const [latA, lngA] = a[EID.COORD].split(',').map(Number);
                const [latB, lngB] = b[EID.COORD].split(',').map(Number);
                const distA = google.maps.geometry.spherical.computeDistanceBetween(center, new google.maps.LatLng(latA, lngA));
                const distB = google.maps.geometry.spherical.computeDistanceBetween(center, new google.maps.LatLng(latB, lngB));
                return distA - distB;
            });

            // 更新 "此區域" 數量顯示
            let countHtml = `${visibleItems.length}`;
            if (noCoordItems.length > 0) {
                countHtml += ` <span class="text-red-500 font-bold ml-1 text-xs" title="地址有錯誤抓不到地圖座標 可能是錯字或地址填寫有誤">(+${noCoordItems.length} 地址有錯誤抓不到地圖座標 可能是錯字或地址填寫有誤)</span>`;
            }
            document.getElementById('visible-count').innerHTML = countHtml;
            
            list.innerHTML = '';

            if (visibleItems.length === 0 && noCoordItems.length === 0) {
                list.innerHTML = '<div class="p-8 text-center text-gray-400">此範圍無符合條件的物件</div>';
                return;
            }

            // 渲染地圖範圍內的物件
            visibleItems.forEach(item => createListItem(item, list));

            // 渲染無座標物件 (加分隔線)
            if (noCoordItems.length > 0) {
                if (visibleItems.length > 0) {
                    const separator = document.createElement('div');
                    separator.className = "px-4 py-2 bg-red-50 text-red-600 text-xs font-bold border-t border-b border-red-100 mt-2";
                    separator.innerHTML = `<i class="fas fa-exclamation-circle mr-1"></i> 以下物件地址有誤無法定位`;
                    list.appendChild(separator);
                }
                noCoordItems.forEach(item => createListItem(item, list, true));
            }
        }

        // 新增：產生聯絡人按鈕 HTML
        function getAgentsHtml(item) {
            const subData = item[EID.SUB_DEV];
            if (!subData) return '';
            
            // Ragic 子表格為物件，嘗試轉為陣列並排序 (若無順序則直接使用)
            const rows = Object.values(subData); 
            
            let html = '<div class="flex flex-wrap mt-2">';
            let hasAgent = false;
            
            rows.forEach(row => {
                const name = row[EID.DEV_NAME];
                const phone = row[EID.DEV_PHONE];
                
                if (name && phone) {
                    hasAgent = true;
                    // 使用 stopPropagation 防止觸發卡片點擊事件
                    html += `
                        <a href="tel:${phone}" class="agent-btn" onclick="event.stopPropagation()">
                            <i class="fas fa-phone-alt"></i> ${name}
                        </a>
                    `;
                }
            });
            
            html += '</div>';
            return hasAgent ? html : '';
        }

        function createListItem(item, container, isNoCoord = false) {
            const div = document.createElement('div');
            const price = item[EID.PRICE] ? parseInt(item[EID.PRICE]).toLocaleString() : "面議";
            const link591 = item[EID.LINK_591];
            const hasLink = link591 && link591.startsWith('http');
            const usage = item[EID.USAGE] || '';
            const isShop = usage.includes('店');
            const agentsHtml = getAgentsHtml(item); // 產生聯絡人按鈕

            // 檢查是否有座標
            const hasCoord = item[EID.COORD] && item[EID.COORD].includes(',') && !isNoCoord;

            div.className = `property-card ${isNoCoord ? 'bg-red-50/30' : ''}`;
            div.id = `card-${item.id}`;
            div.onclick = (e) => {
                if(e.target.tagName === 'A' || e.target.closest('a')) return;
                focusOnMap(item.id, item[EID.COORD]);
            };
            
            div.innerHTML = `
                <div class="card-header"><div class="card-title">${item[EID.TITLE] || '(未命名)'}</div></div>
                <div class="card-details">
                    <span class="tag ${isShop ? 'tag-shop' : ''}"><i class="fas ${isShop ? 'fa-store' : 'fa-home'} mr-1"></i>${item[EID.LAYOUT] || usage || '未分類'}</span>
                    <span class="text-gray-400">|</span>
                    <span class="truncate w-32 md:w-40" title="${item[EID.ADDR]}">${item[EID.ADDR] || ''}</span>
                </div>
                ${agentsHtml} <!-- 插入聯絡人按鈕 -->
                <div class="card-footer">
                    <div class="card-price">$${price} <span class="price-unit">/月</span></div>
                    <div class="flex gap-2">
                        ${hasCoord ? `<a href="https://www.google.com/maps/dir/?api=1&destination=${item[EID.COORD]}" target="_blank" class="inline-flex items-center gap-1 bg-blue-600 text-white py-1 px-2.5 rounded text-xs font-bold transition hover:bg-blue-700" onclick="event.stopPropagation()" title="導航"><i class="fas fa-location-arrow"></i> 導航</a>` : ''}
                        <a href="${link591}" target="_blank" class="btn-591 ${hasLink ? '' : 'btn-hidden'}" title="前往 591">
                            <i class="fas fa-external-link-alt"></i> 591
                        </a>
                    </div>
                </div>`;
            container.appendChild(div);
        }

        function showInfoWindow(marker, item) {
            const price = item[EID.PRICE] ? parseInt(item[EID.PRICE]).toLocaleString() : "面議";
            const link591 = item[EID.LINK_591];
            const hasLink = link591 && link591.startsWith('http');
            const [lat, lng] = item[EID.COORD].split(',');
            const agentsHtml = getAgentsHtml(item); // 產生聯絡人按鈕

            const infoContent = `
                <div style="padding: 5px; min-width: 200px;">
                    <h3 class="font-bold text-base mb-1 text-gray-800">${item[EID.TITLE]}</h3>
                    <p class="text-gray-500 text-xs mb-2">${item[EID.LAYOUT]} | ${item[EID.ADDR]}</p>
                    ${agentsHtml} <!-- 插入聯絡人按鈕 -->
                    <div class="flex justify-between items-center mt-2 border-t pt-2">
                        <span class="text-red-600 font-bold text-lg">$${price}</span>
                        <div class="flex gap-2">
                            ${hasLink ? `<a href="${link591}" target="_blank" class="text-xs bg-orange-500 text-white px-2 py-1 rounded hover:bg-orange-600" style="text-decoration:none;">591</a>` : ''}
                            <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}" target="_blank" class="text-xs bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700" style="text-decoration:none;">導航</a>
                        </div>
                    </div>
                </div>`;

            if (activeInfoWindow) activeInfoWindow.close();
            const infoWindow = new google.maps.InfoWindow({ content: infoContent });
            infoWindow.open(map, marker);
            activeInfoWindow = infoWindow;
        }

        function focusOnMap(id, coord) {
            if (!coord || !coord.includes(',')) { alert("尚無座標 (需同步)"); return; }
            const [lat, lng] = coord.split(',').map(Number);
            map.setCenter({ lat, lng });
            map.setZoom(16);
            const targetMarker = markers.find(m => m.recordId === id);
            if (targetMarker) google.maps.event.trigger(targetMarker, 'click');
            if (window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('mobile-active');
        }

        function scrollToCard(id) {
            document.querySelectorAll('.property-card').forEach(el => el.classList.remove('active'));
            const card = document.getElementById(`card-${id}`);
            if (card) { card.classList.add('active'); card.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('mobile-active');
            sidebar.style.display = sidebar.classList.contains('mobile-active') ? 'flex' : 'none';
        }

        function saveCurrentTime() {
            const now = new Date();
            const timeStr = `${now.getFullYear()}/${(now.getMonth()+1).toString().padStart(2,'0')}/${now.getDate().toString().padStart(2,'0')} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
            localStorage.setItem('ragic_last_update', timeStr);
            updateTimeDisplay();
        }

        function updateTimeDisplay() {
            const lastTime = localStorage.getItem('ragic_last_update');
            const el = document.getElementById('last-update-time');
            if(lastTime) el.innerText = `最後更新: ${lastTime}`;
        }

        // 新增：寫入日誌的輔助函式
        function appendLog(message, type = 'normal') {
            const logBody = document.getElementById('sync-log-body');
            const div = document.createElement('div');
            div.className = `log-item ${type === 'success' ? 'log-success' : type === 'error' ? 'log-error' : type === 'warn' ? 'log-warn' : ''}`;
            div.innerHTML = message;
            logBody.appendChild(div);
            logBody.scrollTop = logBody.scrollHeight;
        }

        async function syncAllToRagic() {
            if(!confirm("確定要執行同步？\n系統將自動解析缺座標的物件並寫回 Ragic。")) return;
            
            const btn = document.querySelector('button[onclick="syncAllToRagic()"]');
            btn.disabled = true;
            
            const modal = document.getElementById('sync-log-modal');
            const logBody = document.getElementById('sync-log-body');
            logBody.innerHTML = ''; // 清空舊日誌
            modal.style.display = 'flex';
            
            appendLog('<i class="fas fa-search"></i> 正在掃描資料...', 'normal');

            let success = 0;
            let errors = 0;
            const toProcess = fetchedRecords.filter(i => {
                const c = i[EID.COORD];
                return !c || !c.toString().includes(',') || isNaN(parseFloat(c.split(',')[0]));
            });

            if (toProcess.length === 0) {
                appendLog('<i class="fas fa-check-circle"></i> 資料已完整，無需同步！', 'success');
                btn.disabled = false;
                return;
            }

            appendLog(`共發現 <b>${toProcess.length}</b> 筆資料需要同步...`, 'warn');

            for (let i = 0; i < toProcess.length; i++) {
                const item = toProcess[i];
                const address = item[EID.ADDR];
                const recordId = item.id;
                
                if (address) {
                    try {
                        // 1. 先從 Google Maps 抓座標
                        const result = await new Promise((res, rej) => {
                            geocoder.geocode({ address }, (r, s) => s === 'OK' ? res(r[0]) : rej(s));
                        });
                        const coordStr = `${result.geometry.location.lat()},${result.geometry.location.lng()}`;
                        
                        appendLog(`[${i+1}/${toProcess.length}] Google定位成功: ${address} -> ${coordStr}`, 'normal');

                        // 2. 準備寫回 Ragic
                        const formData = new URLSearchParams();
                        formData.append(EID.COORD, coordStr);
                        
                        // 維持 URL 參數傳遞 (雙重確保)
                        const updateUrl = `${API_URL}/${recordId}?api&v=3&APIKey=${encodeURIComponent(RAGIC_KEY)}`;
                        
                        const updateResp = await fetch(updateUrl, {
                            method: 'POST',
                            headers: { 
                                "Content-Type": "application/x-www-form-urlencoded"
                            },
                            body: formData.toString()
                        });
                        
                        // 嘗試解析 JSON，如果解析失敗則可能是網路錯誤或純文字錯誤
                        let json;
                        try {
                            json = await updateResp.json();
                        } catch(e) {
                            throw new Error("API 回傳格式錯誤或網路中斷");
                        }
                        
                        if (json.status === 'SUCCESS') {
                            success++;
                            appendLog(`<i class="fas fa-check"></i> Ragic 更新成功 (ID: ${recordId})`, 'success');
                        } else {
                            errors++;
                            // 捕捉 Ragic 具體錯誤訊息
                            const errMsg = json.msg || json.message || "未知錯誤";
                            appendLog(`<i class="fas fa-times"></i> Ragic 拒絕更新 (ID: ${recordId}): <b>${errMsg}</b>`, 'error');
                            if(errMsg.includes("permission") || errMsg.includes("權限") || errMsg.includes("guest")) {
                                appendLog(`提示: 您的 API Key 可能只有讀取權限。請至 Ragic 後台重新產生並勾選「修改」權限。`, 'warn');
                            }
                        }
                    } catch (e) {
                        errors++;
                        appendLog(`<i class="fas fa-exclamation-triangle"></i> 處理失敗 (ID: ${recordId}): ${e.message || e}`, 'error');
                        if (e.toString().includes('Failed to fetch')) {
                             appendLog(`提示: 可能是跨域 (CORS) 錯誤，或 API Key 限制了來源`, 'warn');
                        }
                    }
                    // 稍微暫停
                    await new Promise(r => setTimeout(r, 600));
                } else {
                    appendLog(`[${i+1}/${toProcess.length}] ID: ${recordId} 無地址，跳過`, 'warn');
                }
            }
            
            appendLog(`<hr><b>同步結束！</b> 成功: ${success} 筆, 失敗: ${errors} 筆`, 'normal');
            btn.disabled = false;
        }
    </script>
</body>
</html>
