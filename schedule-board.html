{/* === FIX: 月曆渲染比對邏輯 === */}
                            {daysInMonth.map((date) => {
                                const dateStr = formatDate(date);
                                const isWeekendDay = isWeekend(date);
                                
                                const dayDuty = duties.find(d => d.DATE === dateStr);
                                const dayLeaves = leaves.filter(l => l.DATE === dateStr);
                                
                                // 嘗試用 ID 或 Name 找回員工物件
                                const dutyPerson = dayDuty ? employees.find(e => e.ragicId == dayDuty.EMP_ID || e.NAME === dayDuty.EMP_ID) : null;
                                const dutyName = dutyPerson ? dutyPerson.NAME : (dayDuty ? "未知員工" : "未排");

                                // Conflict Logic (Simplified)
                                let conflictMsg = null;
                                
                                return (
                                    <div 
                                        key={dateStr} 
                                        onClick={() => handleToggleLeave(dateStr)}
                                        className={`
                                            bg-white min-h-[120px] p-2 flex flex-col gap-1 relative group hover:bg-blue-50/50 transition cursor-pointer
                                            ${formatDate(new Date()) === dateStr ? 'bg-blue-50' : ''}
                                        `}
                                    >
                                        <div className="flex justify-between items-start">
                                            <span className={`
                                                text-sm font-semibold w-6 h-6 flex items-center justify-center rounded-full
                                                ${formatDate(new Date()) === dateStr ? 'bg-blue-600 text-white' : 'text-gray-700'}
                                                ${isWeekendDay ? 'text-red-500' : ''}
                                            `}>
                                                {date.getDate()}
                                            </span>

                                            {/* Duty Chip (Click logic needs update if using prompt, but left as is for now) */}
                                            <div 
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    handleChangeDuty(dateStr, dayDuty);
                                                }}
                                                className={`
                                                    text-[11px] px-1.5 py-0.5 rounded border flex items-center gap-1 max-w-[80px] cursor-pointer hover:opacity-80
                                                    ${conflictMsg 
                                                        ? 'bg-red-100 border-red-300 text-red-700 animate-pulse font-bold' 
                                                        : 'bg-yellow-50 border-yellow-200 text-yellow-800'}
                                                `}
                                            >
                                                <Icon name={conflictMsg ? "AlertTriangle" : "Trash2"} size={10} />
                                                <span className="truncate">
                                                    {dutyName}
                                                </span>
                                            </div>
                                        </div>

                                        <div className="flex-1 mt-1 overflow-y-auto scrollbar-hide space-y-1">
                                            {dayLeaves.map(l => {
                                                const p = employees.find(e => e.ragicId == l.EMP_ID || e.NAME === l.EMP_ID);
                                                const name = p ? p.NAME : `Emp ${l.EMP_ID}`;
                                                // Check if THIS leave belongs to CURRENTLY selected user
                                                const isMyLeave = selectedEmpId && (l.EMP_ID == selectedEmpId);

                                                return (
                                                    <div key={l.ragicId} className="text-[11px] bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded flex items-center justify-between">
                                                        <span className="truncate">{name}</span>
                                                        {isMyLeave && (
                                                            <Icon name="X" size={10} className="text-gray-400" />
                                                        )}
                                                    </div>
                                                );
                                            })}
                                            {isWeekendDay && (
                                                <div className="text-[10px] text-emerald-600/60 text-center mt-2 border-t border-emerald-100 pt-1">
                                                    設計部公休
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                );
                            })}
