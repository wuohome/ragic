<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>公司線上排休與值日生看板</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            background-color: #f3f4f6;
            font-family: "Microsoft JhengHei", "Noto Sans TC", sans-serif;
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3498db;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        /**
         * ==========================================================================================
         * 【系統設定區】
         * ==========================================================================================
         */
        const RAGIC_CONFIG = {
            // Ragic 基礎網址
            BASE_URL: "https://ap15.ragic.com",
            
            // 您的 API Key
            API_KEY: "Nm5QVzFtZ1pGYzZIT1REUnBhY3A0bDVKY0luaEh3d2lrSmMzTHNSVjh3N1VHc1JadWJjQk9yZDQ3UlpZZnFubQ==", 

            // 表單路徑
            PATHS: {
                EMPLOYEE: "/wuohome/ragicforms4/20004", // 人事資料
                LEAVE:    "/wuohome/ragicforms4/2",     // 排休紀錄
                DUTY:     "/wuohome/ragicforms4/3"      // 值日生排班紀錄
            },

            // 欄位對照 (Field ID)
            FIELDS: {
                EMPLOYEE: {
                    ID:           "3000934", // 員工編號
                    NAME:         "3000933", // 姓名
                    DISPLAY_NAME: "1000848", // 顯示名稱 (Kelly, Jerry...)
                    DEPT:         "3000937", // 部門
                    STATUS:       "3000945", // 在職狀態
                    HIRE_TYPE:    "3000955"  // 聘雇類別 (永久, 約聘, 兼職...)
                },
                LEAVE: {
                    EMP_ID: "1000961", // 員工
                    DATE:   "1000963", // 日期
                    YEAR:   "1000964", // 年
                    MONTH:  "1000965"  // 月
                },
                DUTY: {
                    DATE:      "1000971", // 日期
                    EMP_ID:    "1000972", // 值日生
                    YEAR:      "1000973", // 年
                    MONTH:     "1000974", // 月
                    IS_AUTO:   "1000975", // 是否為系統預排
                    NOTE:      "1000976"  // 備註
                }
            }
        };

        /**
         * ==========================================================================================
         * API 處理邏輯 (直連模式)
         * ==========================================================================================
         */
        
        // 通用 Fetch 函數
        const ragicFetch = async (path, options = {}) => {
            const url = `${RAGIC_CONFIG.BASE_URL}${path}`;
            const apiKey = (RAGIC_CONFIG.API_KEY || "").trim();
            
            const queryChar = url.includes('?') ? '&' : '?';
            const fullUrl = `${url}${queryChar}api=true&v=3&naming=EID&APIKey=${encodeURIComponent(apiKey)}`;
            
            console.log(`%c[API Request] %c${path}`, "color: blue; font-weight: bold;", "color: black;");

            const headers = { ...options.headers };

            try {
                const response = await fetch(fullUrl, { ...options, headers });
                if (!response.ok) {
                    console.error("API Response NOT OK:", response.statusText);
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }
                const json = await response.json();
                return json;
            } catch (error) {
                console.error("%c[Fetch Error]", "color: red; font-weight: bold;", error);
                throw error;
            }
        };

        // 解析 Ragic 回傳的物件
        const parseRagicData = (dataMap, fieldMapping) => {
            if (!dataMap || typeof dataMap !== 'object') return [];
            
            const result = Object.entries(dataMap).map(([ragicId, fields]) => {
                if (typeof fields !== 'object' || fields === null) return null;
                const item = { ragicId };
                for (const [key, fieldId] of Object.entries(fieldMapping)) {
                    item[key] = fields[fieldId] !== undefined ? fields[fieldId] : ""; 
                }
                return item;
            }).filter(item => item !== null);

            return result;
        };

        const apiService = {
            getEmployees: async () => {
                const json = await ragicFetch(RAGIC_CONFIG.PATHS.EMPLOYEE);
                const records = (json && json.data) ? json.data : json;
                const employees = parseRagicData(records, RAGIC_CONFIG.FIELDS.EMPLOYEE);
                
                // 1. 排除「經營階層」
                return employees.filter(e => {
                    const dept = (e.DEPT || "").trim();
                    if (dept === "經營階層") return false;
                    return true;
                }); 
            },

            getLeaves: async (year, month) => {
                const json = await ragicFetch(RAGIC_CONFIG.PATHS.LEAVE);
                const records = (json && json.data) ? json.data : json;
                const leaves = parseRagicData(records, RAGIC_CONFIG.FIELDS.LEAVE);
                return leaves.filter(l => parseInt(l.YEAR) == year && parseInt(l.MONTH) == month);
            },

            getDuties: async (year, month) => {
                const json = await ragicFetch(RAGIC_CONFIG.PATHS.DUTY);
                const records = (json && json.data) ? json.data : json;
                const duties = parseRagicData(records, RAGIC_CONFIG.FIELDS.DUTY);
                return duties.filter(d => parseInt(d.YEAR) == year && parseInt(d.MONTH) == month);
            },
            
            getPrevMonthDuties: async (currYear, currMonth) => {
                let prevYear = currYear;
                let prevMonth = currMonth - 1;
                if(prevMonth === 0) { prevMonth = 12; prevYear -= 1; }
                
                const json = await ragicFetch(RAGIC_CONFIG.PATHS.DUTY);
                const records = (json && json.data) ? json.data : json;
                const duties = parseRagicData(records, RAGIC_CONFIG.FIELDS.DUTY);
                return duties.filter(d => parseInt(d.YEAR) == prevYear && parseInt(d.MONTH) == prevMonth);
            },

            createLeave: async (leaveData) => {
                const params = new URLSearchParams();
                params.append(RAGIC_CONFIG.FIELDS.LEAVE.EMP_ID, leaveData.EMP_ID);
                params.append(RAGIC_CONFIG.FIELDS.LEAVE.DATE, leaveData.DATE);
                params.append(RAGIC_CONFIG.FIELDS.LEAVE.YEAR, leaveData.YEAR);
                params.append(RAGIC_CONFIG.FIELDS.LEAVE.MONTH, leaveData.MONTH);

                const json = await ragicFetch(RAGIC_CONFIG.PATHS.LEAVE, {
                    method: 'POST',
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: params.toString()
                });
                return json; 
            },

            deleteLeave: async (ragicId) => {
                await ragicFetch(`${RAGIC_CONFIG.PATHS.LEAVE}/${ragicId}`, { method: 'DELETE' });
                return true;
            },

            upsertDuty: async (dutyData, existingRagicId = null) => {
                const params = new URLSearchParams();
                params.append(RAGIC_CONFIG.FIELDS.DUTY.DATE, dutyData.DATE);
                params.append(RAGIC_CONFIG.FIELDS.DUTY.EMP_ID, dutyData.EMP_ID);
                params.append(RAGIC_CONFIG.FIELDS.DUTY.YEAR, dutyData.YEAR);
                params.append(RAGIC_CONFIG.FIELDS.DUTY.MONTH, dutyData.MONTH);
                
                if (dutyData.IS_AUTO !== undefined) params.append(RAGIC_CONFIG.FIELDS.DUTY.IS_AUTO, dutyData.IS_AUTO);
                if (dutyData.NOTE !== undefined) params.append(RAGIC_CONFIG.FIELDS.DUTY.NOTE, dutyData.NOTE);

                const url = existingRagicId 
                    ? `${RAGIC_CONFIG.PATHS.DUTY}/${existingRagicId}` 
                    : RAGIC_CONFIG.PATHS.DUTY;

                const json = await ragicFetch(url, {
                    method: 'POST',
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: params.toString()
                });
                return json;
            }
        };

        // ==========================================
        // Helper Functions
        // ==========================================
        const formatDate = (date) => {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        };

        const getDaysInMonth = (year, month) => {
            const date = new Date(year, month - 1, 1);
            const days = [];
            while (date.getMonth() === month - 1) {
                days.push(new Date(date));
                date.setDate(date.getDate() + 1);
            }
            return days;
        };

        const isWeekend = (date) => {
            const day = date.getDay();
            return day === 0 || day === 6; // Sun or Sat
        };

        const Icon = ({ name, size = 16, className = "" }) => {
            const LucideIcon = window.lucide && window.lucide.icons ? window.lucide.icons[name] : null;
            if (!LucideIcon) return null;
            
            return (
                <svg 
                    xmlns="http://www.w3.org/2000/svg" 
                    width={size} 
                    height={size} 
                    viewBox="0 0 24 24" 
                    fill="none" 
                    stroke="currentColor" 
                    strokeWidth="2" 
                    strokeLinecap="round" 
                    strokeLinejoin="round" 
                    className={className}
                    dangerouslySetInnerHTML={{ __html: LucideIcon.toSvg ? LucideIcon.toSvg().innerHTML : '' }}
                />
            );
        };

        // 部門顏色對照表
        const getDeptColor = (dept) => {
            if (!dept) return { bg: 'bg-gray-400', tag: 'bg-gray-100 text-gray-700' };
            
            if (dept.includes('租賃')) {
                return { bg: 'bg-orange-400', tag: 'bg-orange-100 text-orange-700' };
            } else if (dept.includes('設計')) {
                return { bg: 'bg-emerald-400', tag: 'bg-emerald-100 text-emerald-700' };
            } else if (dept.includes('管理')) {
                return { bg: 'bg-purple-400', tag: 'bg-purple-100 text-purple-700' };
            }
            return { bg: 'bg-gray-400', tag: 'bg-gray-100 text-gray-700' };
        };

        /**
         * ==========================================================================================
         * React Components
         * ==========================================================================================
         */
        const App = () => {
            const [currentDate, setCurrentDate] = React.useState(new Date());
            const [employees, setEmployees] = React.useState([]);
            const [leaves, setLeaves] = React.useState([]);
            const [duties, setDuties] = React.useState([]);
            
            const [selectedEmpId, setSelectedEmpId] = React.useState(null);
            const [selectedDeptFilter, setSelectedDeptFilter] = React.useState('All'); // 部門篩選狀態

            const [loading, setLoading] = React.useState(false);
            const [processing, setProcessing] = React.useState(false);
            const [toast, setToast] = React.useState(null);

            // Init Data Fetch
            React.useEffect(() => {
                fetchData();
            }, [currentDate]);

            const fetchData = async () => {
                setLoading(true);
                try {
                    const year = currentDate.getFullYear();
                    const month = currentDate.getMonth() + 1;

                    console.log("Fetching data for:", year, month);

                    const [empData, leaveData, dutyData] = await Promise.all([
                        apiService.getEmployees(),
                        apiService.getLeaves(year, month),
                        apiService.getDuties(year, month)
                    ]);

                    setEmployees(empData);
                    setLeaves(leaveData);
                    setDuties(dutyData);
                    
                } catch (error) {
                    console.error("Critical Error in fetchData:", error);
                    showToast("資料載入失敗，請查看 Console (F12)", "error");
                } finally {
                    setLoading(false);
                }
            };

            const showToast = (msg, type = 'info') => {
                setToast({ msg, type });
                setTimeout(() => setToast(null), 3000);
            };

            const changeMonth = (offset) => {
                const newDate = new Date(currentDate);
                newDate.setMonth(newDate.getMonth() + offset);
                setCurrentDate(newDate);
            };

            // --------------------------------------------------------------------------------------
            //  Logic
            // --------------------------------------------------------------------------------------

            const handleToggleLeave = async (dateStr) => {
                if (!selectedEmpId) {
                    showToast("請先點選左側員工", "error");
                    return;
                }
                if (processing) return;

                const emp = employees.find(e => e.ragicId === selectedEmpId);
                if (!emp) {
                    console.error("找不到員工資料, ID:", selectedEmpId);
                    return;
                }

                // 【兼職邏輯】兼職人員不排休
                const hireType = emp.HIRE_TYPE || "";
                if (hireType.includes("兼職")) {
                    alert(`【提示】${emp.DISPLAY_NAME || emp.NAME} 為「兼職」人員。\n\n兼職夥伴只需安排值日生，無需排休。`);
                    return; // 阻止執行後續排休邏輯
                }

                const existingLeave = leaves.find(l => 
                    l.DATE === dateStr && (l.EMP_ID == selectedEmpId || l.EMP_ID === emp.NAME)
                );
                
                const year = parseInt(dateStr.split('-')[0]);
                const month = parseInt(dateStr.split('-')[1]);

                setProcessing(true);
                try {
                    if (existingLeave) {
                        await apiService.deleteLeave(existingLeave.ragicId);
                        setLeaves(prev => prev.filter(l => l.ragicId !== existingLeave.ragicId));
                        showToast("已取消排休", "success");
                    } else {
                        const payload = {
                            EMP_ID: selectedEmpId,
                            DATE: dateStr,
                            YEAR: year,
                            MONTH: month
                        };
                        const res = await apiService.createLeave(payload);
                        const newId = (res && res.ragicId) ? res.ragicId : ('temp_' + Date.now());
                        setLeaves(prev => [...prev, { ragicId: newId, ...payload }]);
                        
                        showToast("排休已登記", "success");
                    }
                } catch (err) {
                    console.error(err);
                    showToast("操作失敗: " + err.message, "error");
                } finally {
                    setProcessing(false);
                }
            };

            const handleChangeDuty = async (dateStr, existingDuty) => {
                const result = prompt(
                    `請輸入當天值日生的「員工完整姓名」以進行更換：\n(若要取消請留空)`, 
                    existingDuty ? employees.find(e => e.ID === existingDuty.EMP_ID || e.NAME === existingDuty.EMP_ID)?.NAME : ""
                );

                if (result === null) return; 

                setProcessing(true);
                try {
                    const year = parseInt(dateStr.split('-')[0]);
                    const month = parseInt(dateStr.split('-')[1]);
                    
                    if (result.trim() === "") {
                        showToast("若需清空值日生，請直接輸入系統中不存在的名字(不做任何動作)", "warning");
                    } else {
                        const targetEmp = employees.find(e => e.NAME === result.trim());
                        if (!targetEmp) {
                            alert("找不到該員工姓名，請確認輸入正確。");
                            setProcessing(false);
                            return;
                        }
                        
                        const prevDate = new Date(dateStr);
                        prevDate.setDate(prevDate.getDate() - 1);
                        const prevDateStr = formatDate(prevDate);
                        const prevDuty = duties.find(d => d.DATE === prevDateStr);
                        
                        if (prevDuty && (prevDuty.EMP_ID === targetEmp.ID || prevDuty.EMP_ID === targetEmp.NAME)) {
                            alert("警告：該員工前一天已值日！(仍會執行變更)");
                        }

                        const payload = {
                            DATE: dateStr,
                            EMP_ID: targetEmp.ID, 
                            YEAR: year,
                            MONTH: month,
                            IS_AUTO: 'No', 
                            NOTE: "手動變更"
                        };
                        
                        await apiService.upsertDuty(payload, existingDuty ? existingDuty.ragicId : null);
                        
                        const newDuties = await apiService.getDuties(year, month);
                        setDuties(newDuties);
                        showToast("值日生已更新", "success");
                    }
                } catch (err) {
                    showToast("變更失敗: " + err.message, "error");
                } finally {
                    setProcessing(false);
                }
            };

            const handleAutoSchedule = async () => {
                if (!confirm(`確定要自動安排 ${currentDate.getMonth() + 1} 月的值日生嗎？\n這將會覆蓋本月已存在的系統排班。`)) return;

                setProcessing(true);
                showToast("正在計算排班並寫入資料庫，請稍候...", "info");

                try {
                    const year = currentDate.getFullYear();
                    const month = currentDate.getMonth() + 1;
                    const days = getDaysInMonth(year, month);
                    
                    const prevDuties = await apiService.getPrevMonthDuties(year, month);
                    
                    let counts = {};
                    employees.forEach(e => counts[e.ID] = 0);

                    prevDuties.forEach(d => {
                        const emp = employees.find(e => e.ID === d.EMP_ID || e.NAME === d.EMP_ID);
                        if (emp) counts[emp.ID]++;
                    });

                    let lastDutyEmpId = null; 
                    
                    const lastMonthLastDay = prevDuties.sort((a,b) => b.DATE.localeCompare(a.DATE))[0];
                    if (lastMonthLastDay) {
                         const emp = employees.find(e => e.ID === lastMonthLastDay.EMP_ID || e.NAME === lastMonthLastDay.EMP_ID);
                         if (emp) lastDutyEmpId = emp.ID;
                    }

                    const newScheduleRequests = [];

                    for (let date of days) {
                        const dateStr = formatDate(date);
                        
                        // 包含兼職人員在內的所有員工一起輪值
                        const sortedCandidates = [...employees].sort((a, b) => {
                            if (counts[a.ID] !== counts[b.ID]) return counts[a.ID] - counts[b.ID];
                            return (a.DISPLAY_NAME || a.NAME).localeCompare(b.DISPLAY_NAME || b.NAME);
                        });

                        let pick = sortedCandidates.find(c => c.ID !== lastDutyEmpId);
                        if (!pick) pick = sortedCandidates[0];

                        counts[pick.ID]++;
                        lastDutyEmpId = pick.ID;

                        const existing = duties.find(d => d.DATE === dateStr);
                        newScheduleRequests.push({
                            payload: {
                                DATE: dateStr,
                                EMP_ID: pick.ID,
                                YEAR: year,
                                MONTH: month,
                                IS_AUTO: 'Yes',
                                NOTE: "系統預排"
                            },
                            ragicId: existing ? existing.ragicId : null
                        });
                    }

                    for (const req of newScheduleRequests) {
                        await apiService.upsertDuty(req.payload, req.ragicId);
                    }

                    const refreshedDuties = await apiService.getDuties(year, month);
                    setDuties(refreshedDuties);
                    showToast("自動排班完成！", "success");

                } catch (err) {
                    showToast("排班過程發生錯誤: " + err.message, "error");
                } finally {
                    setProcessing(false);
                }
            };

            const getEmpStats = (rId) => {
                const emp = employees.find(e => e.ragicId === rId);
                const name = emp ? emp.NAME : "";
                const leaveCount = leaves.filter(l => l.EMP_ID == rId || l.EMP_ID === name).length;
                const dutyCount = duties.filter(d => d.EMP_ID == rId || d.EMP_ID === name).length;
                return { leaveCount, dutyCount };
            };

            const daysInMonth = getDaysInMonth(currentDate.getFullYear(), currentDate.getMonth() + 1);
            const startDay = daysInMonth[0].getDay();
            const blanks = Array(startDay).fill(null);

            // 取得所有不重複的部門列表 (已排除經營階層)
            const departments = ['All', ...new Set(employees.map(e => e.DEPT || '未分類'))].filter(d => d);

            // 根據篩選過濾員工
            const filteredEmployees = employees.filter(emp => {
                if (selectedDeptFilter === 'All') return true;
                return emp.DEPT === selectedDeptFilter;
            });

            // === 排序邏輯優化 ===
            // 權重：
            // 1. 未滿8天且需排班者 (優先)
            // 2. 已滿8天者 (次之)
            // 3. 兼職/無須排班者 (最後)
            filteredEmployees.sort((a, b) => {
                const statsA = getEmpStats(a.ragicId);
                const statsB = getEmpStats(b.ragicId);
                
                const isPartTimeA = (a.HIRE_TYPE || "").includes("兼職");
                const isPartTimeB = (b.HIRE_TYPE || "").includes("兼職");
                
                const isFullA = statsA.leaveCount >= 8;
                const isFullB = statsB.leaveCount >= 8;

                // 權重計算 (越小越優先)
                // 兼職: 3
                // 滿8天: 2
                // 未滿8天: 1
                let scoreA = isPartTimeA ? 3 : (isFullA ? 2 : 1);
                let scoreB = isPartTimeB ? 3 : (isFullB ? 2 : 1);

                if (scoreA !== scoreB) return scoreA - scoreB;
                
                // 同分則依部門排序
                if (a.DEPT !== b.DEPT) return (a.DEPT || "").localeCompare(b.DEPT || "");
                
                // 再同分依名字排序
                return (a.DISPLAY_NAME || a.NAME).localeCompare(b.DISPLAY_NAME || b.NAME);
            });

            return (
                <div className="min-h-screen flex flex-col md:flex-row max-w-[1400px] mx-auto p-4 gap-4 relative">
                    
                    {(loading || processing) && (
                        <div className="absolute inset-0 bg-white/50 z-50 flex items-center justify-center backdrop-blur-sm rounded-xl">
                            <div className="bg-white p-4 rounded-lg shadow-xl flex flex-col items-center">
                                <div className="loader mb-2"></div>
                                <span className="text-gray-600 font-medium">{processing ? '處理資料中...' : '載入中...'}</span>
                            </div>
                        </div>
                    )}

                    {/* Sidebar */}
                    <div className="w-full md:w-80 flex-shrink-0 flex flex-col gap-4 bg-white p-4 rounded-xl shadow-sm h-fit sticky top-4 border border-gray-100">
                        <div className="flex flex-col gap-1">
                            <h1 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                                <Icon name="CalendarClock" className="text-blue-600" />
                                輪值與排休系統
                            </h1>
                        </div>
                        
                        <div className="bg-blue-50 p-3 rounded-lg text-sm text-blue-800 border border-blue-100">
                            <p className="font-bold mb-1">操作指南：</p>
                            <ol className="list-decimal list-inside space-y-1 text-xs">
                                <li>點擊員工卡片選定「操作對象」。</li>
                                <li>點擊月曆格子進行「排休/取消」。</li>
                                <li>點擊月曆上的值日生名字可手動換人。</li>
                            </ol>
                        </div>

                        <div className="flex items-center justify-between bg-gray-100 p-2 rounded-lg">
                            <button onClick={() => changeMonth(-1)} className="p-2 hover:bg-gray-200 rounded-full"><Icon name="ChevronLeft" /></button>
                            <span className="font-bold text-lg">
                                {currentDate.getFullYear()} 年 {currentDate.getMonth() + 1} 月
                            </span>
                            <button onClick={() => changeMonth(1)} className="p-2 hover:bg-gray-200 rounded-full"><Icon name="ChevronRight" /></button>
                        </div>

                        <button 
                            onClick={handleAutoSchedule}
                            disabled={processing}
                            className="w-full py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition flex items-center justify-center gap-2 font-medium disabled:opacity-50"
                        >
                            <Icon name="Wand2" size={18} />
                            一鍵預排本月值日生
                        </button>

                        <hr className="border-gray-100" />

                        <div className="flex flex-col gap-2 flex-1 min-h-0">
                            <div className="flex justify-between items-end mb-1">
                                <span className="font-bold text-gray-700">員工列表 ({filteredEmployees.length})</span>
                                {/* 部門篩選 Dropdown */}
                                <select 
                                    className="text-xs border border-gray-300 rounded px-2 py-1 bg-white outline-none focus:border-blue-500"
                                    value={selectedDeptFilter}
                                    onChange={(e) => setSelectedDeptFilter(e.target.value)}
                                >
                                    <option value="All">全部部門</option>
                                    {departments.filter(d => d !== 'All').map(dept => (
                                        <option key={dept} value={dept}>{dept}</option>
                                    ))}
                                </select>
                            </div>
                            
                            <div className="space-y-2 overflow-y-auto pr-1 scrollbar-hide max-h-[500px]">
                                {filteredEmployees.length === 0 && !loading && (
                                    <div className="text-center text-gray-400 py-4 text-sm">
                                        無符合條件員工
                                    </div>
                                )}
                                {filteredEmployees.map(emp => {
                                    const uid = emp.ragicId;
                                    const stats = getEmpStats(uid);
                                    const deptName = emp.DEPT || '未分類';
                                    const colors = getDeptColor(deptName);
                                    const isSelected = selectedEmpId === uid;
                                    
                                    // 優先使用顯示名稱
                                    const displayName = emp.DISPLAY_NAME || emp.NAME || `Emp ${uid}`;
                                    // 只顯示兼職的聘雇類別
                                    const hireType = (emp.HIRE_TYPE || "").includes("兼職") ? '(兼職)' : '';
                                    
                                    // 判斷是否為兼職或已滿8天，調整透明度以示區別
                                    const isDimmed = (emp.HIRE_TYPE || "").includes("兼職") || stats.leaveCount >= 8;

                                    return (
                                        <div 
                                            key={uid}
                                            onClick={() => {
                                                console.log("Selected Emp ID:", uid);
                                                setSelectedEmpId(uid);
                                            }}
                                            className={`
                                                cursor-pointer p-3 rounded-lg border-2 transition relative select-none
                                                ${isSelected 
                                                    ? 'border-blue-500 bg-blue-50 ring-2 ring-blue-200' 
                                                    : 'border-transparent bg-gray-50 hover:bg-gray-100'}
                                                ${isDimmed ? 'opacity-60 grayscale-[0.3]' : ''}
                                            `}
                                        >
                                            <div className="flex items-center gap-3">
                                                <div className={`
                                                    w-10 h-10 rounded-full flex items-center justify-center text-white font-bold
                                                    ${colors.bg}
                                                `}>
                                                    {displayName[0]}
                                                </div>
                                                <div className="flex-1">
                                                    <div className="flex justify-between items-center">
                                                        <span className="font-bold text-gray-800">
                                                            {displayName} <span className="text-xs font-normal text-gray-500">{hireType}</span>
                                                        </span>
                                                        <span className={`text-[10px] px-1.5 py-0.5 rounded-full ${colors.tag}`}>
                                                            {deptName}
                                                        </span>
                                                    </div>
                                                    <div className="flex gap-3 text-xs text-gray-500 mt-1">
                                                        <span>
                                                            排休: {stats.leaveCount}
                                                        </span>
                                                        <span>值日: {stats.dutyCount}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            {isSelected && (
                                                <div className="absolute top-1/2 -right-2 transform -translate-y-1/2 bg-blue-500 text-white rounded-l-md p-1 shadow-sm">
                                                    <Icon name="Check" size={14} />
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>

                    {/* Calendar */}
                    <div className="flex-1 bg-white rounded-xl shadow-sm p-4 overflow-hidden flex flex-col border border-gray-100">
                        <div className="grid grid-cols-7 mb-2 text-center text-gray-500 font-medium py-2 border-b">
                            <div className="text-red-500">週日</div>
                            <div>週一</div>
                            <div>週二</div>
                            <div>週三</div>
                            <div>週四</div>
                            <div>週五</div>
                            <div className="text-red-500">週六</div>
                        </div>

                        <div className="grid grid-cols-7 auto-rows-fr flex-1 gap-px bg-gray-200 border border-gray-200">
                            {blanks.map((_, i) => (
                                <div key={`blank-${i}`} className="bg-gray-50/50 min-h-[100px]"></div>
                            ))}
                            
                            {daysInMonth.map((date) => {
                                const dateStr = formatDate(date);
                                const isWeekendDay = isWeekend(date);
                                
                                const dayDuty = duties.find(d => d.DATE === dateStr);
                                const dayLeaves = leaves.filter(l => l.DATE === dateStr);
                                
                                const dutyPerson = dayDuty ? employees.find(e => e.ragicId == dayDuty.EMP_ID || e.NAME === dayDuty.EMP_ID) : null;
                                // 優先顯示 Duty 的顯示名稱
                                const dutyName = dutyPerson ? (dutyPerson.DISPLAY_NAME || dutyPerson.NAME) : (dayDuty ? "未知員工" : "未排");

                                let conflictMsg = null;
                                if (dutyPerson) {
                                    if (dayLeaves.some(l => l.EMP_ID == dutyPerson.ragicId || l.EMP_ID === dutyPerson.NAME)) {
                                        conflictMsg = "衝突：該員已排休";
                                    }
                                    if ((dutyPerson.DEPT || "").includes('設計') && isWeekendDay) {
                                        conflictMsg = "衝突：設計部公休";
                                    }
                                }

                                return (
                                    <div 
                                        key={dateStr} 
                                        onClick={() => handleToggleLeave(dateStr)}
                                        className={`
                                            bg-white min-h-[120px] p-2 flex flex-col gap-1 relative group hover:bg-blue-50/50 transition cursor-pointer
                                            ${formatDate(new Date()) === dateStr ? 'bg-blue-50' : ''}
                                        `}
                                    >
                                        <div className="flex justify-between items-start">
                                            <span className={`
                                                text-sm font-semibold w-6 h-6 flex items-center justify-center rounded-full
                                                ${formatDate(new Date()) === dateStr ? 'bg-blue-600 text-white' : 'text-gray-700'}
                                                ${isWeekendDay ? 'text-red-500' : ''}
                                            `}>
                                                {date.getDate()}
                                            </span>

                                            <div 
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    handleChangeDuty(dateStr, dayDuty);
                                                }}
                                                className={`
                                                    text-[11px] px-1.5 py-0.5 rounded border flex items-center gap-1 max-w-[80px] cursor-pointer hover:opacity-80
                                                    ${conflictMsg 
                                                        ? 'bg-red-100 border-red-300 text-red-700 animate-pulse font-bold' 
                                                        : 'bg-yellow-50 border-yellow-200 text-yellow-800'}
                                                `}
                                            >
                                                <Icon name={conflictMsg ? "AlertTriangle" : "Trash2"} size={10} />
                                                <span className="truncate">
                                                    {dutyName}
                                                </span>
                                            </div>
                                        </div>

                                        <div className="flex-1 mt-1 overflow-y-auto scrollbar-hide space-y-1">
                                            {dayLeaves.map(l => {
                                                const p = employees.find(e => e.ragicId == l.EMP_ID || e.NAME === l.EMP_ID);
                                                const name = p ? (p.DISPLAY_NAME || p.NAME) : `Emp ${l.EMP_ID}`;
                                                const isMyLeave = selectedEmpId && (l.EMP_ID == selectedEmpId);

                                                return (
                                                    <div key={l.ragicId} className="text-[11px] bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded flex items-center justify-between">
                                                        <span className="truncate">{name}</span>
                                                        {isMyLeave && (
                                                            <Icon name="X" size={10} className="text-gray-400" />
                                                        )}
                                                    </div>
                                                );
                                            })}
                                            {isWeekendDay && (
                                                <div className="text-[10px] text-emerald-600/60 text-center mt-2 border-t border-emerald-100 pt-1">
                                                    設計部公休
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {toast && (
                        <div className={`
                            fixed bottom-6 right-6 px-6 py-3 rounded-lg shadow-lg text-white font-medium z-[100] animate-bounce
                            ${toast.type === 'error' ? 'bg-red-500' : (toast.type === 'warning' ? 'bg-orange-500' : 'bg-gray-800')}
                        `}>
                            {toast.msg}
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
