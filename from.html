<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å„ªå¼ç§Ÿå”®ç®¡ç†ï¼çª©çš„å®¶ Wuo Home - ç§Ÿå±‹éœ€æ±‚å°å¹«æ‰‹</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- è¦–è¦ºè¨­è¨ˆæ ¸å¿ƒ --- */
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f8fa;
            margin: 0;
            padding: 20px 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .wizard-container {
            background: white;
            width: 100%;
            max-width: 600px;
            min-height: 80vh;
            height: auto; 
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 120, 148, 0.15);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            margin-bottom: 20px;
        }

        .progress-bar {
            height: 8px;
            background: #e0e0e0;
            width: 100%;
            flex-shrink: 0;
        }
        .progress-fill {
            height: 100%;
            background: #007894;
            width: 10%;
            transition: width 0.3s ease;
        }

        #ragicForm {
            flex: 1;
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        .step-content {
            flex: 1;
            padding: 20px 30px;
            display: none;
            flex-direction: column;
            justify-content: flex-start; 
            animation: fadeIn 0.5s;
            padding-bottom: 40px; 
        }

        .step-content.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h2 {
            color: #007894;
            font-size: 26px;
            margin-bottom: 10px;
            text-align: center;
        }

        p.desc {
            color: #666;
            text-align: center;
            font-size: 16px;
            margin-bottom: 20px;
        }

        /* --- æ¥­å‹™åç‰‡å¡ --- */
        .agent-card-wrapper {
            padding: 20px 20px 0 20px;
            background: #fff;
            border-top: 1px solid #f0f0f0;
        }

        .agent-card {
            background: #eefbfb;
            border: 2px solid #007894;
            border-radius: 12px;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0, 120, 148, 0.05);
            margin-bottom: 5px;
        }
        
        .agent-info {
            text-align: left;
            display: flex;
            flex-direction: column;
        }

        .agent-label {
            font-size: 11px;
            color: #888;
            margin-bottom: 2px;
            letter-spacing: 0.5px;
        }

        .agent-company {
            font-size: 13px;
            color: #005f75;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .agent-name {
            font-size: 20px;
            font-weight: 900;
            color: #007894;
            line-height: 1.2;
        }

        .agent-call-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: #007894;
            color: white;
            padding: 8px 16px;
            border-radius: 50px;
            text-decoration: none;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
            transition: transform 0.2s;
            white-space: nowrap;
        }
        .agent-call-btn:hover {
            transform: scale(1.05);
            background-color: #00657d;
        }
        .agent-call-btn span {
            margin-left: 5px;
        }

        /* è¼¸å…¥æ¡†æ¨£å¼ */
        input[type="text"], input[type="tel"], input[type="number"], select, textarea {
            width: 100%;
            padding: 15px;
            font-size: 20px;
            border: 2px solid #ddd;
            border-radius: 12px;
            margin-bottom: 15px;
            box-sizing: border-box;
            text-align: center;
            font-family: inherit;
        }

        input:focus, textarea:focus, select:focus {
            border-color: #007894;
            outline: none;
            box-shadow: 0 0 0 4px rgba(0, 120, 148, 0.2);
        }

        /* é¸é …æŒ‰éˆ•åŒ– (å…©æ¬„) */
        .option-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        /* é¸é …æŒ‰éˆ•åŒ– (å–®æ¬„ - é ç®—å°ˆç”¨) */
        .option-grid-single {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .multi-select-btn {
            background: #fff;
            border: 2px solid #ddd;
            padding: 12px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            color: #555;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .multi-select-btn.active {
            background-color: #007894;
            color: white;
            border-color: #007894;
        }

        /* åº•éƒ¨æŒ‰éˆ•å€ */
        .footer-btns {
            padding: 10px 30px 20px 30px;
            background: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        button {
            padding: 12px 25px;
            border-radius: 50px;
            font-size: 16px;
            cursor: pointer;
            border: none;
        }

        .btn-prev {
            background: #f0f0f0;
            color: #666;
        }

        .btn-next {
            background: #007894;
            color: white;
            flex: 1;
            margin-left: 20px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0, 120, 148, 0.2);
        }

        #loadingOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 100;
        }
        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #007894;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- Logo & Header --- */
        .logo-header {
            text-align: center;
            padding-top: 25px;
            padding-bottom: 15px;
            flex-shrink: 0;
            background: #fff;
        }
        .logo-title {
            color: #007894;
            font-weight: 900;
            font-size: 24px;
            margin: 0;
            letter-spacing: 1px;
        }
        
        /* --- Footer --- */
        .app-footer {
            background-color: #ffffff;
            border-top: 1px solid #eee;
            padding: 30px 20px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .footer-content {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap; 
            gap: 5px;
            font-size: 13px;
            color: #555;
            line-height: 1.5;
        }
        
        .brand-name {
            color: #005f75;
            font-weight: 900;
        }
        
        .divider {
            color: #ccc;
            margin: 0 2px;
        }

        .footer-map-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background-color: #007894;
            color: #fff;
            border: 1px solid #007894;
            padding: 8px 20px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: bold;
            font-size: 13px;
            transition: all 0.2s;
            box-shadow: 0 4px 10px rgba(0, 120, 148, 0.2);
            margin-top: 5px;
        }
        .footer-map-btn:hover {
            background-color: #00657d;
            transform: translateY(-2px);
        }

        /* æ‰‹æ©Ÿç‰ˆå„ªåŒ– */
        @media screen and (max-width: 600px) {
            body {
                background-color: #fff; 
                padding: 0;
            }
            .wizard-container {
                height: auto; 
                min-height: 100vh;
                max-height: none;
                border-radius: 0;
                box-shadow: none;
                width: 100%;
            }
            .logo-header {
                padding-top: 15px;
                padding-bottom: 10px;
                border-bottom: 1px solid #eee;
            }
            .step-content {
                padding: 15px 20px; 
                justify-content: flex-start; 
                padding-top: 20px;
                padding-bottom: 20px;
            }
            .footer-content {
                flex-direction: column;
                gap: 2px;
            }
            .divider {
                display: none;
            }
            .footer-btns {
                padding: 10px 20px 30px 20px;
            }
        }

        /* æˆå“¡åˆ—è¡¨æ–°æ¨£å¼ (å¡ç‰‡å¼) */
        .member-card {
            background-color: #fff;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            transition: all 0.3s ease;
        }
        .member-title {
            font-weight: bold;
            color: #007894;
            margin-bottom: 8px;
            font-size: 15px;
        }
        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .question-label {
            font-weight: bold;
            color: #007894;
            margin-bottom: 10px;
            text-align: left;
            display: block;
        }

    </style>
</head>
<body>

<div class="wizard-container">
    <!-- Header -->
    <div class="logo-header">
        <h1 class="logo-title">ç§Ÿå±‹éœ€æ±‚å°å¹«æ‰‹</h1>
    </div>
    
    <div class="progress-bar">
        <div class="progress-fill" id="progress"></div>
    </div>

    <!-- è¼‰å…¥ä¸­å‹•ç•« -->
    <div id="loadingOverlay">
        <div class="spinner"></div>
        <p style="margin-top: 20px; color: #007894; font-weight: bold;">è³‡æ–™å‚³é€ä¸­...</p>
    </div>

    <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;"></iframe>

    <form id="ragicForm" target="hidden_iframe" method="POST" action="https://ap15.ragic.com/wuohome/property-data-kept/8?api=true&APIKey=VEZsOEwzYzVJdWdoWXRDM3ptS2YwRUhIcG1iMjI0S2hXT2VieXpCc0p4M21pY29JTnRvL1pueThPTzNVcktWNQ==">
        
        <!-- éš±è—æ¬„ä½ (ç¶­æŒèˆ‡èˆŠç‰ˆä¸€è‡´) -->
        <input type="hidden" name="1000640" id="input_agent_name">
        <input type="hidden" name="1000641" id="input_agent_phone">
        <input type="hidden" name="1000908" id="input_source_mark">
        <input type="hidden" name="1000580" id="field_time">

        <!-- â˜…â˜…â˜… LINE è¤‡è£½æ–‡æ¡ˆ (é‡è¦æ¬„ä½) â˜…â˜…â˜… -->
        <input type="hidden" name="1000970" id="field_line_copy_text">
        
        <!-- STEP 1: åŸºæœ¬è³‡æ–™ -->
        <div class="step-content active" id="step1">
            <h2>ğŸ‘‹ æ‚¨å¥½ï¼</h2>
            <p class="desc">æ­¡è¿ä¾†åˆ°çª©çš„å®¶ã€‚<br>è«‹å…ˆç•™ä¸‹æ‚¨çš„è¯çµ¡æ–¹å¼</p>
            
            <input type="text" id="field_name" name="1000581" placeholder="æ‚¨çš„å§“å / Line æš±ç¨± (å¿…å¡«)" required>
            <input type="tel" id="field_phone" name="1000583" placeholder="æ‰‹æ©Ÿè™Ÿç¢¼ (å¿…å¡«)" required>
            <input type="text" id="field_line" name="1000647" placeholder="LINE ID (é¸å¡«)">
        </div>

        <!-- STEP 2: æˆ¿å±‹éœ€æ±‚ -->
        <div class="step-content" id="step2">
            <h2>ğŸ¢ æˆ¿å±‹é¡å‹èˆ‡æ ¼å±€</h2>
            <p class="desc">è«‹é¸æ“‡æ‚¨éœ€è¦çš„æˆ¿å­</p>
            
            <p class="question-label">1. æˆ¿å±‹é¡åˆ¥ (å¯è¤‡é¸)</p>
            <input type="hidden" id="field_type" name="1000584">
            <div id="type_container" class="option-grid" style="margin-bottom: 25px;">
                <div class="multi-select-btn" onclick="toggleSelection(this, 'type')">é›»æ¢¯å¤§æ¨“</div>
                <div class="multi-select-btn" onclick="toggleSelection(this, 'type')">å…¬å¯“ (ç„¡é›»æ¢¯)</div>
            </div>

            <!-- æ ¼å±€ (è¤‡é¸, å…©æ¬„) -->
            <p class="question-label">2. éœ€è¦æ ¼å±€ (å¯è¤‡é¸)</p>
            <input type="hidden" id="field_layout" name="1000585">
            <div id="layout_container" class="option-grid">
                <div class="multi-select-btn" onclick="toggleSelection(this, 'layout')">é›…æˆ¿</div>
                <div class="multi-select-btn" onclick="toggleSelection(this, 'layout')">å¥—æˆ¿</div>
                <div class="multi-select-btn" onclick="toggleSelection(this, 'layout')">2æˆ¿</div>
                <div class="multi-select-btn" onclick="toggleSelection(this, 'layout')">3æˆ¿</div>
                <div class="multi-select-btn" onclick="toggleSelection(this, 'layout')">4æˆ¿ä»¥ä¸Š</div>
                <div class="multi-select-btn" onclick="toggleSelection(this, 'layout')">åº—é¢</div>
                <div class="multi-select-btn" onclick="toggleSelection(this, 'layout')">å€‰åº«</div>
                <div class="multi-select-btn" onclick="toggleSelection(this, 'layout')">å•†è¾¦</div>
                <div class="multi-select-btn" onclick="toggleSelection(this, 'layout')">å» æˆ¿</div>
                <div class="multi-select-btn" onclick="toggleSelection(this, 'layout')">å…¶ä»–</div>
            </div>
        </div>

        <!-- STEP 3: å…¥ä½è³‡è¨Š -->
        <div class="step-content" id="step3">
            <h2>ğŸ“… å…¥ä½èˆ‡æˆå“¡</h2>
            <p class="desc">è«‹å‘Šè¨´æˆ‘å€‘æ‚¨çš„å…¥ä½è¨ˆç•« (å¿…å¡«)</p>
            
            <p class="question-label">1. é è¨ˆä»€éº¼æ™‚å€™å…¥ä½ï¼Ÿ</p>
            <select name="1000590" id="field_movein" style="margin-bottom: 20px;">
                <option value="">è«‹é¸æ“‡...</option>
                <option value="ä¸ƒå¤©å…§">ä¸ƒå¤©å…§</option>
                <option value="ä¸€å€‹æœˆ">ä¸€å€‹æœˆ</option>
                <option value="å…©å€‹æœˆ">å…©å€‹æœˆ</option>
                <option value="ä¸‰å€‹æœˆä»¥ä¸Š">ä¸‰å€‹æœˆä»¥ä¸Š</option>
            </select>

            <p class="question-label">2. å±…ä½é—œä¿‚èˆ‡äººæ•¸</p>
            <select id="occupant_relation" style="margin-bottom: 10px; text-align-last:center;">
                <option value="">è«‹é¸æ“‡é—œä¿‚...</option>
                <option value="å€‹äººç¨å±…">å€‹äººç¨å±…</option>
                <option value="å¤«å¦»">å¤«å¦»</option>
                <option value="æƒ…ä¾¶">æƒ…ä¾¶</option>
                <option value="å®¶åº­(æœ‰å°å­©/é•·è¼©)">å®¶åº­ (æœ‰å°å­©/é•·è¼©)</option>
                <option value="æœ‹å‹/åŒäº‹åˆç§Ÿ">æœ‹å‹/åŒäº‹åˆç§Ÿ</option>
            </select>

            <select id="occupant_count_select" onchange="renderOccupantInputs()" style="margin-bottom: 20px; text-align-last:center;">
                <option value="">è«‹é¸æ“‡å…¥ä½ç¸½äººæ•¸...</option>
                <option value="1">1ä½</option>
                <option value="2">2ä½</option>
                <option value="3">3ä½</option>
                <option value="4">4ä½</option>
                <option value="5">5ä½</option>
                <option value="6">6ä½</option>
                <option value="7">7ä½</option>
                <option value="8">8ä½</option>
            </select>

            <div id="occupant_dynamic_rows"></div>

            <input type="hidden" name="1000587" id="field_occupants_final">
            <input type="hidden" name="1000586" id="field_occupant_count_final">
        </div>

        <!-- STEP 4: å€åŸŸèˆ‡é ç®— -->
        <div class="step-content" id="step4">
            <h2>ğŸ“ åœ°é»èˆ‡é ç®—</h2>
            <p class="desc">å‘Šè¨´æˆ‘å€‘æ‚¨æƒ³æ‰¾çš„ç¯„åœ</p>
            
            <p class="question-label">1. æƒ³ä½åœ¨å“ªå€‹ç¸£å¸‚ï¼Ÿ</p>
            <select name="1000638" id="field_city" style="margin-bottom: 20px;">
                <option value="">é¸æ“‡ç¸£å¸‚...</option>
                <option value="æ–°åŒ—å¸‚">æ–°åŒ—å¸‚</option>
                <option value="è‡ºåŒ—å¸‚">è‡ºåŒ—å¸‚</option>
                <option value="æ¡ƒåœ’å¸‚">æ¡ƒåœ’å¸‚</option>
            </select>

            <p class="question-label">2. ä¸»è¦æ‰¾æˆ¿å€åŸŸ (ä¾‹å¦‚: ä¸‰é‡ã€æ–°èŠ)</p>
            <input type="text" name="1000639" id="field_area" placeholder="è«‹è¼¸å…¥å€åŸŸ (é¸å¡«)">

            <p class="question-label">3. ç§Ÿé‡‘é ç®— (å«ç®¡ç†è²»/è»Šä½ï¼Œå¯è¤‡é¸)</p>
            <input type="hidden" name="1000588" id="field_budget">
            <div id="budget_container" class="option-grid-single">
                <div class="multi-select-btn" onclick="toggleSelection(this, 'budget')">10,000ä»¥ä¸‹</div>
                <div class="multi-select-btn" onclick="toggleSelection(this, 'budget')">10,000~15,000</div>
                <div class="multi-select-btn" onclick="toggleSelection(this, 'budget')">15,000~20,000</div>
                <div class="multi-select-btn" onclick="toggleSelection(this, 'budget')">20,000~25,000</div>
                <div class="multi-select-btn" onclick="toggleSelection(this, 'budget')">25,000~30,000</div>
                <div class="multi-select-btn" onclick="toggleSelection(this, 'budget')">30,000~35,000</div>
                <div class="multi-select-btn" onclick="toggleSelection(this, 'budget')">35,000~40,000</div>
                <div class="multi-select-btn" onclick="toggleSelection(this, 'budget')">40,000~45,000</div>
                <div class="multi-select-btn" onclick="toggleSelection(this, 'budget')">45,000~50,000</div>
                <div class="multi-select-btn" onclick="toggleSelection(this, 'budget')">50,000ä»¥ä¸Š</div>
            </div>
        </div>

        <!-- STEP 5: ç¿’æ…£èˆ‡éœ€æ±‚ -->
        <div class="step-content" id="step5">
            <h2>ğŸ“ ç¿’æ…£èˆ‡éœ€æ±‚</h2>
            <p class="desc">å‹¾é¸ç¬¦åˆçš„æƒ…æ³ (å¯è¤‡é¸ï¼Œç„¡å‰‡å…å¡«)</p>

            <p class="question-label">1. ç§Ÿå±‹ç¿’æ…£</p>
            <input type="hidden" name="1000591" id="field_habits">
            <div id="habits_container" class="option-grid">
                <div class="multi-select-btn" onclick="toggleSelection(this, 'habits')">æœ‰æŠ½è¸</div>
                <div class="multi-select-btn" onclick="toggleSelection(this, 'habits')">é¤Šè²“</div>
                <div class="multi-select-btn" onclick="toggleSelection(this, 'habits')">é¤Šç‹—</div>
                <div class="multi-select-btn" onclick="toggleSelection(this, 'habits')">éœ€è¦è¨­ç¥æ˜å»³</div>
            </div>

            <p class="question-label" style="margin-top:20px;">2. å¿…è¦éœ€æ±‚</p>
            <input type="hidden" name="1000592" id="field_needs">
            <div id="needs_container" class="option-grid">
                <div class="multi-select-btn" onclick="toggleSelection(this, 'needs')">å…¬å¸ç‡Ÿç™»</div>
                <div class="multi-select-btn" onclick="toggleSelection(this, 'needs')">å…¬å¸å ±ç¨…</div>
                <div class="multi-select-btn" onclick="toggleSelection(this, 'needs')">ç§Ÿå±‹è£œåŠ©</div>
                <div class="multi-select-btn" onclick="toggleSelection(this, 'needs')">å…¥æˆ¶ç±</div>
                <div class="multi-select-btn" onclick="toggleSelection(this, 'needs')">æ±½è»Šä½</div>
                <!-- æ–°å¢é™„å‚¢ä¿±é¸é … -->
                <div class="multi-select-btn" onclick="toggleSelection(this, 'needs')">é™„å‚¢ä¿±</div>
                <div class="multi-select-btn" onclick="toggleSelection(this, 'needs')">ä»¥ä¸Šçš†ç„¡éœ€æ±‚</div>
            </div>

            <p class="question-label" style="margin-top:20px;">3. æƒ³å°æˆ‘å€‘èªªçš„è©±</p>
            <textarea name="1000648" rows="4" placeholder="é‚„æœ‰ä»€éº¼æƒ³å‘Šè¨´æˆ‘å€‘çš„å—ï¼Ÿ(é¸å¡«)" style="width:100%; padding:15px; border-radius:12px; border:2px solid #ddd;"></textarea>
        </div>

         <!-- STEP 6: å®Œæˆ -->
         <div class="step-content" id="step6">
            <h2 style="font-size: 32px; margin-bottom: 5px;">ğŸ‰ æ„Ÿè¬æ‚¨ï¼</h2>
            <p class="desc">æ‚¨çš„éœ€æ±‚å·²é€å‡ºï¼Œæˆ‘å€‘å°‡ç›¡å¿«ç‚ºæ‚¨æœå‹™ã€‚</p>
            <p class="desc" style="font-size: 14px; margin-top: 20px;">æ‚¨ä¹Ÿå¯ä»¥ç›´æ¥æ’¥æ‰“ä¸‹æ–¹é›»è©±è¯ç¹«æˆ‘å€‘</p>
        </div>

    </form>

    <div class="agent-card-wrapper" id="agentCardWrapper">
        <div class="agent-card">
            <div class="agent-info">
                <div class="agent-company">å„ªå¼ç§Ÿå”®ç®¡ç† - çª©çš„å®¶ä¸‰é‡åŠ ç›Ÿåº—</div>
                <div class="agent-label" id="display_agent_label">æ‚¨çš„å°ˆå±¬ç§Ÿå±‹é¡§å•</div>
                <div class="agent-name" id="display_agent_name">å¼µç“Šå®‰</div>
            </div>
            <a href="#" id="display_agent_call" class="agent-call-btn">
                ğŸ“ <span id="display_agent_phone_text">é€šè©±</span>
            </a>
        </div>
    </div>

    <div class="footer-btns">
        <button class="btn-prev" id="prevBtn" onclick="prevStep()">ä¸Šä¸€æ­¥</button>
        <button class="btn-next" id="nextBtn" onclick="nextStep()">ä¸‹ä¸€æ­¥</button>
    </div>

    <div class="app-footer" id="appFooter">
        <div class="footer-content">
            <span class="brand-name">å„ªå¼ç§Ÿå”®ç®¡ç†ï¼çª©çš„å®¶ Wuo Home</span>
            <span class="divider">|</span>
            <span class="address-text">åº—é¢åœ°å€ï¼šæ–°åŒ—å¸‚ä¸‰é‡å€å¤§æ¦®è¡—20è™Ÿ1æ¨“</span>
        </div>
        <a href="https://share.google/ZcjTXzNXkE1N7RjfV" target="_blank" class="footer-map-btn">
            <i class="fas fa-location-dot"></i> é–‹å•Ÿ Google Maps å°èˆª
        </a>
    </div>
</div>

<script>
    let defaultAgentName = ""; 
    let defaultAgentPhone = "02 2286 5755"; 

    const urlParams = new URLSearchParams(window.location.search);
    const agentNameParam = (urlParams.get('agent') || "").trim();
    const agentPhoneParam = (urlParams.get('phone') || "").trim();

    const agentName = agentNameParam ? agentNameParam : defaultAgentName;
    const agentPhone = agentPhoneParam ? agentPhoneParam : defaultAgentPhone;

    // Ragic API
    const ragicApiUrl = "https://ap15.ragic.com/wuohome/property-data-kept/8?api=true&APIKey=VEZsOEwzYzVJdWdoWXRDM3ptS2YwRk9mUjFib2tWVXJ1RitpTGNSWk94R3YzbVVPU0JJaThraUkxVzRQbEFaOQ==";

    // è³‡æ–™æš«å­˜
    let occupantList = [];
    let selectedHabits = [];
    let selectedNeeds = [];
    let selectedBudget = []; 
    let selectedLayout = [];
    let selectedType = []; 

    // --- å±…ä½æˆå“¡é‚è¼¯ ---
    document.getElementById('occupant_relation').addEventListener('change', function() {
        if (this.value === 'å€‹äººç¨å±…') {
            const cnt = document.getElementById('occupant_count_select');
            cnt.value = "1";
            renderOccupantInputs();
        }
    });

    document.getElementById('field_name').addEventListener('input', function() {
        const firstNameInput = document.querySelector('#occupant_dynamic_rows .member-card:first-child .occ-name');
        if (firstNameInput) {
            firstNameInput.value = this.value;
        }
    });

    function renderOccupantInputs() {
        const countSelect = document.getElementById('occupant_count_select');
        const count = parseInt(countSelect.value);
        const container = document.getElementById('occupant_dynamic_rows');
        const mainName = document.getElementById('field_name').value || '';
        
        const currentData = [];
        document.querySelectorAll('.member-card').forEach(card => {
            currentData.push({
                name: card.querySelector('.occ-name').value,
                age: card.querySelector('.occ-age').value,
                job: card.querySelector('.occ-job').value
            });
        });

        container.innerHTML = '';
        if (!count) return;

        for (let i = 1; i <= count; i++) {
            const isSelf = (i === 1);
            let valName = isSelf ? mainName : '';
            let valAge = '';
            let valJob = '';

            if (currentData[i-1]) {
                if (!isSelf) valName = currentData[i-1].name;
                valAge = currentData[i-1].age;
                valJob = currentData[i-1].job;
            } else if (isSelf) {
                valName = mainName;
            }

            const readonlyAttr = isSelf ? 'readonly' : '';
            const bgClass = isSelf ? 'background-color: #f0fbff; border-color: #bde0ef;' : 'background-color: #fff; border-color: #ddd;';
            const titleText = isSelf ? '1. æœ¬äºº' : `${i}. åŒä½äºº`;
            const namePlaceholder = isSelf ? 'å§“å (è‡ªå‹•å¸¶å…¥)' : 'å§“å (å¿…å¡«)';
            const titleColor = isSelf ? '#007894' : '#555';

            const html = `
            <div class="member-card" style="${bgClass}">
                <div class="member-title" style="color:${titleColor}">${titleText}</div>
                <div class="input-row">
                    <input type="text" class="occ-name" value="${valName}" placeholder="${namePlaceholder}" ${readonlyAttr} style="flex:1; margin-bottom:0; font-size:16px; padding:12px;">
                    <input type="text" class="occ-age" value="${valAge}" placeholder="å¹´é½¡" style="flex:1; margin-bottom:0; font-size:16px; padding:12px;">
                </div>
                <input type="text" class="occ-job" value="${valJob}" placeholder="è·æ¥­ (å¿…å¡«)" style="width:100%; margin-bottom:0; font-size:16px; padding:12px;">
            </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }
    }

    function updateOccupantListFromDOM() {
        occupantList = [];
        const cards = document.querySelectorAll('.member-card');
        cards.forEach(card => {
            const name = card.querySelector('.occ-name').value.trim();
            const age = card.querySelector('.occ-age').value.trim();
            const job = card.querySelector('.occ-job').value.trim();
            if(name || job || age) {
                occupantList.push({name, age, job});
            }
        });
        updateOccupantHiddenField();
    }

    function updateOccupantHiddenField() {
        const relation = document.getElementById('occupant_relation').value;
        const count = occupantList.length;
        
        let finalString = "";
        if (relation) {
            finalString += `å±…ä½é—œä¿‚ï¼š${relation}`;
            if (count > 0) finalString += `ï¼ˆå…±${count}äººï¼‰`;
            finalString += `\n\n`;
        }
        occupantList.forEach((person, index) => {
            let text = `${index + 1}. ${person.name}`;
            if (person.age) text += ` / ${person.age}æ­²`;
            if (person.job) text += ` / ${person.job}`;
            finalString += text + "\n";
        });
        
        // ç¢ºä¿å¯«å…¥åˆ° 1000587
        const finalField = document.getElementById('field_occupants_final');
        if(finalField) finalField.value = finalString;
        
        // å¯«å…¥äººæ•¸
        let countText = "";
        const selectVal = document.getElementById('occupant_count_select').value;
        if(selectVal) countText = selectVal + "ä½";
        else countText = count + "ä½";
        
        const countField = document.getElementById('field_occupant_count_final');
        if(countField) countField.value = countText;
    }

    // --- å¤šé¸æŒ‰éˆ•é‚è¼¯ ---
    function toggleSelection(btn, type) {
        const value = btn.innerText;

        // äº’æ–¥é‚è¼¯
        if (type === 'needs') {
            const noneOptionText = "ä»¥ä¸Šçš†ç„¡éœ€æ±‚";
            const container = document.getElementById('needs_container');

            if (value === noneOptionText) {
                if (selectedNeeds.includes(noneOptionText)) {
                    selectedNeeds = [];
                    btn.classList.remove('active');
                } else {
                    selectedNeeds = [noneOptionText];
                    container.querySelectorAll('.multi-select-btn').forEach(b => {
                        b.classList.remove('active');
                    });
                    btn.classList.add('active');
                }
            } else {
                if (selectedNeeds.includes(noneOptionText)) {
                    selectedNeeds = selectedNeeds.filter(x => x !== noneOptionText);
                    container.querySelectorAll('.multi-select-btn').forEach(b => {
                        if (b.innerText === noneOptionText) b.classList.remove('active');
                    });
                }
                if (selectedNeeds.includes(value)) {
                    selectedNeeds = selectedNeeds.filter(item => item !== value);
                    btn.classList.remove('active');
                } else {
                    selectedNeeds.push(value);
                    btn.classList.add('active');
                }
            }
            document.getElementById('field_needs').value = selectedNeeds.join(',');
            return;
        }

        // ä¸€èˆ¬å¤šé¸
        btn.classList.toggle('active');
        
        let list;
        if (type === 'habits') list = selectedHabits;
        else if (type === 'budget') list = selectedBudget;
        else if (type === 'layout') list = selectedLayout;
        else if (type === 'type') list = selectedType;
        
        if (list.includes(value)) {
            if (type === 'habits') selectedHabits = selectedHabits.filter(item => item !== value);
            else if (type === 'budget') selectedBudget = selectedBudget.filter(item => item !== value);
            else if (type === 'layout') selectedLayout = selectedLayout.filter(item => item !== value);
            else if (type === 'type') selectedType = selectedType.filter(item => item !== value);
        } else {
            if (type === 'habits') selectedHabits.push(value);
            else if (type === 'budget') selectedBudget.push(value);
            else if (type === 'layout') selectedLayout.push(value);
            else if (type === 'type') selectedType.push(value);
        }

        // å³æ™‚æ›´æ–°éš±è—æ¬„ä½
        if (type === 'habits') document.getElementById('field_habits').value = selectedHabits.join(',');
        else if (type === 'budget') document.getElementById('field_budget').value = selectedBudget.join(',');
        else if (type === 'layout') document.getElementById('field_layout').value = selectedLayout.join(',');
        else if (type === 'type') document.getElementById('field_type').value = selectedType.join(',');
    }

    function initAgentInfo() {
        const nameEl = document.getElementById('display_agent_name');
        const labelEl = document.getElementById('display_agent_label');

        const telLink = 'tel:' + String(agentPhone).replace(/[^\d+]/g, '');
        document.getElementById('display_agent_call').href = telLink;
        document.getElementById('display_agent_phone_text').innerText = 'æ’¥æ‰“é›»è©±';

        if (!agentNameParam) {
            nameEl.style.display = 'none';
            labelEl.style.display = 'none';
            document.getElementById('input_agent_name').value = "";
        } else {
            nameEl.style.display = 'block';
            labelEl.style.display = 'block';
            nameEl.innerText = agentName;
            document.getElementById('input_agent_name').value = agentName;
        }
        document.getElementById('input_agent_phone').value = agentPhone;
    }

    // --- æ–‡æ¡ˆç”Ÿæˆ ---
    function generateLineCopyText() {
        // å†æ¬¡ç¢ºä¿æŠ“åˆ°æœ€æ–°DOM
        updateOccupantListFromDOM();

        const city = document.getElementById('field_city').value || "";
        const area = document.getElementById('field_area').value || "";
        const locationText = `${city} ${area}`.trim();

        const typeText = selectedType.length > 0 ? selectedType.join('ã€') : "æœªé¸æ“‡";

        const layoutSet = new Set(selectedLayout.map(x => x === "å» æˆ¿" ? "å» è¾¦" : x));
        const hasBizGroup = (layoutSet.has("åº—é¢") || layoutSet.has("å€‰åº«") || layoutSet.has("å•†è¾¦") || layoutSet.has("å» è¾¦"));
        if (hasBizGroup) {
            layoutSet.delete("åº—é¢");
            layoutSet.delete("å€‰åº«");
            layoutSet.delete("å•†è¾¦");
            layoutSet.delete("å» è¾¦");
        }
        const ordered = [];
        ["2æˆ¿","3æˆ¿","4æˆ¿ä»¥ä¸Š"].forEach(x => { if (layoutSet.has(x)) { ordered.push(x); layoutSet.delete(x); } });
        if (hasBizGroup) ordered.push("åº—é¢/å€‰åº«/å•†è¾¦/å» è¾¦");
        selectedLayout.forEach(x => {
            const v = (x === "å» æˆ¿") ? "å» è¾¦" : x;
            if (layoutSet.has(v)) {
                ordered.push(v);
                layoutSet.delete(v);
            }
        });
        const layoutText = ordered.length > 0 ? ordered.join('ã€') : "æœªé¸æ“‡";

        const count = occupantList.length;
        const countText = String(count);
        const relation = document.getElementById('occupant_relation').value || "æœªå¡«å¯«";

        const memberDetailsArr = occupantList.map(p => {
            const n = (p.name || "").trim();
            const j = (p.job || "").trim();
            const a = (p.age || "").trim();
            const parts = [];
            if (n) parts.push(n);
            if (j) parts.push(j);
            if (a) parts.push(a + "æ­²");
            return parts.join(' / ');
        });
        const memberDetailsText = memberDetailsArr.join('ã€');
        
        const hasSmoking = selectedHabits.includes("æœ‰æŠ½è¸");
        const hasGod = selectedHabits.includes("éœ€è¦è¨­ç¥æ˜å»³");
        const hasPet = (selectedHabits.includes("é¤Šè²“") || selectedHabits.includes("é¤Šç‹—"));
        const hasSubsidy = selectedNeeds.includes("ç§Ÿå±‹è£œåŠ©");
        const hasRegister = selectedNeeds.includes("å…¥æˆ¶ç±");
        const hasCar = selectedNeeds.includes("æ±½è»Šä½");
        const hasFurniture = selectedNeeds.includes("é™„å‚¢ä¿±");

        const needLines = [
            `${hasPet ? "â­•ï¸" : "âŒ"}é¤Šå¯µç‰©`,
            `${hasSubsidy ? "â­•ï¸" : "âŒ"}ç§Ÿå±‹è£œåŠ©`,
            `${hasRegister ? "â­•ï¸" : "âŒ"}å…¥ç±`,
            `${hasSmoking ? "â­•ï¸" : "âŒ"}æŠ½è¸`,
            `${hasGod ? "â­•ï¸" : "âŒ"}è¨­ç¥æ˜å»³`,
            `${hasCar ? "â­•ï¸" : "âŒ"}æ±½è»Šä½`
        ];

        const furnitureText = `å®¶å…·éœ€æ±‚ï¼š${hasFurniture ? "â­•ï¸é™„å‚¢ä¿±" : "âŒç©ºå±‹å³å¯"}`;

        const budgetTextArr = selectedBudget.map(b => {
            const s = String(b).trim();
            if (!s) return "";
            if (s.includes("ä»¥ä¸Š")) return s.replace("ä»¥ä¸Š", " å…ƒä»¥ä¸Š");
            if (s.includes("ä»¥ä¸‹")) return s.replace("ä»¥ä¸‹", "ä»¥ä¸‹");
            if (s.includes("~")) return s.replace("~", "â€“") + " å…ƒ";
            return s;
        }).filter(x => x !== "");
        const budgetText = budgetTextArr.length > 0 ? budgetTextArr.join('ã€') : "æœªå¡«å¯«";

        const final = 
`å€åŸŸï¼š${locationText}
é¡å‹ï¼š${typeText}
æˆ¿å‹ï¼š${layoutText}

å…¥ä½äººæ•¸ï¼š${countText} ä½
é—œä¿‚ï¼š${relation}ï¼ˆ${memberDetailsText}ï¼‰

éœ€æ±‚ï¼š
${needLines.join('\n')}

${furnitureText}
é ç®—ï¼š${budgetText}`;

        return final;
    }


    let currentStep = 1;
    const totalSteps = 6;

    function updateUI() {
        for(let i=1; i<=totalSteps; i++) {
            document.getElementById('step'+i).classList.remove('active');
        }
        document.getElementById('step'+currentStep).classList.add('active');
        document.getElementById('progress').style.width = ((currentStep / totalSteps) * 100) + '%';

        if(currentStep === 1) {
            document.getElementById('prevBtn').style.visibility = 'hidden';
        } else {
            document.getElementById('prevBtn').style.visibility = 'visible';
        }

        const footer = document.getElementById('appFooter');
        const agentCard = document.getElementById('agentCardWrapper');
        
        if (currentStep === 1 || currentStep === totalSteps) {
            footer.style.display = 'flex';
            agentCard.style.display = 'block'; 
        } else {
            footer.style.display = 'none';
            agentCard.style.display = 'none'; 
        }

        if(currentStep === totalSteps) {
             document.querySelector('.footer-btns').style.display = 'none';
        } else if (currentStep === totalSteps - 1) { 
            document.getElementById('nextBtn').innerText = 'ç¢ºèªé€å‡º';
            document.getElementById('nextBtn').style.backgroundColor = '#e74c3c'; 
            document.querySelector('.footer-btns').style.display = 'flex'; 
        } else {
            document.getElementById('nextBtn').innerText = 'ä¸‹ä¸€æ­¥';
            document.getElementById('nextBtn').style.backgroundColor = '#007894';
            document.querySelector('.footer-btns').style.display = 'flex'; 
        }
    }

    function nextStep() {
        if (currentStep === 1) {
            const name = document.getElementById('field_name').value;
            const phone = document.getElementById('field_phone').value;
            if (!name) { alert('è«‹å¡«å¯«å§“åå–”ï¼'); return; }
            if (!phone) { alert('è«‹å¡«å¯«æ‰‹æ©Ÿè™Ÿç¢¼å–”ï¼'); return; }
        }
        else if (currentStep === 2) { 
            if (selectedType.length === 0) { alert('è«‹é¸æ“‡æˆ¿å±‹é¡å‹ï¼'); return; }
            if (selectedLayout.length === 0) { alert('è«‹é¸æ“‡æ‚¨éœ€è¦çš„æ ¼å±€ï¼'); return; }
        }
        else if (currentStep === 3) { 
            const moveIn = document.getElementById('field_movein').value;
            const relation = document.getElementById('occupant_relation').value;
            const countVal = document.getElementById('occupant_count_select').value;

            if (!moveIn) { alert('è«‹é¸æ“‡é è¨ˆå…¥ä½æ™‚é–“å–”ï¼'); return; }
            if (!relation) { alert('è«‹é¸æ“‡ã€Œå±…ä½é—œä¿‚ã€å–”ï¼'); return; }
            if (!countVal) { alert('è«‹é¸æ“‡ã€Œå…¥ä½ç¸½äººæ•¸ã€å–”ï¼'); return; }

            // æª¢æŸ¥å¿…å¡«
            const cards = document.querySelectorAll('.member-card');
            let allValid = true;
            cards.forEach(card => {
                const name = card.querySelector('.occ-name').value.trim();
                const job = card.querySelector('.occ-job').value.trim();
                if (!name || !job) {
                    allValid = false;
                    if(!name) card.querySelector('.occ-name').style.borderColor = "red";
                    if(!job) card.querySelector('.occ-job').style.borderColor = "red";
                }
            });

            if (!allValid) {
                alert('è«‹å®Œæ•´å¡«å¯«æ¯ä½æˆå“¡çš„ã€Œå§“åã€èˆ‡ã€Œè·æ¥­ã€å–”ï¼');
                return;
            }
            updateOccupantListFromDOM();
        }
        else if (currentStep === 4) { 
            const city = document.getElementById('field_city').value;
            if (!city) { alert('è«‹é¸æ“‡ç¸£å¸‚ï¼'); return; }
            if (selectedBudget.length === 0) { alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹é ç®—ç¯„åœï¼'); return; }
        }

        if(currentStep < totalSteps - 1) { 
            currentStep++;
            updateUI();
        } else if (currentStep === totalSteps - 1) { 
            submitForm();
        }
    }

    function prevStep() {
        if(currentStep > 1) {
            currentStep--;
            updateUI();
        }
    }

    function submitForm() {
        document.getElementById('loadingOverlay').style.display = 'flex';
        
        const timestamp = new Date().getTime();
        document.getElementById('input_source_mark').value = 'wizard_v1_' + timestamp;
        
        const now = new Date();
        const timeString = now.getFullYear() + "/" + 
                          ("0" + (now.getMonth()+1)).slice(-2) + "/" + 
                          ("0" + now.getDate()).slice(-2) + " " + 
                          ("0" + now.getHours()).slice(-2) + ":" + 
                          ("0" + now.getMinutes()).slice(-2) + ":" + 
                          ("0" + now.getSeconds()).slice(-2);
        document.getElementById('field_time').value = timeString;

        // â˜…â˜…â˜… é—œéµä¿®å¾©ï¼šé€å‡ºå‰å¼·åˆ¶åŒæ­¥ä¸€æ¬¡æˆå“¡åå–®ï¼Œå†ç”¢ç”Ÿæ–‡æ¡ˆ â˜…â˜…â˜…
        updateOccupantHiddenField();
        
        // ç¢ºä¿ field_line_copy_text çœŸçš„è¢«å¡«å…¥
        const lineCopyField = document.getElementById('field_line_copy_text');
        if(lineCopyField) {
            lineCopyField.value = generateLineCopyText();
        }

        const form = document.getElementById('ragicForm');
        form.submit();

        setTimeout(() => {
            document.getElementById('loadingOverlay').style.display = 'none';
            currentStep = totalSteps; 
            updateUI();
        }, 1500);
    }

    initAgentInfo(); 
    updateUI();
    window.addEventListener('resize', updateUI);
</script>

</body>
</html>

