<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çª©çš„å®¶ - ç§Ÿå±‹éœ€æ±‚å°å¹«æ‰‹</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        /* --- è¦–è¦ºè¨­è¨ˆæ ¸å¿ƒï¼šå¤§ã€æ¸…æ¥šã€å‹å–„ --- */
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f8fa; /* æ·ºè—è‰²èƒŒæ™¯ */
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .wizard-container {
            background: white;
            width: 100%;
            max-width: 600px;
            height: 90vh; /* æ‰‹æ©Ÿä¸Šå¹¾ä¹æ»¿ç‰ˆ */
            max-height: 800px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 120, 148, 0.15);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* é ‚éƒ¨é€²åº¦æ¢ */
        .progress-bar {
            height: 8px;
            background: #e0e0e0;
            width: 100%;
            flex-shrink: 0; /* ä¸å£“ç¸® */
        }
        .progress-fill {
            height: 100%;
            background: #007894;
            width: 10%; /* åˆå§‹é€²åº¦ */
            transition: width 0.3s ease;
        }

        /* è¡¨å–®å€åŸŸ (è¨­ç‚ºå¯æ²å‹•ï¼Œé¿å…å…§å®¹è¢«åç‰‡æ“‹ä½) */
        #ragicForm {
            flex: 1; /* ä½”æ“šå‰©é¤˜ç©ºé–“ */
            overflow-y: auto; /* å…§å®¹éé•·æ™‚å¯æ²å‹• */
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        /* å…§å®¹å€åŸŸ */
        .step-content {
            flex: 1;
            padding: 20px 30px; /* ä¸Šä¸‹ padding ç¨å¾®ç¸®å°ï¼Œç•™ç©ºé–“çµ¦åç‰‡ */
            display: none; /* é è¨­éš±è—ï¼Œé€é JS åˆ‡æ› */
            flex-direction: column;
            justify-content: center;
            animation: fadeIn 0.5s;
            min-height: min-content; /* ç¢ºä¿å…§å®¹ä¸æœƒè¢«éåº¦å£“ç¸® */
        }

        .step-content.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* å¤§æ¨™é¡Œ */
        h2 {
            color: #007894;
            font-size: 26px; /* ç¨å¾®ç¸®å°ä¸€é»é»é©é…æ‰‹æ©Ÿ */
            margin-bottom: 10px;
            text-align: center;
        }

        p.desc {
            color: #666;
            text-align: center;
            font-size: 16px;
            margin-bottom: 20px;
        }

        /* --- æ¥­å‹™åç‰‡å¡ (å…¨åŸŸç‰ˆ) - å„ªåŒ–æ’ç‰ˆ --- */
        .agent-card-wrapper {
            padding: 0 20px;
            background: #fff;
            flex-shrink: 0; /* ä¸å£“ç¸® */
            z-index: 10;
        }

        .agent-card {
            background: #eefbfb;
            border: 2px solid #007894;
            border-radius: 12px;
            padding: 12px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0, 120, 148, 0.1);
            margin-bottom: 10px;
        }
        
        .agent-info {
            text-align: left;
            display: flex;
            flex-direction: column; /* å‚ç›´æ’åˆ— */
        }

        .agent-label {
            font-size: 11px; /* ç¸®å° */
            color: #888; /* æ·ºç°è‰² */
            margin-bottom: 2px;
            letter-spacing: 0.5px;
        }

        .agent-company {
            font-size: 13px; /* ä¸­å°å­— */
            color: #005f75; /* æ·±ä¸€é»çš„å“ç‰Œè‰² */
            font-weight: 500;
            margin-bottom: 2px;
        }

        .agent-name {
            font-size: 20px; /* åŠ å¤§åå­— */
            font-weight: 900;
            color: #007894;
            line-height: 1.2;
        }

        .agent-call-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: #007894;
            color: white;
            padding: 10px 18px; /* åŠ å¤§ä¸€é»æŒ‰éˆ• */
            border-radius: 50px;
            text-decoration: none;
            font-size: 15px;
            font-weight: bold;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
            transition: transform 0.2s;
            white-space: nowrap;
        }
        .agent-call-btn:hover {
            transform: scale(1.05);
            background-color: #00657d;
        }
        .agent-call-btn span {
            margin-left: 5px;
        }

        /* è¶…å¤§è¼¸å…¥æ¡† */
        input[type="text"], input[type="tel"], input[type="number"], select {
            width: 100%;
            padding: 15px;
            font-size: 20px;
            border: 2px solid #ddd;
            border-radius: 12px;
            margin-bottom: 15px;
            box-sizing: border-box;
            text-align: center;
        }

        input:focus {
            border-color: #007894;
            outline: none;
            box-shadow: 0 0 0 4px rgba(0, 120, 148, 0.2);
        }

        /* é¸é …æŒ‰éˆ•åŒ– (å–ä»£ä¸‹æ‹‰é¸å–®ï¼Œæ›´å¥½é») */
        .option-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .option-btn {
            background: #f4f7f6;
            border: 2px solid #ddd;
            padding: 15px;
            border-radius: 12px;
            font-size: 18px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .option-btn:hover, .option-btn.selected {
            background: #e6f7fa;
            border-color: #007894;
            color: #007894;
            font-weight: bold;
        }

        /* åº•éƒ¨æŒ‰éˆ•å€ */
        .footer-btns {
            padding: 15px 30px;
            background: #fff;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0; /* ä¸å£“ç¸® */
            padding-bottom: 20px; /* æ‰‹æ©Ÿåº•éƒ¨ç•™ç™½ */
        }

        button {
            padding: 12px 25px;
            border-radius: 50px;
            font-size: 16px;
            cursor: pointer;
            border: none;
        }

        .btn-prev {
            background: #f0f0f0;
            color: #666;
        }

        .btn-next {
            background: #007894;
            color: white;
            flex: 1;
            margin-left: 20px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0, 120, 148, 0.2);
        }

        /* æ¸¬è©¦æŒ‰éˆ•æ¨£å¼ */
        .btn-test {
            background: transparent;
            color: #999;
            border: 1px dashed #ccc;
            padding: 8px 10px;
            font-size: 12px;
            margin: 0 5px;
        }
        .btn-test:hover {
            color: #555;
            border-color: #888;
        }
        
        /* è¼‰å…¥ä¸­é®ç½© */
        #loadingOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 100;
        }
        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #007894;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* LOGO */
        .logo-header {
            text-align: center;
            padding-top: 15px;
            padding-bottom: 10px;
            flex-shrink: 0;
        }
        .logo-text {
            color: #007894;
            font-weight: bold;
            font-size: 20px;
        }

        /* --- æ–°å¢ï¼šæˆå“¡åˆ—è¡¨æ¨£å¼ --- */
        .occupant-entry {
            background: #fff;
            border: 1px dashed #ccc;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 16px;
        }
        .occupant-entry span {
            color: #333;
        }
        .delete-btn {
            color: #e74c3c;
            cursor: pointer;
            font-weight: bold;
            padding: 5px 10px;
            background: #fff0f0;
            border-radius: 5px;
            font-size: 14px;
        }
        .add-occupant-box {
            background: #f4fbfc;
            border: 2px solid #e0eef2;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
        }
        .add-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .add-btn {
            width: 100%;
            background-color: #007894;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
        }
        .add-btn:hover {
            background-color: #00657d;
        }

    </style>
</head>
<body>

<div class="wizard-container">
    <div class="logo-header">
        <div class="logo-text">ğŸ  WuoHome çª©çš„å®¶</div>
    </div>
    
    <div class="progress-bar">
        <div class="progress-fill" id="progress"></div>
    </div>

    <!-- è¼‰å…¥ä¸­å‹•ç•« -->
    <div id="loadingOverlay">
        <div class="spinner"></div>
        <p style="margin-top: 20px; color: #007894; font-weight: bold;">è³‡æ–™å‚³é€ä¸­...</p>
    </div>

    <!-- éš±è—çš„ iframeï¼Œä½œç‚ºè¡¨å–®æäº¤çš„å‚™æ¡ˆ -->
    <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;"></iframe>

    <!-- è¡¨å–® -->
    <!-- target è¨­å®šç‚º hidden_iframeï¼Œaction è¨­å®šç‚º API ç¶²å€ -->
    <form id="ragicForm" target="hidden_iframe" method="POST" action="https://ap15.ragic.com/wuohome/property-data-kept/8?api=true&APIKey=Nm5QVzFtZ1pGYzZIT1REUnBhY3A0bDVKY0luaEh3d2lrSmMzTHNSVjh3N1VHc1JadWJjQk9yZDQ3UlpZZnFubQ==">
        
        <!-- éš±è—æ¬„ä½ï¼šæ¥­å‹™è³‡æ–™ -->
        <input type="hidden" name="1000640" id="input_agent_name">
        <input type="hidden" name="1000641" id="input_agent_phone">
        
        <!-- ä¾†æºæ¨™è¨˜ -->
        <input type="hidden" name="1000908" id="input_source_mark">
        
        <!-- STEP 1: æ­¡è¿èˆ‡å§“å -->
        <div class="step-content active" id="step1">
            <h2>ğŸ‘‹ æ‚¨å¥½ï¼</h2>
            <p class="desc">æ­¡è¿ä¾†åˆ°çª©çš„å®¶ã€‚<br>è«‹å•æˆ‘å€‘è¦æ€éº¼ç¨±å‘¼æ‚¨ï¼Ÿ</p>
            <input type="text" id="field_name" name="1000581" placeholder="è«‹è¼¸å…¥æ‚¨çš„ç¨±å‘¼ (å¿…å¡«)" required onkeydown="if(event.key === 'Enter') { nextStep(); return false; }">
        </div>

        <!-- STEP 2: é›»è©± -->
        <div class="step-content" id="step2">
            <h2>ğŸ“ è¯çµ¡é›»è©±</h2>
            <p class="desc">æ–¹ä¾¿æˆ‘å€‘è¯çµ¡åˆ°æ‚¨çš„æ‰‹æ©Ÿè™Ÿç¢¼</p>
            <input type="tel" id="field_phone" name="1000583" placeholder="09xx-xxx-xxx (å¿…å¡«)" required onkeydown="if(event.key === 'Enter') { nextStep(); return false; }">
        </div>

        <!-- STEP 3: æˆ¿å±‹é¡åˆ¥ -->
        <div class="step-content" id="step3">
            <h2>ğŸ¢ æƒ³æ‰¾ä»€éº¼æ¨£çš„æˆ¿å­ï¼Ÿ</h2>
            <p class="desc">è«‹é¸æ“‡æ‚¨å–œæ­¡çš„é¡å‹</p>
            <input type="hidden" id="field_type" name="1000584">
            <div class="option-grid">
                <div class="option-btn" onclick="selectOption('field_type', 'é›»æ¢¯', this)">é›»æ¢¯å¤§æ¨“</div>
                <div class="option-btn" onclick="selectOption('field_type', 'å…¬å¯“(ç„¡é›»æ¢¯)', this)">å…¬å¯“ (ç„¡é›»æ¢¯)</div>
            </div>
        </div>

        <!-- STEP 4: æ ¼å±€ -->
        <div class="step-content" id="step4">
            <h2>ğŸ›ï¸ éœ€è¦ä»€éº¼æ ¼å±€ï¼Ÿ</h2>
            <p class="desc">å¹¾æˆ¿å¹¾å»³å‘¢ï¼Ÿ</p>
            <input type="hidden" id="field_layout" name="1000585">
            <div class="option-grid">
                <div class="option-btn" onclick="selectOption('field_layout', 'ç¨ç«‹å¥—æˆ¿', this)">ç¨ç«‹å¥—æˆ¿</div>
                <div class="option-btn" onclick="selectOption('field_layout', 'åˆ†ç§Ÿå¥—æˆ¿', this)">åˆ†ç§Ÿå¥—æˆ¿</div>
                <div class="option-btn" onclick="selectOption('field_layout', '2æˆ¿', this)">2æˆ¿</div>
                <div class="option-btn" onclick="selectOption('field_layout', '3æˆ¿', this)">3æˆ¿</div>
            </div>
        </div>

        <!-- â˜…â˜…â˜… STEP 5: å…¥ä½è³‡è¨Š (æ›´æ–°ç‚ºå‹•æ…‹æ¸…å–®) â˜…â˜…â˜… -->
        <div class="step-content" id="step5">
            <h2>ğŸ“… å…¥ä½èˆ‡æˆå“¡</h2>
            <p class="desc">è«‹å‘Šè¨´æˆ‘å€‘æ‚¨çš„å…¥ä½è¨ˆç•« (å¿…å¡«)</p>
            
            <p style="margin-bottom:10px; font-weight:bold; color:#007894;">1. é è¨ˆä»€éº¼æ™‚å€™å…¥ä½ï¼Ÿ</p>
            <!-- 1000590: é è¨ˆä»€éº¼æ™‚å¾Œå…¥ä½ -->
            <select name="1000590" id="field_movein" style="margin-bottom: 20px;">
                <option value="">è«‹é¸æ“‡...</option>
                <option value="ä¸ƒå¤©å…§">ä¸ƒå¤©å…§</option>
                <option value="ä¸€å€‹æœˆ">ä¸€å€‹æœˆ</option>
                <option value="å…©å€‹æœˆ">å…©å€‹æœˆ</option>
                <option value="ä¸‰å€‹æœˆä»¥ä¸Š">ä¸‰å€‹æœˆä»¥ä¸Š</option>
            </select>

            <p style="margin-bottom:10px; margin-top:10px; font-weight:bold; color:#007894;">2. å±…ä½æˆå“¡è³‡æ–™</p>
            
            <!-- å±…ä½é—œä¿‚é¸æ“‡ -->
            <label style="display:block; margin-bottom:5px; font-size:14px; color:#666; text-align:left;">å±…ä½é—œä¿‚</label>
            <select id="occupant_relation" style="margin-bottom: 15px; text-align-last:center;">
                <option value="">è«‹é¸æ“‡é—œä¿‚...</option>
                <option value="å€‹äººç¨å±…">å€‹äººç¨å±…</option>
                <option value="å¤«å¦»/æƒ…ä¾¶">å¤«å¦»/æƒ…ä¾¶</option>
                <option value="å®¶åº­(æœ‰å°å­©/é•·è¼©)">å®¶åº­ (æœ‰å°å­©/é•·è¼©)</option>
                <option value="æœ‹å‹/åŒäº‹åˆç§Ÿ">æœ‹å‹/åŒäº‹åˆç§Ÿ</option>
            </select>

            <!-- æ–°å¢æˆå“¡å€å¡Š -->
            <div class="add-occupant-box">
                <div class="add-row">
                    <input type="text" id="add_name" placeholder="å§“å" style="flex:2; margin-bottom:0; font-size:16px;">
                    <input type="text" id="add_age" placeholder="å¹´é½¡" style="flex:1; margin-bottom:0; font-size:16px;">
                </div>
                <input type="text" id="add_job" placeholder="è·æ¥­ (ä¾‹å¦‚: å·¥ç¨‹å¸«)" style="width:100%; margin-bottom:10px; font-size:16px;" onkeydown="if(event.key === 'Enter') { addOccupant(); return false; }">
                <button type="button" class="add-btn" onclick="addOccupant()">+ æ–°å¢å…¥ä½è€…</button>
            </div>

            <!-- æˆå“¡åˆ—è¡¨é¡¯ç¤ºå€ -->
            <div id="occupant_list_display" style="text-align:left; margin-bottom:20px;">
                <!-- é€™è£¡æœƒå‹•æ…‹æ’å…¥æˆå“¡ -->
            </div>

            <!-- å¯¦éš›é€çµ¦ Ragic çš„éš±è—æ¬„ä½ (å±…ä½äººé—œä¿‚/å¹´é½¡/è·æ¥­) -->
            <input type="hidden" name="1000587" id="field_occupants_final">
        </div>

        <!-- STEP 6: å€åŸŸèˆ‡é ç®— -->
        <div class="step-content" id="step6">
            <h2>ğŸ“ åœ°é»èˆ‡é ç®—</h2>
            <p class="desc">æ‚¨æƒ³ä½åœ¨å“ªå€‹ç¸£å¸‚ï¼Ÿ</p>
            <select name="1000638" style="margin-bottom: 20px;">
                <option value="">é¸æ“‡ç¸£å¸‚...</option>
                <option value="è‡ºåŒ—å¸‚">è‡ºåŒ—å¸‚</option>
                <option value="æ–°åŒ—å¸‚">æ–°åŒ—å¸‚</option>
                <option value="æ¡ƒåœ’å¸‚">æ¡ƒåœ’å¸‚</option>
            </select>

            <p class="desc" style="margin-top:20px;">å¤§ç´„çš„ç§Ÿé‡‘é ç®—ï¼Ÿ</p>
            <select name="1000588">
                <option value="">è«‹é¸æ“‡é ç®—...</option>
                <option value="15,000~20,000">1.5è¬ - 2è¬</option>
                <option value="20,000~25,000">2è¬ - 2.5è¬</option>
                <option value="25,000~30,000">2.5è¬ - 3è¬</option>
                <option value="30,000ä»¥ä¸Š">3è¬ä»¥ä¸Š</option>
            </select>
        </div>

         <!-- STEP 7: å®Œæˆ -->
         <div class="step-content" id="step7">
            <h2 style="font-size: 32px; margin-bottom: 5px;">ğŸ‰ æ„Ÿè¬æ‚¨ï¼</h2>
            <p class="desc">æ‚¨çš„éœ€æ±‚å·²é€å‡ºï¼Œæˆ‘å€‘å°‡ç›¡å¿«ç‚ºæ‚¨æœå‹™ã€‚</p>
            <p class="desc" style="font-size: 14px; margin-top: 20px;">æ‚¨ä¹Ÿå¯ä»¥ç›´æ¥æ’¥æ‰“ä¸‹æ–¹é›»è©±è¯ç¹«æˆ‘å€‘</p>
        </div>

    </form>

    <!-- â˜…â˜…â˜… é€™è£¡å°±æ˜¯ã€Œå…¨åŸŸã€çš„æ¥­å‹™åç‰‡ï¼Œæ¯ä¸€é éƒ½çœ‹å¾—åˆ° â˜…â˜…â˜… -->
    <div class="agent-card-wrapper">
        <div class="agent-card">
            <div class="agent-info">
                <!-- â˜…â˜…â˜… ä¿®æ”¹ï¼šä½ç½®äº¤æ›ï¼Œä¸¦æ›´æ–°å…¬å¸åç¨± â˜…â˜…â˜… -->
                <div class="agent-company">å„ªå¼ç§Ÿå”®ç®¡ç† - çª©çš„å®¶ä¸‰é‡åŠ ç›Ÿåº—</div>
                <div class="agent-label">æ‚¨çš„å°ˆå±¬ç§Ÿå±‹é¡§å•</div>
                <div class="agent-name" id="display_agent_name">å¼µç“Šå®‰</div>
            </div>
            <a href="#" id="display_agent_call" class="agent-call-btn">
                ğŸ“ <span id="display_agent_phone_text">é€šè©±</span>
            </a>
        </div>
    </div>

    <!-- åº•éƒ¨æŒ‰éˆ•å€ -->
    <div class="footer-btns">
        <button class="btn-prev" id="prevBtn" onclick="prevStep()">ä¸Šä¸€æ­¥</button>
        <!-- ç³»çµ±æ¸¬è©¦æŒ‰éˆ• -->
        <button class="btn-test" onclick="testConnection()">ğŸ› ï¸ æ¸¬è©¦</button>
        <button class="btn-next" id="nextBtn" onclick="nextStep()">ä¸‹ä¸€æ­¥</button>
    </div>
</div>

<script>
    // --- æ ¸å¿ƒé‚è¼¯ï¼šé è¨­æ¥­å‹™è³‡æ–™ (å·²æ›´æ–°ç‚ºå¼µç“Šå®‰) ---
    let defaultAgentName = "å¼µç“Šå®‰"; 
    let defaultAgentPhone = "0981-615-303"; 

    const urlParams = new URLSearchParams(window.location.search);
    const agentName = urlParams.get('agent') || defaultAgentName;
    const agentPhone = urlParams.get('phone') || defaultAgentPhone;

    // Ragic API URL
    const ragicApiUrl = "https://ap15.ragic.com/wuohome/property-data-kept/8?api=true&APIKey=Nm5QVzFtZ1pGYzZIT1REUnBhY3A0bDVKY0luaEh3d2lrSmMzTHNSVjh3N1VHc1JadWJjQk9yZDQ3UlpZZnFubQ==";

    // â˜…â˜…â˜… å±…ä½æˆå“¡è³‡æ–™è™•ç†é‚è¼¯ â˜…â˜…â˜…
    let occupantList = [];

    function addOccupant() {
        const name = document.getElementById('add_name').value.trim();
        const age = document.getElementById('add_age').value.trim();
        const job = document.getElementById('add_job').value.trim();

        if (!name) {
            alert("è«‹è‡³å°‘å¡«å¯«å§“åå–”ï¼");
            return;
        }

        // åŠ å…¥é™£åˆ—
        occupantList.push({ name, age, job });

        // æ¸…ç©ºè¼¸å…¥æ¡†
        document.getElementById('add_name').value = '';
        document.getElementById('add_age').value = '';
        document.getElementById('add_job').value = '';
        
        // èšç„¦å›å§“åï¼Œæ–¹ä¾¿é€£çºŒè¼¸å…¥
        document.getElementById('add_name').focus();

        renderOccupantList();
    }

    function removeOccupant(index) {
        occupantList.splice(index, 1);
        renderOccupantList();
    }

    function renderOccupantList() {
        const displayDiv = document.getElementById('occupant_list_display');
        displayDiv.innerHTML = '';

        occupantList.forEach((person, index) => {
            const row = document.createElement('div');
            row.className = 'occupant-entry';
            
            // çµ„åˆé¡¯ç¤ºæ–‡å­—ï¼š 1. å¼µç“Šå®‰ / 32æ­² / æˆ¿åœ°ç”¢ç‰¹åŠ©
            let text = `${index + 1}. ${person.name}`;
            if (person.age) text += ` / ${person.age}æ­²`;
            if (person.job) text += ` / ${person.job}`;

            row.innerHTML = `
                <span>${text}</span>
                <span class="delete-btn" onclick="removeOccupant(${index})">åˆªé™¤</span>
            `;
            displayDiv.appendChild(row);
        });

        updateHiddenField();
    }

    function updateHiddenField() {
        // å°‡è³‡æ–™çµ„åˆæˆ Ragic éœ€è¦çš„å­—ä¸²æ ¼å¼
        const relation = document.getElementById('occupant_relation').value;
        let finalString = "";
        
        if (relation) {
            // â˜…â˜…â˜… è‡ªå‹•è¨ˆç®—äººæ•¸ä¸¦é¡¯ç¤ºåœ¨æ‹¬è™Ÿå…§ â˜…â˜…â˜…
            const count = occupantList.length;
            finalString += `å±…ä½é—œä¿‚ï¼š${relation}`;
            if (count > 0) {
                finalString += `ï¼ˆå…±${count}äººï¼‰`;
            }
            finalString += `\n\n`;
        }

        occupantList.forEach((person, index) => {
            let text = `${index + 1}. ${person.name}`;
            if (person.age) text += ` / ${person.age}æ­²`;
            if (person.job) text += ` / ${person.job}`;
            finalString += text + "\n";
        });

        document.getElementById('field_occupants_final').value = finalString;
    }
    
    // ç•¶ã€Œå±…ä½é—œä¿‚ã€æ”¹è®Šæ™‚ä¹Ÿè¦æ›´æ–°éš±è—æ¬„ä½
    document.getElementById('occupant_relation').addEventListener('change', updateHiddenField);


    function initAgentInfo() {
        document.getElementById('display_agent_name').innerText = agentName;
        document.getElementById('display_agent_call').href = 'tel:' + agentPhone;
        document.getElementById('display_agent_phone_text').innerText = 'æ’¥æ‰“é›»è©±'; 
        
        document.getElementById('input_agent_name').value = agentName;
        document.getElementById('input_agent_phone').value = agentPhone;
    }

    let currentStep = 1;
    const totalSteps = 7;

    function updateUI() {
        for(let i=1; i<=totalSteps; i++) {
            document.getElementById('step'+i).classList.remove('active');
        }
        document.getElementById('step'+currentStep).classList.add('active');
        document.getElementById('progress').style.width = ((currentStep / totalSteps) * 100) + '%';

        // æŒ‰éˆ•é‚è¼¯
        if(currentStep === 1) {
            document.getElementById('prevBtn').style.visibility = 'hidden';
        } else {
            document.getElementById('prevBtn').style.visibility = 'visible';
        }

        if(currentStep === totalSteps) {
             document.querySelector('.footer-btns').style.display = 'none';
        } else if (currentStep === totalSteps - 1) { 
            document.getElementById('nextBtn').innerText = 'ç¢ºèªé€å‡º';
            document.getElementById('nextBtn').style.backgroundColor = '#e74c3c'; 
            document.querySelector('.footer-btns').style.display = 'flex'; 
        } else {
            document.getElementById('nextBtn').innerText = 'ä¸‹ä¸€æ­¥';
            document.getElementById('nextBtn').style.backgroundColor = '#007894';
            document.querySelector('.footer-btns').style.display = 'flex'; 
        }
    }

    function nextStep() {
        // Step 5 ç‰¹æ®Šæª¢æŸ¥
        if (currentStep === 5) {
            const relation = document.getElementById('occupant_relation').value;
            // æª¢æŸ¥æ˜¯å¦é¸äº†é—œä¿‚
            if (!relation) {
                alert('è«‹é¸æ“‡ã€Œå±…ä½é—œä¿‚ã€å–”ï¼');
                return;
            }
            // æª¢æŸ¥æ˜¯å¦è‡³å°‘æ–°å¢äº†ä¸€ä½æˆå“¡
            if (occupantList.length === 0) {
                alert('è«‹è‡³å°‘æ–°å¢ä¸€ä½å±…ä½æˆå“¡ï¼\n(å¡«å¯«å®Œå§“åå¾Œï¼Œè«‹æŒ‰ä¸‹ã€Œ+ æ–°å¢å…¥ä½è€…ã€æŒ‰éˆ•)');
                return;
            }
            updateHiddenField(); // ç¢ºä¿éš±è—æ¬„ä½æ˜¯æœ€æ–°çš„
        }

        if(currentStep < totalSteps - 1) { 
            currentStep++;
            updateUI();
        } else if (currentStep === totalSteps - 1) { 
            submitForm();
        }
    }

    function prevStep() {
        if(currentStep > 1) {
            currentStep--;
            updateUI();
        }
    }

    function selectOption(inputId, value, element) {
        document.getElementById(inputId).value = value;
        let parent = element.parentElement;
        let siblings = parent.getElementsByClassName('option-btn');
        for(let btn of siblings) {
            btn.classList.remove('selected');
        }
        element.classList.add('selected');
        setTimeout(() => {
            nextStep();
        }, 300);
    }

    function testConnection() {
        const testData = new FormData();
        testData.append('1000581', 'ç³»çµ±æ¸¬è©¦(è«‹å¿½ç•¥)');
        testData.append('1000583', '0900-000-000');
        testData.append('1000640', agentName);
        
        testData.append('1000584', 'é›»æ¢¯'); 
        testData.append('1000585', 'å¥—æˆ¿'); 
        testData.append('1000590', 'ä¸€å€‹æœˆ'); 
        // æ¸¬è©¦è³‡æ–™ä¹Ÿè¦ç¬¦åˆæ–°æ ¼å¼
        testData.append('1000587', 'å±…ä½é—œä¿‚ï¼šæ¸¬è©¦ä¸­\n1. æ¸¬è©¦å“¡ / 99æ­² / æ©Ÿå™¨äºº'); 
        
        alert('æ­£åœ¨å˜—è©¦ç™¼é€æ¸¬è©¦è³‡æ–™åˆ° Ragic...');

        fetch(ragicApiUrl, {
            method: 'POST',
            body: testData
        })
        .then(response => {
            if (response.ok) {
                alert('âœ… æ¸¬è©¦æˆåŠŸï¼Ragic ä¼ºæœå™¨å›å‚³ OK (200)ã€‚');
            } else {
                alert('âŒ ç™¼é€å¤±æ•—ï¼éŒ¯èª¤ä»£ç¢¼: ' + response.status);
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            alert('âš ï¸ é€£ç·šéŒ¯èª¤ (CORS) - ä¸éåˆ¥æ“”å¿ƒï¼Œæ­£å¼é€å‡ºæœƒç”¨å¦ä¸€ç¨®æ–¹å¼ç¹éã€‚');
        });
    }

    function submitForm() {
        const name = document.getElementById('field_name').value;
        const phone = document.getElementById('field_phone').value;
        const moveIn = document.getElementById('field_movein').value;
        
        if(!name) {
            alert('è«‹å¡«å¯«å§“åå–”ï¼');
            currentStep = 1;
            updateUI();
            return;
        }
        
        if(!phone) {
            alert('è«‹å¡«å¯«é›»è©±å–”ï¼');
            currentStep = 2;
            updateUI();
            return;
        }

        if(!moveIn) {
            alert('è«‹é¸æ“‡é è¨ˆå…¥ä½æ™‚é–“å–”ï¼');
            currentStep = 5;
            updateUI();
            return;
        }
        // æˆå“¡æª¢æŸ¥åœ¨ nextStep() å·²ç¶“åšéäº†ï¼Œä½†ç‚ºäº†ä¿éšªèµ·è¦‹ï¼ˆä¾‹å¦‚ç›´æ¥æŒ‰é€å‡ºï¼‰ï¼Œé€™è£¡å¯ä»¥å†æª¢æŸ¥ä¸€æ¬¡
        if (occupantList.length === 0) {
            alert('è«‹ç¢ºèªå±…ä½æˆå“¡è³‡æ–™æ˜¯å¦å·²æ–°å¢ï¼');
            currentStep = 5;
            updateUI();
            return;
        }

        document.getElementById('loadingOverlay').style.display = 'flex';

        const timestamp = new Date().getTime();
        document.getElementById('input_source_mark').value = 'wizard_v1_' + timestamp;

        // ç¢ºä¿é€å‡ºå‰éš±è—æ¬„ä½æœ‰å€¼
        updateHiddenField();

        const form = document.getElementById('ragicForm');
        form.submit();

        setTimeout(() => {
            document.getElementById('loadingOverlay').style.display = 'none';
            currentStep = totalSteps; 
            updateUI();
        }, 1500);
    }

    initAgentInfo(); 
    updateUI();
</script>

</body>
</html>
